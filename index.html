<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>俺らの電工 - GOD CONNECTION</title>
<style>
:root { --neon: #ffd000; --red: #ff3333; --panel: #e0e0e0; --bg: #000; }
html, body { height: 100%; margin: 0; background: var(--bg); color: #fff; font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; touch-action: none; }

/* --- 輝くタイトル画面 (IMG_2184再現) --- */
#titleScreen { position: fixed; inset: 0; background: #000; z-index: 30000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.title-logo { font-size: 48px; font-weight: 900; color: var(--neon); text-shadow: 0 0 10px var(--neon), 0 0 30px var(--neon), 0 0 50px #ffaa00; margin: 0; }
.subtitle { letter-spacing: 8px; font-size: 14px; margin-top: 10px; opacity: 0.8; }
.start-btn { margin-top: 50px; padding: 18px 60px; font-size: 22px; font-weight: bold; background: var(--neon); color: #000; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px var(--neon); animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 20px var(--neon); } 50% { transform: scale(1.05); box-shadow: 0 0 40px var(--neon); } 100% { transform: scale(1); box-shadow: 0 0 20px var(--neon); } }

/* --- HPバー (IMG_2172再現) --- */
.hp-container { position: fixed; top: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 15000; }
.hp-box { width: 40%; }
.hp-label { font-size: 12px; margin-bottom: 4px; display: flex; justify-content: space-between; }
.hp-bar-bg { height: 12px; background: #333; border-radius: 6px; overflow: hidden; border: 1px solid #555; }
.hp-bar-fill { height: 100%; width: 100%; transition: 0.5s; }
#playerHPBar { background: linear-gradient(90deg, #00f2fe, #4facfe); }
#bossHPBar { background: linear-gradient(90deg, #f09, #f00); }

/* --- 配線レイヤー --- */
#wireLayer { position: fixed; inset: 0; pointer-events: none; z-index: 5000; }
.wire-path { fill: none; stroke-linecap: round; stroke-linejoin: round; transition: 0.3s; }
.wire-black { stroke: #111; stroke-width: 8; }
.wire-white { stroke: #eee; stroke-width: 8; }
.wire-glow { stroke: var(--neon); stroke-width: 4; stroke-dasharray: 10, 30; animation: flow 0.5s linear infinite; display: none; }
@keyframes flow { from { stroke-dashoffset: 40; } to { stroke-dashoffset: 0; } }

/* --- デバイス (IMG_2186再現) --- */
.device { position: absolute; width: 85px; background: var(--panel); border-radius: 8px; color: #000; transform: translate(-50%, -50%); text-align: center; z-index: 1000; padding: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.device h3 { margin: 0 0 5px; font-size: 11px; border-bottom: 1px solid #bbb; }
.icon-brk { width: 30px; height: 35px; background: #333; margin: 0 auto 5px; position: relative; border: 2px solid #000; }
.icon-brk::after { content: 'ON'; background: red; color: #fff; font-size: 8px; position: absolute; top: 2px; left: 2px; padding: 1px 2px; }
.icon-lp { width: 32px; height: 32px; border: 2px solid #555; border-radius: 50%; margin: 5px auto; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; color: #444; }
.icon-sw { width: 28px; height: 28px; background: #fff; border: 1px solid #999; margin: 5px auto; box-shadow: inset 0 0 4px #ccc; }

.t-row { display: flex; justify-content: space-around; margin-top: 5px; }
.term { width: 24px; height: 24px; background: #222; color: #fff; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.sel { outline: 3px solid var(--neon); box-shadow: 0 0 15px var(--neon); transform: scale(1.2); }

/* --- クイズ・ボス画面 --- */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: none; align-items: center; justify-content: center; flex-direction: column; }
.card { width: 85%; max-width: 340px; background: #1a1a1a; padding: 25px; border-radius: 15px; border: 1px solid #444; text-align: center; }
.ans-btn { display:block; width:100%; margin:10px 0; padding:15px; background:#333; color:#fff; border:1px solid #555; border-radius:10px; font-size: 15px; }

.controls { position: fixed; bottom: 0; width: 100%; padding: 20px 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; z-index: 10000; }
#setBtn { padding: 15px 80px; background: var(--neon); color: #000; border: none; border-radius: 40px; font-weight: bold; font-size: 20px; }
</style>
</head>
<body>

<div id="titleScreen">
    <div class="title-logo">俺らの電工</div>
    <div class="subtitle">GOD CONNECTION</div>
    <button class="start-btn" onclick="gameStart()">現場入り</button>
</div>

<div class="hp-container" id="hpUI" style="display:none;">
    <div class="hp-box">
        <div class="hp-label"><span>PLAYER</span><span id="pHPText">100</span></div>
        <div class="hp-bar-bg"><div id="playerHPBar" class="hp-bar-fill"></div></div>
    </div>
    <div class="hp-box">
        <div class="hp-label"><span>BOSS</span><span id="bHPText">100</span></div>
        <div class="hp-bar-bg"><div id="bossHPBar" class="hp-bar-fill"></div></div>
    </div>
</div>

<svg id="wireLayer"></svg>

<div id="quizScreen" class="modal">
    <div class="card">
        <h2 style="color:var(--neon); margin:0;">学科試験</h2>
        <p id="qCount" style="color:#888;"></p>
        <h3 id="qText" style="margin:20px 0; font-size:18px;"></h3>
        <div id="ansBox"></div>
    </div>
</div>

<div id="board" style="position:relative; width:100%; height:100%; display:none;"></div>

<div class="controls" id="ui">
    <div style="margin-bottom:15px; display:flex; gap:10px;">
        <button id="swToggle" onclick="toggleSW()" style="padding:10px 20px; background:#444; color:#fff; border:none; border-radius:5px;">スイッチ: OFF</button>
        <button onclick="resetWires()" style="padding:10px 20px; background:#444; color:#fff; border:none; border-radius:5px;">リセット</button>
    </div>
    <button id="setBtn" onclick="checkCircuit()">SET (通電開始)</button>
</div>

<script>
const quizzes = [
    {q:"接地側（白線）を繋ぐべき端子記号は？", a:["L","W (N)","E","S"], c:1},
    {q:"電圧側（黒線）の色は？", a:["白","黒","緑","赤"], c:1},
    {q:"スイッチの役割は？", a:["電圧を上げる","回路を遮断・接続する","電気を貯める"], c:1},
    {q:"照明器具の『×』印は何を指す？", a:["故障","照明（負荷）","通行止め"], c:1},
    {q:"絶縁抵抗計の単位は？", a:["Ω","MΩ","V","A"], c:1}
];

let pHP = 100, bHP = 100, qIdx = 0, lines = [], selTerm = null, swOn = false;

function gameStart() {
    document.getElementById('titleScreen').style.display = 'none';
    document.getElementById('hpUI').style.display = 'flex';
    nextQuiz();
}

function nextQuiz() {
    if(qIdx >= quizzes.length) {
        document.getElementById('quizScreen').style.display = 'none';
        initBoard();
        return;
    }
    const q = quizzes[qIdx];
    document.getElementById('quizScreen').style.display = 'flex';
    document.getElementById('qCount').innerText = `第 ${qIdx+1} / 5 問`;
    document.getElementById('qText').innerText = q.q;
    const box = document.getElementById('ansBox'); box.innerHTML = '';
    q.a.forEach((txt, i) => {
        const btn = document.createElement('button');
        btn.className = 'ans-btn';
        btn.innerText = txt;
        btn.onclick = () => {
            if(i === q.c) { qIdx++; nextQuiz(); }
            else { damagePlayer(20); alert("不正解！ダメージ！"); }
        };
        box.appendChild(btn);
    });
}

function initBoard() {
    const b = document.getElementById('board'); b.style.display = 'block';
    document.getElementById('ui').style.display = 'flex';
    b.innerHTML = '';
    addD('p', '電源', 50, 20, [['p-L','L'],['p-N','N']], 'brk');
    addD('jb', 'Joint Box', 50, 45, [['j1',''],['j2',''],['j3',''],['j4','']], 'jb');
    addD('sw', 'スイッチ', 30, 75, [['s-i','IN'],['s-o','OUT']], 'sw');
    addD('lp', '照明', 70, 75, [['l-L','L'],['l-N','N']], 'lp');
    
    // 描画準備
    window.addEventListener('resize', drawWires);
}

function addD(id, name, x, y, ts, type) {
    const d = document.createElement('div');
    d.className = 'device'; d.style.left = x+'%'; d.style.top = y+'%';
    let icon = `<div class="icon-${type}">${type==='lp'?'×':''}</div>`;
    let html = `<h3>${name}</h3>${icon}<div class="t-row">`;
    ts.forEach(t => html += `<div class="term" data-id="${t[0]}" onclick="termClick(this)">${t[1]}</div>`);
    d.innerHTML = html + `</div>`;
    document.getElementById('board').appendChild(d);
}

function termClick(el) {
    if(!selTerm) { selTerm = el; el.classList.add('sel'); }
    else {
        if(selTerm !== el) {
            lines.push([selTerm.dataset.id, el.dataset.id]);
            drawWires();
        }
        selTerm.classList.remove('sel'); selTerm = null;
    }
}

function drawWires() {
    const svg = document.getElementById('wireLayer'); svg.innerHTML = '';
    lines.forEach(pair => {
        const t1 = document.querySelector(`[data-id="${pair[0]}"]`);
        const t2 = document.querySelector(`[data-id="${pair[1]}"]`);
        const r1 = t1.getBoundingClientRect(); const r2 = t2.getBoundingClientRect();
        const x1 = r1.left + 12; const y1 = r1.top + 12;
        const x2 = r2.left + 12; const y2 = r2.top + 12;

        const isL = pair[0].match(/L|i|o/) || pair[1].match(/L|i|o/);
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const d = `M ${x1} ${y1} Q ${(x1+x2)/2} ${(y1+y2)/2 - 20} ${x2} ${y2}`;
        path.setAttribute("d", d);
        path.setAttribute("class", `wire-path ${isL ? 'wire-black' : 'wire-white'}`);
        svg.appendChild(path);

        const glow = path.cloneNode();
        glow.setAttribute("class", "wire-path wire-glow");
        svg.appendChild(glow);
    });
}

function checkCircuit() {
    if(!swOn) { alert("スイッチが入っていないぞ！"); return; }
    // 簡易回路判定 (LからNへ繋がっているか)
    const adj = {};
    lines.forEach(l => {
        if(!adj[l[0]]) adj[l[0]] = []; if(!adj[l[1]]) adj[l[1]] = [];
        adj[l[0]].push(l[1]); adj[l[1]].push(l[0]);
    });

    const visit = new Set();
    function dfs(c) {
        if(c === 'p-N') return true;
        visit.add(c);
        for(let n of (adj[c]||[])) { if(!visit.has(n) && dfs(n)) return true; }
        return false;
    }

    if(dfs('p-L')) {
        document.querySelectorAll('.wire-glow').forEach(el => el.style.display = 'block');
        setTimeout(() => {
            alert("通電成功！ボスに大ダメージ！");
            damageBoss(50);
        }, 1000);
    } else {
        alert("回路が不完全だ。ショートか断線している！");
        damagePlayer(10);
    }
}

function damagePlayer(amt) {
    pHP -= amt; if(pHP <= 0) { alert("現場追放...（ゲームオーバー）"); location.reload(); }
    document.getElementById('playerHPBar').style.width = pHP + '%';
    document.getElementById('pHPText').innerText = pHP;
}

function damageBoss(amt) {
    bHP -= amt; if(bHP <= 0) { alert("神通電完了！ボス撃破！"); location.reload(); }
    document.getElementById('bossHPBar').style.width = bHP + '%';
    document.getElementById('bHPText').innerText = bHP;
}

function toggleSW() {
    swOn = !swOn;
    const btn = document.getElementById('swToggle');
    btn.innerText = `スイッチ: ${swOn ? 'ON' : 'OFF'}`;
    btn.style.background = swOn ? var(--neon) : '#444';
}

function resetWires() { lines = []; drawWires(); }
</script>
</body>
</html>
