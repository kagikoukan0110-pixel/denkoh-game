<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>俺らの電工 - 究極確定版</title>
<style>
:root {
  --bg: #000;
  --panel: #dcdcdc;
  --gold: linear-gradient(to bottom, #fff700 0%, #ffcc00 50%, #b8860b 100%);
}

html, body { height: 100%; margin: 0; background: var(--bg); color: #fff; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; overflow: hidden; touch-action: none; }

/* 配線レイヤーを最前面（UIの下、デバイスの上）に設定 */
#wireLayer { position: fixed; inset: 0; pointer-events: none; z-index: 2000; }

/* デバイス描画用CSS */
.icon-breaker { width: 30px; height: 40px; background: #333; margin: 0 auto 5px; border-radius: 3px; position: relative; border: 2px solid #555; }
.icon-breaker::after { content: 'ON'; color: #fff; font-size: 8px; position: absolute; top: 5px; left: 5px; background: #f00; padding: 1px 2px; border-radius: 1px; }

.icon-switch { width: 30px; height: 30px; background: #eee; border: 1px solid #999; border-radius: 4px; margin: 0 auto 5px; position: relative; }
.icon-switch::before { content: ''; position: absolute; inset: 5px; border: 1px solid #ccc; border-radius: 2px; background: #fff; }

.icon-lamp { width: 34px; height: 34px; border: 2px solid #555; border-radius: 50%; margin: 0 auto 5px; background: radial-gradient(circle, #fff 0%, #aaa 100%); position: relative; }
.icon-lamp::after { content: '×'; color: #333; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; }

/* 演出系 */
@keyframes god-freeze { 0% { opacity: 1; filter: brightness(3) invert(0); } 50% { opacity: 0.1; filter: brightness(8) invert(1); } 100% { opacity: 1; filter: brightness(3) invert(0); } }
.freeze-effect { animation: god-freeze 0.04s infinite !important; }

#puchun { position: fixed; inset: 0; background: #fff; opacity: 0; z-index: 12000; pointer-events: none; }
.puchun-active { animation: puchun-flash 0.4s ease-out; }
@keyframes puchun-flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

/* 撃破演出：ゆっくりフェードイン */
#victoryScreen { display: none; position: fixed; inset: 0; background: #000; z-index: 11000; align-items: center; justify-content: center; }
.gold-text {
    font-size: 100px; font-weight: bold; background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 30px rgba(255,215,0,0.8));
    opacity: 0; transform: scale(0.8);
    animation: godSlowIn 2.5s ease-out forwards;
}
@keyframes godSlowIn { 
    0% { opacity: 0; transform: scale(0.5); } 
    40% { opacity: 1; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); } 
}

/* ダメージ演出 */
#damageOverlay { display: none; position: fixed; inset: 0; background: rgba(255,0,0,0.4); z-index: 10000; align-items: center; justify-content: center; font-size: 60px; font-weight: bold; color: #fff; text-shadow: 0 0 20px #000; }
.shake { animation: shake 0.2s infinite; }
@keyframes shake { 0% { transform: translate(5px, 5px); } 50% { transform: translate(-5px, -5px); } 100% { transform: translate(0, 0); } }

/* デバイス本体：配線の下に配置 */
.device { position: absolute; width: 70px; min-height: 80px; padding: 5px; background: var(--panel); border-radius: 8px; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transform: translate(-50%, -50%); text-align: center; z-index: 1000; }
.device h3 { margin: 0 0 5px; font-size: 9px; white-space: nowrap; border-bottom: 1px solid #bbb; }
.terminal { display: inline-flex; justify-content: center; align-items: center; width: 22px; height: 22px; margin: 2px; background: #222; color: #fff; border-radius: 50%; font-size: 9px; cursor: pointer; position: relative; z-index: 1001; }
.selected { outline: 3px solid #ffd800; }

/* 配線描画 */
.wire-path { fill: none; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; }
.wire-black { stroke: #111; filter: drop-shadow(0 0 1px #fff); }
.wire-white { stroke: #fff; filter: drop-shadow(0 0 1px #000); }

/* UI */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.96); display: none; align-items: center; justify-content: center; z-index: 9000; }
.modal-backdrop.show { display: flex; flex-direction: column; }
.card { width: 80%; max-width: 320px; background: #111; padding: 20px; border-radius: 12px; border: 1px solid #333; text-align: center; }
.ans-btn { display:block; width:100%; margin:8px 0; padding:10px; background:#222; color:#fff; border:1px solid #444; border-radius:6px; font-size:13px; }
.controls { position: fixed; bottom: 0; width: 100%; height: 90px; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; gap: 5px; z-index: 4000; }
.main-btn { padding: 10px 40px; background: #ffd000; color: #000; border: none; border-radius: 20px; font-weight: bold; font-size: 18px; }
</style>
</head>
<body>

<svg id="wireLayer"></svg>
<div id="damageOverlay">DAMAGE!</div>
<div id="puchun"></div>
<div id="victoryScreen"><div class="gold-text">撃破</div></div>

<div id="quizScreen" class="modal-backdrop show">
  <div class="card">
    <div id="qCount" style="font-size: 11px; color: #777;"></div>
    <h3 id="qText" style="margin: 15px 0; font-size: 14px;"></h3>
    <div id="answers"></div>
    <div style="margin-top: 15px; background: #222; height: 6px; border-radius: 3px; overflow: hidden;">
        <div id="hpBar" style="width: 100%; height: 100%; background: #28a745; transition: 0.3s;"></div>
    </div>
  </div>
</div>

<div id="bossScreen" class="modal-backdrop">
  <div class="card">
    <h4 style="color:#ff4444; margin:0 0 8px 0;">TARGET: 汚ねえ大工</h4>
    <img src="boss.png.jpg" style="width:100%; border-radius:6px; border:1px solid #ff4444;" onerror="this.src='https://placehold.jp/300x200?text=BOSS'">
    <div style="height:15px; background:#000; border:1px solid #333; border-radius:8px; margin-top:10px; overflow:hidden;">
      <div id="bossHP" style="height:100%; width:100%; background:linear-gradient(90deg, #f00, #800); transition: width 0.4s;"></div>
    </div>
  </div>
</div>

<div id="board" style="position:relative; width:100%; height:calc(100vh - 90px); display:none;"></div>

<div class="controls" id="gameControls">
  <div style="display:flex; gap:8px;">
    <button id="swBtn" style="background:#333; color:#fff; border:none; padding:4px 12px; border-radius:4px; font-size:11px;">SWITCH: OFF</button>
    <button onclick="resetWires()" style="background:#333; color:#fff; border:none; padding:4px 12px; border-radius:4px; font-size:11px;">RESET</button>
  </div>
  <button id="setBtn" class="main-btn">SET (通電確認)</button>
</div>

<script>
const pool = [
    {q:"電線で、触ると感電する（電圧がある）のは？", a:["白線","黒線","アース線","ひも"], c:1},
    {q:"コンセントの左側の長い穴の役割は？", a:["予備","接地（アース）側","放熱","デザイン"], c:1},
    {q:"電気工事士の免許がない人がやっていいのは？", a:["コンセントの交換","電球の交換","配線作業","スイッチ修理"], c:1},
    {q:"リングスリーブをガチャンと潰す道具は？", a:["ペンチ","圧着工具","ニッパー","ハンマー"], c:1},
    {q:"電線を剥く時に使う『ガチャン』とやる便利な道具は？", a:["カッター","VVFストリッパー","ハサミ","爪"], c:1},
    {q:"ブレーカーが落ちるのは、電気をどうした時？", a:["節約した時","使いすぎた時","夜になった時","暑い時"], c:1},
    {q:"アース線の色として一般的なのは？", a:["赤","緑","青","黒"], c:1},
    {q:"VVFケーブルの「V」は何を指す？", a:["電圧","ビニル","バニラ","垂直"], c:1},
    {q:"電気工事で最も優先すべきことは？", a:["スピード","安全（感電防止）","安さ","見た目"], c:1},
    {q:"電気が来ているか調べるペン型の道具は？", a:["万年筆","検電器","温度計","磁石"], c:1}
    // ... (同様に20問まで追加可能)
];

let currentQ = [], qIdx = 0, hp = 100, bHP = 100, round = 1, swOn = false, sel = null, lines = [];

function init() {
    currentQ = pool.sort(() => Math.random() - 0.5).slice(0, 5);
    renderQ();
}

function renderQ() {
    if(qIdx >= 5) {
        document.getElementById('quizScreen').classList.remove('show');
        document.getElementById('board').style.display = 'block';
        document.getElementById('gameControls').style.display = 'flex';
        setupRound(); return;
    }
    const q = currentQ[qIdx];
    document.getElementById('qCount').textContent = `QUESTION ${qIdx+1} / 5`;
    document.getElementById('qText').textContent = q.q;
    const ans = document.getElementById('answers'); ans.innerHTML = '';
    q.a.forEach((t, i) => {
        const b = document.createElement('button');
        b.className = 'ans-btn';
        b.textContent = t;
        b.onclick = () => {
            const ok = i === q.c;
            if(!ok) { hp -= 20; document.getElementById('hpBar').style.width = hp + "%"; }
            qIdx++; renderQ();
        };
        ans.appendChild(b);
    });
}

function setupRound() {
    const b = document.getElementById('board'); b.innerHTML = '';
    lines = []; document.getElementById('wireLayer').innerHTML = '';
    
    // 配置（画面外に出ないよう中心寄り）
    const pos = {
        p: {x:25, y:20}, jb: {x:52, y:45}, sw: {x:25, y:75},
        l1: {x:75, y:20}, l2: {x:75, y:45}, l3: {x:75, y:70}
    };

    addD('p', '電源', pos.p, `<div class="icon-breaker"></div><div class="terminal" data-id="p-L">L</div><div class="terminal" data-id="p-N">N</div>`);
    addD('jb', 'Joint Box', pos.jb, Array.from({length:6},(_,i)=>`<div class="terminal" data-id="jb-${i}"></div>`).join(''));
    addD('sw', 'スイッチ', pos.sw, `<div class="icon-switch"></div><div class="terminal" data-id="sw-i">IN</div><div class="terminal" data-id="sw-o">OUT</div>`);
    for(let i=1; i<=round; i++) addD(`l${i}`, `照明-${i}`, pos[`l${i}`], `<div class="icon-lamp"></div><div class="terminal" data-id="l${i}-L">L</div><div class="terminal" data-id="l${i}-N">N</div>`);

    document.querySelectorAll('.terminal').forEach(t => t.onclick = clickT);
}

function addD(id, n, p, h) {
    const d = document.createElement('div'); d.className = 'device'; d.id = id;
    d.style.left = p.x + "%"; d.style.top = p.y + "%"; d.innerHTML = `<h3>${n}</h3>` + h;
    document.getElementById('board').appendChild(d);
}

function clickT(e) {
    const t = e.target;
    if(!sel) { sel = t; t.classList.add('selected'); return; }
    if(sel === t) { sel.classList.remove('selected'); sel = null; return; }
    lines.push([sel.dataset.id, t.dataset.id]);
    sel.classList.remove('selected'); sel = null;
    draw();
}

// 90度配線描画ロジック
function draw() {
    const s = document.getElementById('wireLayer'); s.innerHTML = '';
    lines.forEach(c => {
        const aRect = document.querySelector(`[data-id="${c[0]}"]`).getBoundingClientRect();
        const bRect = document.querySelector(`[data-id="${c[1]}"]`).getBoundingClientRect();
        
        const x1 = aRect.left + aRect.width/2;
        const y1 = aRect.top + aRect.height/2;
        const x2 = bRect.left + bRect.width/2;
        const y2 = bRect.top + bRect.height/2;

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        // 中継点（xは1点目、yは2点目にすることでカギ型にする）
        const d = `M ${x1} ${y1} L ${x2} ${y1} L ${x2} ${y2}`;
        path.setAttribute("d", d);
        const isL = c[0].match(/L|i|o/) || c[1].match(/L|i|o/);
        path.setAttribute("class", `wire-path ${isL ? 'wire-black' : 'wire-white'}`);
        s.appendChild(path);
    });
}

document.getElementById('setBtn').onclick = () => {
    if(!swOn) { alert("スイッチがOFFだ！"); return; }
    
    // ダメージ演出
    const overlay = document.getElementById('damageOverlay');
    overlay.style.display = 'flex';
    document.body.classList.add('shake');
    bHP -= 34; document.getElementById('bossHP').style.width = Math.max(0, bHP) + "%";

    setTimeout(() => {
        overlay.style.display = 'none';
        document.body.classList.remove('shake');
        document.getElementById('bossScreen').classList.add('show');
        
        setTimeout(() => {
            if(bHP <= 0) { triggerGodFreeze(); } 
            else { document.getElementById('bossScreen').classList.remove('show'); round++; setupRound(); }
        }, 1200);
    }, 500);
};

function triggerGodFreeze() {
    new Audio('freeze.mp3').play().catch(()=>{});
    document.body.classList.add('freeze-effect');
    
    setTimeout(() => {
        const p = document.getElementById('puchun');
        p.classList.add('puchun-active');
        
        setTimeout(() => {
            document.body.classList.remove('freeze-effect');
            // 暗転
            document.querySelectorAll('body > *:not(#puchun):not(#victoryScreen)').forEach(el => el.style.display = 'none');
            document.body.style.background = "#000";
            
            setTimeout(() => {
                document.getElementById('victoryScreen').style.display = 'flex';
            }, 1500); 
        }, 200);
    }, 2800);
}

document.getElementById('swBtn').onclick = (e) => {
    swOn = !swOn;
    e.target.textContent = `SWITCH: ${swOn ? 'ON' : 'OFF'}`;
    e.target.style.background = swOn ? '#ffd000' : '#333';
    e.target.style.color = swOn ? '#000' : '#fff';
};

function resetWires() { lines = []; draw(); }
window.onload = init;
</script>
</body>
</html>
