<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ä¿ºã‚‰ã®é›»å·¥ Î² - Fixed Layout</title>
<style>
:root{
  --bg:#000;
  --panel:#e6e6e6;
  --term-bg:#222;
  --wire-black:#1a1a1a;
  --wire-white:#ffffff;
  --wire-outline:rgba(255,255,255,0.4);
  --device-w:100px;
  --device-h:130px;
  --lamp-glow: rgba(255,220,80,0.95);
}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:sans-serif;overflow:hidden; touch-action: none;}
#wireLayer{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:3000}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;height:60px;box-sizing:border-box;}
.title{font-size:20px;font-weight:700}
.bar{width:180px;height:12px;background:#222;border-radius:12px;overflow:hidden}
.player{height:100%;width:100%;background:#34d058;transition:width 0.3s;}

/* devices */
.device{
  position:absolute;
  width:var(--device-w);
  min-height:var(--device-h);
  padding:8px;
  background:var(--panel);
  border-radius:12px;
  color:#000;
  box-shadow:0 8px 20px rgba(0,0,0,0.5);
  /* ä¸­å¿ƒåº§æ¨™ã§é…ç½®ã™ã‚‹ãŸã‚ translate(-50%, -50%) ã‚’ä½¿ç”¨ */
  transform:translate(-50%,-50%);
  text-align:center;
  z-index:60;
  /* é…ç½®è¨ˆç®—æ™‚ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ•ã«ã™ã‚‹ãŸã‚ã€JSã§åˆ¶å¾¡ */
  /* transition: all 0.3s ...; ã¯å‰Šé™¤ */
  box-sizing: border-box;
}
.device h3{margin:4px 0;font-size:12px}
.terminal{display:inline-flex;justify-content:center;align-items:center;width:30px;height:30px;margin:3px;background:var(--term-bg);color:#fff;border-radius:50%;font-size:11px;cursor:pointer;user-select:none}
.selected{outline:3px solid #ffd800; box-shadow:0 0 15px #ffd800}

/* Lamp Logic */
.device.lit { background: #fff9c4 !important; box-shadow: 0 0 40px var(--lamp-glow); }
.device.lit .bulb-shape { fill: #ffd200 !important; filter: drop-shadow(0 0 10px #ff0); }

/* Junction Box (Fixed size for calculation) */
#junction{ z-index:70; width:130px; min-height:100px; background:#d6d6d6; }
.jb-dots{display:flex; flex-wrap:wrap; justify-content:center; gap:6px; margin-top:8px;}
.jb-term{width:20px; height:20px; border-radius:50%; background:#222; cursor:pointer;}

/* Controls */
.controls{height:160px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:rgba(20,20,20,0.9);}
button{padding:12px 24px; border-radius:20px; border:none; font-weight:bold; cursor:pointer;}
#setBtn{background:#ffd000; color:#000; font-size:18px;}
.small-btn{background:#444; color:#fff; padding:8px 16px;}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9500;}
.modal-backdrop.show{display:flex}

/* Boss Screen - Image Fix */
#bossScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9200; background:rgba(0,0,0,0.85);}
.boss-card{width:85%; max-width: 400px; background:#111; padding:24px; border-radius:16px; border:3px solid #e74c3c; text-align:center; color: #fff;}
#bossImageContainer {
  width: 100%;
  height: 200px;
  margin-bottom: 16px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #333;
  background: #000;
  display: flex; justify-content: center; align-items: center;
}
#bossImage {
  width: 100%; height: 100%; object-fit: cover;
}

/* Wires - Visibility Fix */
.wire-line { stroke-linecap: round; transition: stroke-dashoffset 0.5s; }
/* é»’ç·šã¯è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«ç™½ã„å…‰å½©ã‚’è¿½åŠ  */
.wire-black { stroke: var(--wire-black); filter: drop-shadow(0 0 2px var(--wire-outline)); }
/* ç™½ç·šã¯èƒŒæ™¯ã«æº¶ã‘è¾¼ã¾ãªã„ã‚ˆã†ã«é»’ã„å½±ã‚’è¿½åŠ  */
.wire-white { stroke: var(--wire-white); filter: drop-shadow(0 0 2px rgba(0,0,0,0.8)); }

</style>
</head>
<body>
  <svg id="wireLayer" xmlns="http://www.w3.org/2000/svg"></svg>

  <div class="header">
    <div class="title">ä¿ºã‚‰ã®é›»å·¥ Î²</div>
    <div style="display:flex; align-items:center; gap:10px;">
      <span>HP</span>
      <div class="bar"><div id="playerHP" class="player"></div></div>
    </div>
    <div>Round: <span id="roundLabel">1</span></div>
  </div>

  <div id="board" style="position:relative; width:100%; height:calc(100vh - 220px);">
    <div id="junction" class="device">
      <h3>Joint Box</h3>
      <div class="jb-dots">
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
      </div>
    </div>

    <div class="device" id="power">
      <h3>é›»æº(100V)</h3>
      <div style="font-size:30px">âš¡</div>
      <div class="terminal" data-id="power-L">L</div>
      <div class="terminal" data-id="power-N">N</div>
    </div>

    <div class="device" id="switch">
      <h3>ç‰‡åˆ‡SW</h3>
      <div style="font-size:30px">ğŸ”˜</div>
      <div class="terminal" data-id="switch-IN">IN</div>
      <div class="terminal" data-id="switch-OUT">OUT</div>
      <div id="switchState" style="font-size:10px">OFF</div>
    </div>

    <div id="lampsContainer"></div>
  </div>

  <div class="controls">
    <div style="display:flex; gap:10px;">
      <button id="switchBtn" class="small-btn">SWITCH</button>
      <button id="setBtn">SET (é€šé›»ç¢ºèª)</button>
      <button id="resetWires" class="small-btn">Reset</button>
    </div>
    <div style="font-size:12px; color:#aaa; margin-top: 5px;">Lç«¯å­ï¼é»’ç·š / Nç«¯å­ï¼ç™½ç·š ã¨ã—ã¦é…ç·šã›ã‚ˆ</div>
  </div>

  <div id="titleScreen" class="modal-backdrop show">
    <h1 style="color:#ffd000; font-size:40px; text-align: center;">WORLD1<br><span style="font-size:24px">å®Œå…¨é…ç½®ä¿®æ­£ç‰ˆ</span></h1>
    <p>ãƒ‡ãƒã‚¤ã‚¹ã®é‡ãªã‚Šã‚’æ ¹çµ¶ã—ã¾ã—ãŸã€‚</p>
    <button onclick="startGame()" style="background:#ffd000; color:#000; padding:15px 40px; font-size:20px; margin-top: 20px;">ç¾å ´ã¸å…¥ã‚‹</button>
  </div>

  <div id="bossScreen">
    <div class="boss-card">
      <h2 style="color:#ffd000; margin-bottom: 10px;">æ±šã­ãˆå¤§å·¥</h2>
      <div id="bossImageContainer">
        <img id="bossImage" src="boss.png.jpg" alt="æ±šã­ãˆå¤§å·¥" onerror="this.parentElement.innerHTML='<span style=\'font-size:50px\'>ğŸ‘¹</span><br>ç”»åƒèª­è¾¼ã‚¨ãƒ©ãƒ¼'; this.style.display='none';">
      </div>
      
      <div class="bar" style="width:100%; margin:15px 0; background:#2b1818;"><div id="bossHP" class="player" style="background:#e74c3c;"></div></div>
      <p id="bossMsg">é€šé›»æˆåŠŸï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸï¼</p>
    </div>
  </div>

<script>
let bossHP = 100, playerHP = 100, roundNum = 1, switchOn = false;
let selected = null, connections = [], state = 'title';

/* --- è¡çªåˆ¤å®šç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --- */
function isOverlapping(rect1, rect2, margin) {
  return !(rect1.right < rect2.left - margin || 
           rect1.left > rect2.right + margin || 
           rect1.bottom < rect2.top - margin || 
           rect1.top > rect2.bottom + margin);
}

/* --- é‡ãªã‚Šé˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯ (ä¿®æ­£ç‰ˆ) --- */
function relocateDevices() {
  const board = document.getElementById('board');
  const boardRect = board.getBoundingClientRect();
  const devices = Array.from(document.querySelectorAll('.device'));
  const margin = 25; // ãƒ‡ãƒã‚¤ã‚¹é–“ã®ä½™ç™½ã‚’åºƒã‚ã«è¨­å®š

  // 1. é…ç½®æ¸ˆã¿ã®çŸ©å½¢ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
  const placedRects = [];

  // 2. ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ä¸­å¤®ã«å›ºå®šã—ã€ãã®çŸ©å½¢ã‚’è¨ˆç®—
  const jb = document.getElementById('junction');
  const jbW = jb.offsetWidth || 130; // ã‚¹ã‚¿ã‚¤ãƒ«ã‹ã‚‰å¹…ã‚’å–å¾—ã€æœªæç”»æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
  const jbH = jb.offsetHeight || 100;
  const jbCenterX = boardRect.width / 2;
  const jbCenterY = boardRect.height / 2;
  
  // è«–ç†çš„ãªçŸ©å½¢ã‚’ä½œæˆ (transform: translate(-50%, -50%) ã‚’è€ƒæ…®)
  const jbRect = {
    left: jbCenterX - jbW / 2,
    right: jbCenterX + jbW / 2,
    top: jbCenterY - jbH / 2,
    bottom: jbCenterY + jbH / 2,
    centerX: jbCenterX,
    centerY: jbCenterY,
    element: jb
  };
  placedRects.push(jbRect);

  // 3. ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’é †æ¬¡é…ç½®
  devices.forEach(dev => {
    if (dev.id === 'junction') return;

    const devW = dev.offsetWidth || 100;
    const devH = dev.offsetHeight || 130;
    let bestX, bestY, found = false;

    // é…ç½®å¯èƒ½ãªå ´æ‰€ã‚’æ¢ã™ (è©¦è¡Œå›æ•°ã‚’å¤§å¹…ã«å¢—åŠ )
    for (let attempts = 0; attempts < 500; attempts++) {
      // ãƒœãƒ¼ãƒ‰ã®ç«¯ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ³ã‚’ç©ºã‘ãŸç¯„å›²ã§ãƒ©ãƒ³ãƒ€ãƒ ãªä¸­å¿ƒåº§æ¨™ã‚’ç”Ÿæˆ
      const centerX = margin + devW/2 + Math.random() * (boardRect.width - devW - margin*2);
      const centerY = margin + devH/2 + Math.random() * (boardRect.height - devH - margin*2);
      
      const candidateRect = {
        left: centerX - devW / 2,
        right: centerX + devW / 2,
        top: centerY - devH / 2,
        bottom: centerY + devH / 2
      };

      // æ—¢å­˜ã®ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã¨è¡çªåˆ¤å®š
      let overlap = false;
      for (const placed of placedRects) {
        if (isOverlapping(candidateRect, placed, margin)) {
          overlap = true;
          break;
        }
      }

      if (!overlap) {
        bestX = centerX;
        bestY = centerY;
        found = true;
        break;
      }
    }

    // é…ç½®å ´æ‰€ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (å®‰å…¨ç­–)
    if (!found) {
      console.warn("é…ç½®å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å®‰å…¨ãªå ´æ‰€ã«é…ç½®ã—ã¾ã™ã€‚", dev.id);
      bestX = margin + devW/2 + (placedRects.length * 20); // å˜ç´”ã«ãšã‚‰ã—ã¦é…ç½®
      bestY = margin + devH/2;
    }

    // æ±ºå®šã—ãŸä½ç½®ã‚’çŸ©å½¢ãƒªã‚¹ãƒˆã«è¿½åŠ 
    placedRects.push({
      left: bestX - devW / 2,
      right: bestX + devW / 2,
      top: bestY - devH / 2,
      bottom: bestY + devH / 2,
      centerX: bestX,
      centerY: bestY,
      element: dev
    });
  });

  // 4. è¨ˆç®—çµæœã‚’ã¾ã¨ã‚ã¦DOMã«åæ˜  (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ãªã„)
  devices.forEach(dev => dev.style.transition = 'none');
  placedRects.forEach(rect => {
    rect.element.style.left = rect.centerX + "px";
    rect.element.style.top = rect.centerY + "px";
  });
  // å°‘ã—å¾…ã£ã¦ã‹ã‚‰transitionã‚’æˆ»ã™ (ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚transitionã¯CSSã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ)

  // é…ç·šã‚’æãç›´ã—
  setTimeout(redrawWires, 50);
}

/* --- é…ç·šãƒ­ã‚¸ãƒƒã‚¯ (è‰²åˆ†ã‘å¯¾å¿œ) --- */
function getWireColor(idA, idB) {
  // Lã‚’å«ã‚€ç«¯å­ãªã‚‰é»’ã€Nã‚’å«ã‚€ç«¯å­ãªã‚‰ç™½
  if (idA.includes('-L') || idB.includes('-L') || idA.includes('IN') || idA.includes('OUT')) {
    return 'black';
  }
  return 'white';
}

function drawWire(elA, elB, idA, idB) {
  const svg = document.getElementById('wireLayer');
  const rA = elA.getBoundingClientRect();
  const rB = elB.getBoundingClientRect();
  const colorType = getWireColor(idA, idB);

  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", rA.left + rA.width/2);
  line.setAttribute("y1", rA.top + rA.height/2);
  line.setAttribute("x2", rB.left + rB.width/2);
  line.setAttribute("y2", rB.top + rB.height/2);
  line.setAttribute("stroke-width", "6");
  line.classList.add('wire-line');
  line.classList.add(colorType === 'black' ? 'wire-black' : 'wire-white');
  
  svg.appendChild(line);
}

function redrawWires() {
  const svg = document.getElementById('wireLayer');
  svg.innerHTML = '';
  // æ¥ç¶šæƒ…å ±ã‹ã‚‰ç·šã‚’å†æç”»
  connections.forEach(c => {
    const idA = c[0], idB = c[1];
    // IDã‹ã‚‰ç«¯å­è¦ç´ ã‚’æ¢ã™ã€‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°JBã®é©å½“ãªç«¯å­ã§ä»£ç”¨
    const elA = document.querySelector(`.terminal[data-id="${idA}"], .jb-term[data-id="${idA}"]`) || document.querySelector('.jb-term');
    const elB = document.querySelector(`.terminal[data-id="${idB}"], .jb-term[data-id="${idB}"]`) || document.querySelectorAll('.jb-term')[1];
    
    if(elA && elB) drawWire(elA, elB, idA, idB);
  });
}

/* --- ã‚²ãƒ¼ãƒ é€²è¡Œ --- */
function startGame() {
  document.getElementById('titleScreen').classList.remove('show');
  state = 'play';
  setupRound();
}

function setupRound() {
  const container = document.getElementById('lampsContainer');
  container.innerHTML = '';
  for(let i=1; i<=roundNum; i++){
    const div = document.createElement('div');
    div.className = 'device';
    div.id = `lamp-${i}`;
    div.innerHTML = `<h3>ç…§æ˜-${i}</h3><div style="font-size:30px">ğŸ’¡</div>
      <div class="terminal" data-id="lamp-${i}-L">L</div>
      <div class="terminal" data-id="lamp-${i}-N">N</div>`;
    container.appendChild(div);
  }
  // DOMè¿½åŠ å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰é…ç½®è¨ˆç®—ã‚’å®Ÿè¡Œ
  setTimeout(() => {
    relocateDevices();
    attachEvents();
  }, 100);
}

function attachEvents() {
  document.querySelectorAll('.terminal, .jb-term').forEach(t => {
    t.onclick = (e) => {
      e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’æ­¢ã‚ã‚‹
      if(state !== 'play') return;
      
      // jb-termã®å ´åˆã€data-idãŒç©ºãªã‚‰'jb'ã‚’ã‚»ãƒƒãƒˆ
      const id = t.dataset.id || (t.classList.contains('jb-term') ? 'jb' : null);
      if(!id) return;

      if(selected === t) { 
        t.classList.remove('selected'); selected = null; return; 
      }
      if(!selected) { 
        selected = t; t.classList.add('selected'); return; 
      }
      
      const idA = selected.dataset.id || 'jb';
      const idB = id;
      
      // åŒã˜ç«¯å­åŒå£«ã‚„ã€åŒã˜ãƒ‡ãƒã‚¤ã‚¹å†…ã®ç«¯å­åŒå£«ï¼ˆç°¡æ˜“åˆ¤å®šï¼‰ã¯æ¥ç¶šã—ãªã„
      if(idA !== idB && selected.closest('.device') !== t.closest('.device')) {
        connections.push([idA, idB]);
        drawWire(selected, t, idA, idB);
      }
      
      selected.classList.remove('selected');
      selected = null;
    };
  });
}

/* --- åˆ¤å®šã¨ãƒœã‚¹æˆ¦ --- */
document.getElementById('setBtn').onclick = async () => {
  if(!switchOn) return alert("ã‚¹ã‚¤ãƒƒãƒã‚’ONã«ã—ã¦ãã ã•ã„");
  
  const has = (a, b) => connections.some(c => (c[0]===a && c[1]===b) || (c[0]===b && c[1]===a));
  // åŸºæœ¬å›è·¯ã®ãƒã‚§ãƒƒã‚¯
  const baseOk = has('power-L', 'jb') && has('jb', 'switch-IN') && has('switch-OUT', 'jb') && has('power-N', 'jb');
  
  // å…¨ã¦ã®ãƒ©ãƒ³ãƒ—ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  let lampsOk = true;
  for(let i=1; i<=roundNum; i++) {
    if(!has('jb', `lamp-${i}-L`) || !has('jb', `lamp-${i}-N`)) {
      lampsOk = false; break;
    }
  }

  if(baseOk && lampsOk) {
    // æˆåŠŸæ¼”å‡º
    document.querySelectorAll('[id^="lamp-"]').forEach(el => el.classList.add('lit'));
    state = 'boss';
    
    // ãƒœã‚¹ç”»é¢è¡¨ç¤º
    const bossScreen = document.getElementById('bossScreen');
    bossScreen.style.display = 'flex';
    
    // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã¨è¡¨ç¤ºæ›´æ–°
    const damage = 50;
    bossHP = Math.max(0, bossHP - damage);
    document.getElementById('bossHP').style.width = bossHP + "%";
    document.getElementById('bossMsg').textContent = bossHP === 0 ? "æ’ƒç ´ï¼æ±šã­ãˆå¤§å·¥ã‚’æµ„åŒ–ã—ãŸï¼" : `é€šé›»æˆåŠŸï¼${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸï¼`;

    // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¾ãŸã¯ã‚¯ãƒªã‚¢å‡¦ç†
    setTimeout(() => {
      bossScreen.style.display = 'none';
      document.querySelectorAll('[id^="lamp-"]').forEach(el => el.classList.remove('lit'));
      
      if(bossHP === 0) {
        alert("å…¨ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼");
        location.reload();
      } else {
        roundNum++;
        connections = [];
        document.getElementById('wireLayer').innerHTML = '';
        document.getElementById('roundLabel').textContent = roundNum;
        state = 'play';
        setupRound();
      }
    }, 2500);

  } else {
    // å¤±æ•—æ¼”å‡º
    playerHP = Math.max(0, playerHP - 20);
    document.getElementById('playerHP').style.width = playerHP + "%";
    alert("å›è·¯ãŒä¸å®Œå…¨ã§ã™ï¼\nãƒ»é›»æºã€ã‚¹ã‚¤ãƒƒãƒã€å…¨ã¦ã®ãƒ©ãƒ³ãƒ—ãŒJBã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ");
    if(playerHP === 0) {
      alert("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼...");
      location.reload();
    }
  }
};

document.getElementById('switchBtn').onclick = () => {
  switchOn = !switchOn;
  document.getElementById('switchState').textContent = switchOn ? "ON" : "OFF";
  document.getElementById('switch').style.background = switchOn ? "#e7ffec" : "#e6e6e6";
};

document.getElementById('resetWires').onclick = () => {
  connections = [];
  document.getElementById('wireLayer').innerHTML = '';
  if(selected) selected.classList.remove('selected');
  selected = null;
};

// ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«å†é…ç½®
let resizeTimer;
window.onresize = () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    relocateDevices();
  }, 200);
};

// åˆæœŸè¨­å®š
// viewportã®è¨­å®šã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’ç¦æ­¢ã—ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’é˜²ã
</script>
</body>
</html>
