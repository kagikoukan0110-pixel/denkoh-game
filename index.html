<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>俺らの電工 presents by 貴電</title>
<style>
/* ==========================================
   ベース設定
========================================== */
* { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Arial Black', sans-serif; overflow: hidden; }
.hidden { display: none !important; }

/* ==========================================
   タイトル＆クイズ画面
========================================== */
#titleScreen { position: fixed; inset: 0; background: radial-gradient(circle, #222 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
.title-logo { font-size: 42px; color: #ffd000; text-shadow: 0 0 25px #ffaa00; }
.subtitle { font-size: 20px; margin-top: 15px; color: #fff; letter-spacing: 5px; }

#quizScreen { position: fixed; inset: 0; background: #111; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.quiz-mark { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 300px; font-weight: bold; pointer-events: none; opacity: 0; z-index: 9500; }

/* ==========================================
   ゲーム画面（配線ボード）
========================================== */
#gameScreen { position: fixed; inset: 0; display: flex; flex-direction: column; background: #000; z-index: 100; }
#statusHeader { height: 60px; border-bottom: 2px solid #ffd000; display: flex; justify-content: space-around; align-items: center; background: #111; font-size: 16px; }
#board { flex: 1; position: relative; background: #0a0a0a; overflow: hidden; }

/* 配線レイヤーはデバイス(z:20)より上。マウスクリックは貫通させて端子(z:30)を押せるようにする */
#wireLayer { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none; }

/* デバイスと端子 */
.device { position: absolute; background: #ccc; color: #000; border: 2px solid #444; border-radius: 4px; padding: 5px; text-align: center; z-index: 20; transform: translate(-50%, -50%); box-shadow: 4px 4px 0 #000; }
.dev-title { font-size: 11px; font-weight: bold; border-bottom: 1px solid #777; margin-bottom: 6px; background: #ddd; }
.term { width: 36px; height: 36px; background: #222; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; border: 2px solid #000; position: relative; z-index: 60; pointer-events: auto; }
.term.sel { background: #ffd000 !important; color: #000; box-shadow: 0 0 20px #ffd000; }

/* 3路スイッチの厳密なレイアウト */
.layout-3way-left { display: flex; align-items: center; gap: 15px; padding: 5px; }
.layout-3way-right { display: flex; align-items: center; flex-direction: row-reverse; gap: 15px; padding: 5px; }
.term-col { display: flex; flex-direction: column; gap: 12px; }

.dev-lamp.on { background: #ffd000; box-shadow: 0 0 60px #ffd000; border-radius: 10px; transition: 0.2s; }

/* 配線デザイン */
.wire-white { stroke: #fff; stroke-width: 8; fill: none; stroke-linecap: round; filter: drop-shadow(0 0 2px #000); }
.wire-black { stroke: #111; stroke-width: 9; fill: none; stroke-linecap: round; filter: drop-shadow(0 0 2px #555); }
.wire-glow { stroke: #ffd000; stroke-width: 5; stroke-dasharray: 12, 18; animation: flow 0.5s linear infinite; fill: none; display: none; }
@keyframes flow { from { stroke-dashoffset: 30; } to { stroke-dashoffset: 0; } }

/* コントロールパネル */
#controls { height: 120px; background: #111; display: flex; justify-content: center; align-items: center; gap: 30px; border-top: 2px solid #333; z-index: 1000; position: relative; }
.btn-set { padding: 18px 50px; background: #ffd000; border: none; border-radius: 8px; font-size: 24px; font-weight: bold; cursor: pointer; color: #000; }
.btn-set:active { transform: scale(0.95); }

/* ==========================================
   演出レイヤー（フラッシュ、フリーズ、プチュン）
========================================== */
/* フラッシュ＆フリーズ用クラス（boardに付与） */
@keyframes flashEffect { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(10) contrast(5); background: #fff; } }
.effect-flash { animation: flashEffect 0.08s infinite; }
.effect-freeze { filter: grayscale(100%) contrast(1.5) brightness(0.6); }

/* プチュン演出用 */
#puchunScreen { position: fixed; inset: 0; background: #000; z-index: 20000; display: none; align-items: center; justify-content: center; }
#puchunLine { width: 100%; height: 3px; background: #fff; transform: scaleX(0); }

/* ==========================================
   ボスバトル＆撃破レイヤー
========================================== */
#bossScreen { position: fixed; inset: 0; background: radial-gradient(circle, #333 0%, #000 100%); z-index: 25000; display: none; flex-direction: column; align-items: center; justify-content: center; }
.boss-title { color: red; font-size: 30px; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 15px #f00; letter-spacing: 2px; }
.boss-img-box { position: relative; width: 300px; height: 300px; border: 3px solid #555; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.boss-img { width: 100%; height: 100%; object-fit: contain; }
#bossHpWrapper { width: 80%; max-width: 600px; height: 25px; background: #222; border: 2px solid #fff; margin-top: 30px; position: relative; }
#bossHpBar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0000, #ff7b00); transition: width 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); }

@keyframes bossShake { 0% { transform: translate(0, 0); } 20% { transform: translate(-10px, 10px); } 40% { transform: translate(10px, -10px); } 60% { transform: translate(-10px, -10px); } 80% { transform: translate(10px, 10px); } 100% { transform: translate(0, 0); } }
.boss-taking-damage { animation: bossShake 0.1s infinite; filter: brightness(1.5) sepia(1) hue-rotate(-50deg) saturate(5); }

/* 撃破文字 */
#gekihaText { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(5); color: #ffd000; font-size: 100px; font-weight: 900; text-shadow: 0 0 40px #f00, 0 0 10px #fff; opacity: 0; z-index: 30000; pointer-events: none; }
</style>
</head>
<body>

<div id="titleScreen">
    <div class="title-logo">俺らの電工</div>
    <div class="subtitle">presents by 貴電</div>
    <button style="margin-top:50px; padding:20px 60px; background:#ffd000; border:none; border-radius:40px; font-weight:bold; font-size:22px; cursor:pointer;" onclick="startGame()">現場に入る</button>
</div>

<div id="quizScreen" class="hidden">
    <div id="qText" style="font-size:24px; margin-bottom:40px; text-align:center;"></div>
    <div id="ansBox" style="width:100%; max-width:500px; display:flex; flex-direction:column; gap:20px; align-items:center;"></div>
</div>
<div id="quizResult" class="quiz-mark"></div>

<div id="gameScreen" class="hidden">
    <div id="statusHeader">
        <div id="dispWorld" style="color:#ffd000"></div>
        <div id="dispPhase"></div>
        <div id="dispRank" style="color:#0f0">【貴電】正規職人</div>
    </div>
    <div id="board">
        <svg id="wireLayer"></svg>
    </div>
    <div id="controls">
        <button onclick="resetWires()" style="padding:15px 30px; background:#444; color:#fff; border:none; border-radius:8px; font-size:18px; cursor:pointer;">全解線</button>
        <button class="btn-set" onclick="checkCircuit()">点灯試験 (SET)</button>
    </div>
</div>

<div id="puchunScreen">
    <div id="puchunLine"></div>
</div>

<div id="bossScreen">
    <div class="boss-title">WARNING : 現場の魔物</div>
    <div class="boss-img-box" id="bossImgBox">
        <img src="boss.png" class="boss-img" alt="BOSS" onerror="this.src='https://via.placeholder.com/300/FF0000/FFFFFF?text=NO+IMAGE'">
    </div>
    <div id="bossHpWrapper">
        <div id="bossHpBar"></div>
    </div>
</div>

<div id="gekihaText">撃破降臨</div>

<script>
// --- 基本変数 ---
const el = id => document.getElementById(id);
let world = 1, phase = 1, qIdx = 0, lines = [], selTerm = null;
let swStates = { sw1:false, swA:false, swB:false };

// --- クイズデータ ---
const quizData = [
    {q:"接地側（N）電線の色はどれか？", a:["黒","白","赤","緑"], c:1},
    {q:"3路スイッチの共通端子（電源・負荷側）の番号は？", a:["0","1","3","接地"], c:0},
    {q:"この現場を仕切っているのは？", a:["適当な大工","素人","貴電","見習い"], c:2}
];

// --- 進行ロジック ---
function startGame() {
    el('titleScreen').classList.add('hidden');
    el('quizScreen').classList.remove('hidden');
    qIdx = 0; 
    loadQuiz();
}

function loadQuiz() {
    if(qIdx >= quizData.length) { 
        el('quizScreen').classList.add('hidden'); 
        el('gameScreen').classList.remove('hidden'); 
        initBoard(); 
        return; 
    }
    const q = quizData[qIdx];
    el('qText').innerText = q.q;
    el('ansBox').innerHTML = '';
    q.a.forEach((t, i) => {
        const btn = document.createElement('button');
        btn.style = "width:100%; padding:20px; background:#222; color:#fff; border:2px solid #555; border-radius:10px; font-size:20px; font-weight:bold; cursor:pointer;";
        btn.innerText = t;
        btn.onclick = () => {
            const ok = (i === q.c);
            el('quizResult').innerText = ok ? '◯' : '×';
            el('quizResult').style.color = ok ? '#00f2ff' : 'red';
            el('quizResult').style.opacity = 1;
            setTimeout(() => { 
                el('quizResult').style.opacity = 0; 
                if(ok){ qIdx++; loadQuiz(); } 
            }, 500);
        };
        el('ansBox').appendChild(btn);
    });
}

// --- ボード初期化 ---
function initBoard() {
    el('dispWorld').innerText = `WORLD ${world}`;
    el('dispPhase').innerText = `PHASE ${phase}/3`;
    
    // 古いデバイスを削除
    el('board').querySelectorAll('.device').forEach(d => d.remove());
    lines = []; 
    drawWires();

    // 電源とJB
    addDev('p', '電源', 50, 15, [['p-L','L'],['p-N','N']], 'dev-breaker', 'std');
    addDev('jb', 'JB', 50, 42, [['j1','1'],['j2','2'],['j3','3'],['j4','4'],['j5','5'],['j6','6']], 'dev-jb', 'std');

    if(world === 1) {
        addDev('sw1', '片切SW', 30, 80, [['s1-0','0'],['s1-1','1']], 'dev-sw', 'std');
        for(let i=0; i<phase; i++) {
            addDev(`l${i}`, `ランプ${i+1}`, 55+(i*15), 80, [[`l${i}-L`,'L'],[`l${i}-N`,'N']], 'dev-lamp', 'std');
        }
    } else {
        // ★完全再現：3路スイッチの端子レイアウト
        addDev('swA', '3路SW(左)', 20, 80, [['a-0','0'],['a-1','1'],['a-3','3']], 'dev-sw', '3way-left');
        addDev('swB', '3路SW(右)', 60, 80, [['b-1','1'],['b-3','3'],['b-0','0']], 'dev-sw', '3way-right');
