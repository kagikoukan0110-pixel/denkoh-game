<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ä¿ºã‚‰ã®é›»å·¥ - çœŸãƒ»å®Œæˆç‰ˆ</title>
<style>
:root {
  --bg: #000;
  --panel: #e6e6e6;
  --term-bg: #222;
  --wire-black: #1a1a1a;
  --wire-white: #ffffff;
  --wire-outline: rgba(255,255,255,0.5);
  --device-w: 100px;
  --device-h: 130px;
  --lamp-glow: rgba(255,220,80,0.95);
}

html, body { height: 100%; margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
#wireLayer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 3000; }

/* ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
@keyframes rainbow {
  0% { filter: hue-rotate(0deg) brightness(1.5); }
  50% { filter: hue-rotate(180deg) brightness(2.5); }
  100% { filter: hue-rotate(360deg) brightness(1.5); }
}
.flash-rainbow { animation: rainbow 0.1s infinite !important; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header { display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; height: 60px; background: #111; border-bottom: 1px solid #333; box-sizing: border-box; }
.hp-bar { width: 150px; height: 15px; background: #333; border-radius: 10px; overflow: hidden; }
.hp-inner { height: 100%; width: 100%; background: #34d058; transition: width 0.3s; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; }
.modal-backdrop.show { display: flex; }
.card { width: 85%; max-width: 450px; background: #1a1a1a; padding: 25px; border-radius: 20px; border: 2px solid #444; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,1); }
.q-btn { display: block; width: 100%; margin: 12px 0; padding: 15px; background: #333; color: #fff; border: 1px solid #555; border-radius: 10px; cursor: pointer; font-size: 16px; }
.q-btn:active { background: #555; }

/* é…ç·šãƒ‡ãƒã‚¤ã‚¹ */
.device { position: absolute; width: var(--device-w); min-height: var(--device-h); padding: 8px; background: var(--panel); border-radius: 12px; color: #000; box-shadow: 0 8px 20px rgba(0,0,0,0.5); transform: translate(-50%, -50%); text-align: center; z-index: 60; box-sizing: border-box; }
.device h3 { margin: 4px 0; font-size: 11px; pointer-events: none; }
.terminal { display: inline-flex; justify-content: center; align-items: center; width: 32px; height: 32px; margin: 4px; background: var(--term-bg); color: #fff; border-radius: 50%; font-size: 11px; cursor: pointer; user-select: none; }
.terminal.selected { outline: 4px solid #ffd800; box-shadow: 0 0 15px #ffd800; }
.device.lit { background: #fff9c4 !important; box-shadow: 0 0 50px var(--lamp-glow); transition: 0.3s; }

/* ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ */
#junction { z-index: 70; width: 130px; min-height: 110px; background: #ccc; }
.jb-term { width: 22px; height: 22px; border-radius: 50%; background: #222; margin: 4px; cursor: pointer; display: inline-block; }

/* é…ç·šæç”» */
.wire-line { stroke-linecap: round; stroke-width: 6; }
.wire-black { stroke: var(--wire-black); filter: drop-shadow(0 0 2px var(--wire-outline)); }
.wire-white { stroke: var(--wire-white); filter: drop-shadow(0 0 2px rgba(0,0,0,0.8)); }

/* æ“ä½œãƒ‘ãƒãƒ« */
.controls { position: fixed; bottom: 0; width: 100%; height: 120px; background: rgba(15,15,15,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; z-index: 4000; }
.main-btn { padding: 15px 50px; background: #ffd000; color: #000; border: none; border-radius: 30px; font-weight: bold; font-size: 20px; cursor: pointer; box-shadow: 0 4px 0 #b39200; }
.main-btn:active { transform: translateY(2px); box-shadow: none; }
.sub-btn { background: #444; color: #fff; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<svg id="wireLayer" xmlns="http://www.w3.org/2000/svg"></svg>

<div id="quizScreen" class="modal-backdrop show">
  <div class="card">
    <h1 style="color:#ffd000; margin-top:0;">å­¦ç§‘è©¦é¨“</h1>
    <p id="qCount">ç¬¬ 1 / 5 å•</p>
    <h3 id="qText">è³ªå•èª­ã¿è¾¼ã¿ä¸­...</h3>
    <div id="answers"></div>
    <div style="margin-top:20px;">HP: <span id="quizHP">100</span></div>
  </div>
</div>

<div id="bossScreen" class="modal-backdrop">
  <div class="card">
    <h2 id="bossMsg" style="color:#ff4444;">ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼</h2>
    <div style="border:3px solid #e74c3c; border-radius:10px; overflow:hidden; margin-bottom:15px; background:#000;">
      <img src="boss.png.jpg" style="width:100%; display:block;" alt="æ±šã­ãˆå¤§å·¥" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22red%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2250%22>ğŸ‘¹</text></svg>'">
    </div>
    <div class="hp-bar" style="width:100%; height:25px; margin-bottom:10px;">
      <div id="bossHPInner" class="hp-inner" style="background:#e74c3c; width:100%;"></div>
    </div>
    <p id="bossSubMsg">é€šé›»æˆåŠŸï¼</p>
  </div>
</div>

<div class="header">
  <div style="font-weight:bold; font-size:18px;">ä¿ºã‚‰ã®é›»å·¥ <span id="roundLabel" style="color:#ffd000;">ROUND 1</span></div>
  <div style="display:flex; align-items:center; gap:10px;">
    <span>HP</span>
    <div class="hp-bar"><div id="playerHP" class="hp-inner"></div></div>
  </div>
</div>

<div id="board" style="position:relative; width:100%; height:calc(100vh - 180px);">
  </div>

<div class="controls">
  <div style="display:flex; gap:10px;">
    <button id="switchToggleBtn" class="sub-btn">ã‚¹ã‚¤ãƒƒãƒ ON/OFF</button>
    <button id="resetWires" class="sub-btn">é…ç·šãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <button id="setBtn" class="main-btn">SET (é€šé›»ç¢ºèª)</button>
</div>

<script>
/* --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿è¨­å®š --- */
const quizData = [
  {q: "é›»æ°—å·¥äº‹å£«æ³•ã«ãŠã„ã¦ã€ä¸€èˆ¬ç”¨é›»æ°—å·¥ä½œç‰©ã®å·¥äº‹ã«å¾“äº‹ã§ãã‚‹ã®ã¯ï¼Ÿ", a: ["è¦‹ç¿’ã„å·¥", "ç¬¬äºŒç¨®é›»æ°—å·¥äº‹å£«", "ä¸€ç´šå»ºç¯‰å£«", "é›»æ°—ä¸»ä»»æŠ€è¡“è€…"], correct: 1},
  {q: "ä½åœ§å±‹å†…é…ç·šã§ã€è¨±å®¹é›»æµãŒæœ€ã‚‚å¤§ãã„æ–­é¢ç©ã®é›»ç·šã¯ï¼Ÿ", a: ["1.6mm", "2.0mm", "2.6mm", "5.5mm^2"], correct: 3},
  {q: "ã‚¹ã‚¤ãƒƒãƒã®çµç·šã«ãŠã„ã¦ã€éæ¥åœ°å´ï¼ˆLï¼‰ã‚’çµç·šã™ã¹ãå ´æ‰€ã¯ï¼Ÿ", a: ["ç›´æ¥ã‚³ãƒ³ã‚»ãƒ³ãƒˆã¸", "ç…§æ˜ã®å™¨å…·ç«¯å­", "ã‚¹ã‚¤ãƒƒãƒã®å…¥åŠ›å´", "æ¥åœ°æ¥µ"], correct: 2},
  {q: "å›è·¯ã®çµ¶ç¸æŠµæŠ—ã‚’æ¸¬å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹å™¨å…·ã¯ï¼Ÿ", a: ["å›è·¯è¨ˆï¼ˆãƒ†ã‚¹ã‚¿ï¼‰", "ãƒ¡ã‚¬ãƒ¼ï¼ˆçµ¶ç¸æŠµæŠ—è¨ˆï¼‰", "ã‚¯ãƒ©ãƒ³ãƒ—ãƒ¡ãƒ¼ã‚¿", "æ¤œé›»å™¨"], correct: 1},
  {q: "æ¥åœ°æŠµæŠ—ã‚’å°ã•ãã™ã‚‹ãŸã‚ã«ã€æ¥åœ°æ£’ã‚’æ‰“ã¡è¾¼ã‚€ã®ã¯ã©ã‚Œã‹ï¼Ÿ", a: ["ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆå†…", "ä¹¾ç‡¥ã—ãŸç ‚åœ°", "æ¹¿ã£ãŸåœŸå£Œ", "ã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆã®ä¸‹"], correct: 2}
];

let state = 'QUIZ';
let playerHP = 100;
let bossHP = 100;
let roundNum = 1;
let currentQ = 0;
let selectedTerm = null;
let connections = [];
let switchOn = false;

/* --- å­¦ç§‘è©¦é¨“ãƒ­ã‚¸ãƒƒã‚¯ --- */
function renderQuiz() {
  if (currentQ >= quizData.length) {
    startRealGame();
    return;
  }
  const data = quizData[currentQ];
  document.getElementById('qText').textContent = data.q;
  document.getElementById('qCount').textContent = `ç¬¬ ${currentQ + 1} / 5 å•`;
  document.getElementById('quizHP').textContent = playerHP;
  
  const ansDiv = document.getElementById('answers');
  ansDiv.innerHTML = '';
  data.a.forEach((txt, i) => {
    const btn = document.createElement('button');
    btn.className = 'q-btn';
    btn.textContent = txt;
    btn.onclick = () => {
      if (i === data.correct) {
        alert("æ­£è§£ï¼");
      } else {
        playerHP -= 20;
        alert("ä¸æ­£è§£ï¼HPãƒ€ãƒ¡ãƒ¼ã‚¸");
      }
      updateHPUI();
      if (playerHP <= 0) { alert("ä¸åˆæ ¼...ç¾å ´å…¥ã‚Šç¦æ­¢ã§ã™ã€‚"); location.reload(); }
      currentQ++;
      renderQuiz();
    };
    ansDiv.appendChild(btn);
  });
}

function updateHPUI() {
  document.getElementById('playerHP').style.width = playerHP + "%";
  if (playerHP < 30) document.getElementById('playerHP').style.background = "#e74c3c";
}

function startRealGame() {
  state = 'PLAY';
  document.getElementById('quizScreen').classList.remove('show');
  setupRound();
}

/* --- é‡ãªã‚Šé˜²æ­¢ãƒ»ãƒ‡ãƒã‚¤ã‚¹é…ç½®ãƒ­ã‚¸ãƒƒã‚¯ --- */
function setupRound() {
  const board = document.getElementById('board');
  board.innerHTML = '';
  connections = [];
  document.getElementById('wireLayer').innerHTML = '';
  document.getElementById('roundLabel').textContent = `ROUND ${roundNum}`;
  
  // 1. ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ä½œæˆ
  createDevice('junction', 'Joint Box', 50, 50, true);
  // 2. é›»æºä½œæˆ
  createDevice('power', 'é›»æº(100V)', 20, 20);
  // 3. ã‚¹ã‚¤ãƒƒãƒä½œæˆ
  createDevice('switch', 'ç‰‡åˆ‡SW', 80, 80);
  // 4. ãƒ©ãƒ³ãƒ—ä½œæˆ (ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«å¢—åŠ )
  for (let i = 1; i <= roundNum; i++) {
    createDevice(`lamp-${i}`, `ç…§æ˜-${i}`, Math.random()*80+10, Math.random()*80+10);
  }

  relocateDevices();
}

function createDevice(id, title, x, y, isJB = false) {
  const div = document.createElement('div');
  div.className = 'device';
  div.id = id;
  let html = `<h3>${title}</h3>`;
  
  if (isJB) {
    html += `<div style="display:flex; flex-wrap:wrap; justify-content:center; margin-top:5px;">`;
    for(let i=0; i<8; i++) html += `<div class="terminal jb-term" data-id="jb-${i}"></div>`;
    html += `</div>`;
  } else if (id === 'power') {
    html += `<div style="font-size:24px">âš¡</div><div class="terminal" data-id="power-L">L</div><div class="terminal" data-id="power-N">N</div>`;
  } else if (id === 'switch') {
    html += `<div id="swIcon" style="font-size:24px">ğŸ”˜</div><div class="terminal" data-id="sw-IN">IN</div><div class="terminal" data-id="sw-OUT">OUT</div><div id="swSt" style="font-size:10px">OFF</div>`;
  } else {
    html += `<div style="font-size:24px">ğŸ’¡</div><div class="terminal" data-id="${id}-L">L</div><div class="terminal" data-id="${id}-N">N</div>`;
  }
  
  div.innerHTML = html;
  document.getElementById('board').appendChild(div);
}

function relocateDevices() {
  const board = document.getElementById('board');
  const bRect = board.getBoundingClientRect();
  const devices = Array.from(document.querySelectorAll('.device'));
  const placed = [];
  const margin = 20;

  devices.forEach(dev => {
    let x, y, rect, overlap, attempts = 0;
    const w = dev.offsetWidth || 100, h = dev.offsetHeight || 130;

    if (dev.id === 'junction') {
      x = bRect.width / 2; y = bRect.height / 2;
    } else {
      do {
        overlap = false;
        x = margin + w/2 + Math.random() * (bRect.width - w - margin*2);
        y = margin + h/2 + Math.random() * (bRect.height - h - margin*2);
        const cand = { l: x-w/2, r: x+w/2, t: y-h/2, b: y+h/2 };
        for(let p of placed) {
          if (!(cand.r < p.l-margin || cand.l > p.r+margin || cand.b < p.t-margin || cand.t > p.b+margin)) {
            overlap = true; break;
          }
        }
        attempts++;
      } while (overlap && attempts < 200);
    }
    dev.style.left = x + "px"; dev.style.top = y + "px";
    placed.push({ l: x-w/2, r: x+w/2, t: y-h/2, b: y+h/2 });
  });
  
  // ã‚¤ãƒ™ãƒ³ãƒˆå†å‰²ã‚Šå½“ã¦
  document.querySelectorAll('.terminal').forEach(t => t.onclick = (e) => handleTerminalClick(e.target));
}

/* --- é…ç·šãƒ»æ¥ç¶šã‚·ã‚¹ãƒ†ãƒ  --- */
function handleTerminalClick(el) {
  if (selectedTerm === el) { el.classList.remove('selected'); selectedTerm = null; return; }
  if (!selectedTerm) { selectedTerm = el; el.classList.add('selected'); return; }

  const idA = selectedTerm.dataset.id;
  const idB = el.dataset.id;

  // åŒã˜ãƒ‡ãƒã‚¤ã‚¹å†…ã®æ¥ç¶šç¦æ­¢
  if (selectedTerm.closest('.device') === el.closest('.device')) {
    alert("åŒã˜å™¨å…·å†…ã¯æ¥ç¶šã§ãã¾ã›ã‚“");
  } else {
    connections.push([idA, idB]);
    drawWires();
  }
  selectedTerm.classList.remove('selected');
  selectedTerm = null;
}

function drawWires() {
  const svg = document.getElementById('wireLayer');
  svg.innerHTML = '';
  connections.forEach(conn => {
    const elA = document.querySelector(`[data-id="${conn[0]}"]`);
    const elB = document.querySelector(`[data-id="${conn[1]}"]`);
    if (!elA || !elB) return;

    const rA = elA.getBoundingClientRect();
    const rB = elB.getBoundingClientRect();
    
    // Lç«¯å­ï¼ˆé»’ç·šï¼‰åˆ¤å®šï¼šL, IN, OUTãŒå«ã¾ã‚Œã‚Œã°é»’
    const isL = (id) => id.includes('-L') || id.includes('sw-') || id.includes('power-L');
    const colorClass = (isL(conn[0]) || isL(conn[1])) ? 'wire-black' : 'wire-white';

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", rA.left + rA.width/2);
    line.setAttribute("y1", rA.top + rA.height/2);
    line.setAttribute("x2", rB.left + rB.width/2);
    line.setAttribute("y2", rB.top + rB.height/2);
    line.setAttribute("class", `wire-line ${colorClass}`);
    svg.appendChild(line);
  });
}

/* --- åˆ¤å®šãƒ»ãƒœã‚¹ãƒãƒˆãƒ«æ¼”å‡º --- */
document.getElementById('setBtn').onclick = () => {
  if (!switchOn) { alert("ã‚¹ã‚¤ãƒƒãƒã‚’ONã«ã—ã¦ãã ã•ã„"); return; }

  // ç°¡æ˜“åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé›»æºã€ã‚¹ã‚¤ãƒƒãƒã€JBã€å…¨ãƒ©ãƒ³ãƒ—ãŒç¹‹ãŒã£ã¦ã„ã‚‹ã‹ï¼‰
  const has = (a, b) => connections.some(c => (c[0].includes(a) && c[1].includes(b)) || (c[0].includes(b) && c[1].includes(a)));
  
  // åŸºæœ¬ï¼šé›»æºL -> JB -> ã‚¹ã‚¤ãƒƒãƒIN -> OUT -> JB -> ç…§æ˜L / é›»æºN -> JB -> ç…§æ˜N
  const pL_JB = has('power-L', 'jb');
  const sw_JB = has('sw-IN', 'jb') && has('sw-OUT', 'jb');
  const pN_JB = has('power-N', 'jb');
  
  let lampsOk = true;
  for(let i=1; i<=roundNum; i++) {
    if (!has(`lamp-${i}-L`, 'jb') || !has(`lamp-${i}-N`, 'jb')) { lampsOk = false; break; }
  }

  if (pL_JB && sw_JB && pN_JB && lampsOk) {
    successEffect();
  } else {
    playerHP -= 20;
    updateHPUI();
    alert("å›è·¯ãŒä¸å®Œå…¨ã§ã™ï¼HPãƒ€ãƒ¡ãƒ¼ã‚¸ï¼");
    if (playerHP <= 0) location.reload();
  }
};

function successEffect() {
  document.querySelectorAll('[id^="lamp-"]').forEach(el => el.classList.add('lit'));
  document.body.classList.add('flash-rainbow'); // ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ç™ºå‹•
  
  const bossModal = document.getElementById('bossScreen');
  const bHPInner = document.getElementById('bossHPInner');
  
  bossHP -= 34; // 3å›ã§æ’ƒç ´
  if (bossHP < 0) bossHP = 0;

  setTimeout(() => {
    bossModal.classList.add('show');
    bHPInner.style.width = bossHP + "%";
    document.getElementById('bossMsg').textContent = bossHP <= 0 ? "å®Œå…¨æ’ƒç ´ï¼" : "ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼";
    document.getElementById('bossSubMsg').textContent = bossHP <= 0 ? "ãŠã‚ã§ã¨ã†ï¼å›ã¯ä¸€äººå‰ã®é›»å·¥ã ï¼" : `ã‚ã¨ ${Math.ceil(bossHP/34)} ç™ºï¼`;

    setTimeout(() => {
      bossModal.classList.remove('show');
      document.body.classList.remove('flash-rainbow');
      if (bossHP <= 0) {
        alert("å…¨ã‚¯ãƒªé”æˆï¼");
