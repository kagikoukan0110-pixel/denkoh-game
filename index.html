<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ä¿ºã‚‰ã®é›»å·¥ Î² - Fixed Layout</title>
<style>
:root{
  --bg:#000;
  --panel:#e6e6e6;
  --term-bg:#222;
  --wire-black:#1a1a1a;
  --wire-white:#ffffff;
  --wire-outline:rgba(255,255,255,0.4);
  --device-w:100px;
  --device-h:130px;
  --lamp-glow: rgba(255,220,80,0.95);
}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:sans-serif;overflow:hidden; touch-action: none;}
#wireLayer{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:3000}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;height:60px;box-sizing:border-box;}
.title{font-size:20px;font-weight:700}
.bar{width:180px;height:12px;background:#222;border-radius:12px;overflow:hidden}
.player{height:100%;width:100%;background:#34d058;transition:width 0.3s;}

/* devices */
.device{
  position:absolute;
  width:var(--device-w);
  min-height:var(--device-h);
  padding:8px;
  background:var(--panel);
  border-radius:12px;
  color:#000;
  box-shadow:0 8px 20px rgba(0,0,0,0.5);
  /* ä¸­å¿ƒåº§æ¨™ã§é…ç½®ã™ã‚‹ãŸã‚ translate(-50%, -50%) ã‚’ä½¿ç”¨ */
  transform:translate(-50%,-50%);
  text-align:center;
  z-index:60;
  /* é…ç½®è¨ˆç®—æ™‚ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ•ã«ã™ã‚‹ãŸã‚ã€JSã§åˆ¶å¾¡ */
  /* transition: all 0.3s ...; ã¯å‰Šé™¤ */
  box-sizing: border-box;
}
.device h3{margin:4px 0;font-size:12px}
.terminal{display:inline-flex;justify-content:center;align-items:center;width:30px;height:30px;margin:3px;background:var(--term-bg);color:#fff;border-radius:50%;font-size:11px;cursor:pointer;user-select:none}
.selected{outline:3px solid #ffd800; box-shadow:0 0 15px #ffd800}

/* Lamp Logic */
.device.lit { background: #fff9c4 !important; box-shadow: 0 0 40px var(--lamp-glow); }
.device.lit .bulb-shape { fill: #ffd200 !important; filter: drop-shadow(0 0 10px #ff0); }

/* Junction Box (Fixed size for calculation) */
#junction{ z-index:70; width:130px; min-height:100px; background:#d6d6d6; }
.jb-dots{display:flex; flex-wrap:wrap; justify-content:center; gap:6px; margin-top:8px;}
.jb-term{width:20px; height:20px; border-radius:50%; background:#222; cursor:pointer;}

/* Controls */
.controls{height:160px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:rgba(20,20,20,0.9);}
button{padding:12px 24px; border-radius:20px; border:none; font-weight:bold; cursor:pointer;}
#setBtn{background:#ffd000; color:#000; font-size:18px;}
.small-btn{background:#444; color:#fff; padding:8px 16px;}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9500;}
.modal-backdrop.show{display:flex}

/* Boss Screen - Image Fix */
#bossScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9200; background:rgba(0,0,0,0.85);}
.boss-card{width:85%; max-width: 400px; background:#111; padding:24px; border-radius:16px; border:3px solid #e74c3c; text-align:center; color: #fff;}
#bossImageContainer {
  width: 100%;
  height: 200px;
  margin-bottom: 16px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #333;
  background: #000;
  display: flex; justify-content: center; align-items: center;
}
#bossImage {
  width: 100%; height: 100%; object-fit: cover;
}

/* Wires - Visibility Fix */
.wire-line { stroke-linecap: round; transition: stroke-dashoffset 0.5s; }
/* é»’ç·šã¯è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«ç™½ã„å…‰å½©ã‚’è¿½åŠ  */
.wire-black { stroke: var(--wire-black); filter: drop-shadow(0 0 2px var(--wire-outline)); }
/* ç™½ç·šã¯èƒŒæ™¯ã«æº¶ã‘è¾¼ã¾ãªã„ã‚ˆã†ã«é»’ã„å½±ã‚’è¿½åŠ  */
.wire-white { stroke: var(--wire-white); filter: drop-shadow(0 0 2px rgba(0,0,0,0.8)); }

</style>
</head>
<body>
  <svg id="wireLayer" xmlns="http://www.w3.org/2000/svg"></svg>

  <div class="header">
    <div class="title">ä¿ºã‚‰ã®é›»å·¥ Î²</div>
    <div style="display:flex; align-items:center; gap:10px;">
      <span>HP</span>
      <div class="bar"><div id="playerHP" class="player"></div></div>
    </div>
    <div>Round: <span id="roundLabel">1</span></div>
  </div>

  <div id="board" style="position:relative; width:100%; height:calc(100vh - 220px);">
    <div id="junction" class="device">
      <h3>Joint Box</h3>
      <div class="jb-dots">
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
      </div>
    </div>

    <div class="device" id="power">
      <h3>é›»æº(100V)</h3>
      <div style="font-size:30px">âš¡</div>
      <div class="terminal" data-id="power-L">L</div>
      <div class="terminal" data-id="power-N">N</div>
    </div>

    <div class="device" id="switch">
      <h3>ç‰‡åˆ‡SW</h3>
      <div style="font-size:30px">ğŸ”˜</div>
      <div class="terminal" data-id="switch-IN">IN</div>
      <div class="terminal" data-id="switch-OUT">OUT</div>
      <div id="switchState" style="font-size:10px">OFF</div>
    </div>

    <div id="lampsContainer"></div>
  </div>

  <div class="controls">
    <div style="display:flex; gap:10px;">
      <button id="switchBtn" class="small-btn">SWITCH</button>
      <button id="setBtn">SET (é€šé›»ç¢ºèª)</button>
      <button id="resetWires" class="small-btn">Reset</button>
    </div>
    <div style="font-size:12px; color:#aaa; margin-top: 5px;">Lç«¯å­ï¼é»’ç·š / Nç«¯å­ï¼ç™½ç·š ã¨ã—ã¦é…ç·šã›ã‚ˆ</div>
  </div>

  <div id="titleScreen" class="modal-backdrop show">
    <h1 style="color:#ffd000; font-size:40px; text-align: center;">WORLD1<br><span style="font-size:24px">å®Œå…¨é…ç½®ä¿®æ­£ç‰ˆ</span></h1>
    <p>ãƒ‡ãƒã‚¤ã‚¹ã®é‡ãªã‚Šã‚’æ ¹çµ¶ã—ã¾ã—ãŸã€‚</p>
    <button onclick="startGame()" style="background:#ffd000; color:#000; padding:15px 40px; font-size:20px; margin-top: 20px;">ç¾å ´ã¸å…¥ã‚‹</button>
  </div>

  <div id="bossScreen">
    <div class="boss-card">
      <h2 style="color:#ffd000; margin-bottom: 10px;">æ±šã­ãˆå¤§å·¥</h2>
      <div id="bossImageContainer">
        <img id="bossImage" src="boss.png.jpg" alt="æ±šã­ãˆå¤§å·¥" onerror="this.parentElement.innerHTML='<span style=\'font-size:50px\'>ğŸ‘¹</span><br>ç”»åƒèª­è¾¼ã‚¨ãƒ©ãƒ¼'; this.style.display='none';">
      </div>
      
      <div class="bar" style="width:100%; margin:15px 0; background:#2b1818;"><div id="bossHP" class="player" style="background:#e74c3c;"></div></div>
      <p id="bossMsg">é€šé›»æˆåŠŸï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸï¼</p>
    </div>
  </div>

<script>
let bossHP = 100, playerHP = 100, roundNum = 1, switchOn = false;
let selected = null, connections = [], state = 'title';

/* --- è¡çªåˆ¤å®šç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --- */
function isOverlapping(rect1, rect2, margin) {
  return !(rect1.right < rect2.left - margin || 
           rect1.left > rect2.right + margin || 
           rect1.bottom < rect2.top - margin || 
           rect1.top > rect2.bottom + margin);
}

/* --- é‡ãªã‚Šé˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯ (ä¿®æ­£ç‰ˆ) --- */
function relocateDevices() {
  const board = document.getElementById('board');
  const boardRect = board.getBoundingClientRect();
  const devices = Array.from(document.querySelectorAll('.device'));
  const margin = 25; // ãƒ‡ãƒã‚¤ã‚¹é–“ã®ä½™ç™½ã‚’åºƒã‚ã«è¨­å®š

  // 1. é…ç½®æ¸ˆã¿ã®çŸ©å½¢ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
  const
