<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電気工事士の試練 - 神仕様版</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #2d2d2d;
            --accent-color: #00ffcc;
            --danger-color: #ff4444;
            --text-color: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Meiryo, sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ヘッダー・ステータス */
        #status-bar {
            background: #000;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-color);
        }

        .hp-bar-container {
            width: 200px;
            height: 20px;
            background: #444;
            border: 1px solid #fff;
        }

        #hp-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #00ff00);
            transition: width 0.3s ease;
        }

        /* ゲームエリア */
        #game-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            background: var(--panel-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: crosshair;
        }

        /* クイズ・オーバーレイ */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .quiz-card {
            background: var(--panel-color);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid var(--accent-color);
            max-width: 500px;
            text-align: center;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #444;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        .option-btn:hover { background: var(--accent-color); color: black; }

        /* UIボタン */
        #ui-layer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        button.main-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: 0.2s;
        }

        #set-btn { background: var(--accent-color); color: #000; }
        #reset-btn { background: var(--danger-color); color: #fff; }

        /* メッセージ */
        #msg-log {
            position: absolute;
            top: 80px;
            left: 20px;
            color: var(--accent-color);
            font-family: monospace;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="status-bar">
    <div>称号: <span id="rank-display">見習い</span></div>
    <div style="display: flex; align-items: center; gap: 10px;">
        HP: <div class="hp-bar-container"><div id="hp-fill"></div></div>
    </div>
    <div>WORLD: <span id="world-display">1</span></div>
</div>

<div id="game-container">
    <canvas id="circuitCanvas"></canvas>
    <div id="msg-log"></div>
    
    <div id="overlay">
        <div id="quiz-container" class="quiz-card">
            <h2 id="quiz-q">問題</h2>
            <div id="quiz-options"></div>
        </div>
        <div id="result-container" class="quiz-card" style="display:none;">
            <h1 id="result-title">SUCCESS</h1>
            <p id="result-msg"></p>
            <button class="option-btn" onclick="nextPhase()">次へ</button>
        </div>
    </div>

    <div id="ui-layer">
        <button id="set-btn" class="main-btn">点灯試験 (SET)</button>
        <button id="reset-btn" class="main-btn">配線解除</button>
    </div>
</div>

<script>
/**
 * 神仕様：定数・データ定義
 */
const CONFIG = {
    HP_MAX: 100,
    WORLD_DATA: {
        1: {
            title: "基本の点灯",
            quiz: [
                { q: "電圧の単位は？", a: ["V", "A", "Ω", "W"], correct: 0 },
                { q: "接地線の基本色は？", a: ["赤", "白", "緑", "黒"], correct: 2 }
            ],
            nodes: [
                { id: 'src_L', x: 400, y: 50, label: 'L', type: 'source' },
                { id: 'src_N', x: 500, y: 50, label: 'N', type: 'neutral' },
                { id: 'sw1_0', x: 450, y: 300, label: '0', type: 'sw', swId: 'sw1' },
                { id: 'sw1_1', x: 450, y: 350, label: '1', type: 'sw', swId: 'sw1' },
                { id: 'lamp_L', x: 700, y: 200, label: 'L', type: 'load' },
                { id: 'lamp_N', x: 750, y: 200, label: 'N', type: 'load' }
            ],
            switches: { sw1: { type: '1way', state: 0, internal: [[0,1]] } }
        },
        2: {
            title: "三路の迷宮",
            quiz: [
                { q: "三路スイッチの共通端子番号は？", a: ["1", "3", "0", "E"], correct: 2 },
                { q: "三路スイッチの図記号は？", a: ["S", "3", "S3", "2P"], correct: 2 }
            ],
            nodes: [
                { id: 'src_L', x: 100, y: 50, label: 'L', type: 'source' },
                { id: 'src_N', x: 150, y: 50, label: 'N', type: 'neutral' },
                // 左三路：左に0
                { id: 'swA_0', x: 150, y: 400, label: '0', type: 'sw', swId: 'swA' },
                { id: 'swA_1', x: 250, y: 380, label: '1', type: 'sw', swId: 'swA' },
                { id: 'swA_3', x: 250, y: 420, label: '3', type: 'sw', swId: 'swA' },
                // 右三路：右に0
                { id: 'swB_0', x: 750, y: 400, label: '0', type: 'sw', swId: 'swB' },
                { id: 'swB_1', x: 650, y: 380, label: '1', type: 'sw', swId: 'swB' },
                { id: 'swB_3', x: 650, y: 420, label: '3', type: 'sw', swId: 'swB' },
                // 負荷
                { id: 'lamp_L', x: 450, y: 150, label: 'L', type: 'load' },
                { id: 'lamp_N', x: 500, y: 150, label: 'N', type: 'load' }
            ],
            switches: { 
                swA: { type: '3way', state: 0, pos: {x:150, y:350} }, 
                swB: { type: '3way', state: 0, pos: {x:650, y:350} } 
            }
        }
    }
};

/**
 * ゲームエンジン
 */
class GameEngine {
    constructor() {
        this.canvas = document.getElementById('circuitCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.currentWorld = 1;
        this.hp = CONFIG.HP_MAX;
        this.lines = [];
        this.nodes = [];
        this.switches = {};
        this.selectedNode = null;
        this.phase = 'quiz'; // quiz -> wiring -> boss
        this.isLampOn = false;

        this.initCanvas();
        this.loadWorld(1);
        this.bindEvents();
        this.render();
    }

    initCanvas() {
        this.canvas.width = 900;
        this.canvas.height = 550;
    }

    loadWorld(wId) {
        const data = CONFIG.WORLD_DATA[wId];
        this.nodes = data.nodes;
        this.switches = JSON.parse(JSON.stringify(data.switches)); // 深いコピー
        this.lines = [];
        this.phase = 'quiz';
        this.showQuiz();
        document.getElementById('world-display').innerText = wId;
    }

    // クイズ制御
    showQuiz() {
        const data = CONFIG.WORLD_DATA[this.currentWorld];
        const quiz = data.quiz[0]; // 簡易化のため1問
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('quiz-container').style.display = 'block';
        document.getElementById('result-container').style.display = 'none';
        
        document.getElementById('quiz-q').innerText = quiz.q;
        const optCont = document.getElementById('quiz-options');
        optCont.innerHTML = '';
        quiz.a.forEach((txt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = txt;
            btn.onclick = () => this.handleQuiz(i === quiz.correct);
            optCont.appendChild(btn);
        });
    }

    handleQuiz(isCorrect) {
        if (!isCorrect) {
            this.updateHP(-20);
            this.log("知識不足だ！HPダメージ！");
        } else {
            this.log("正解。施工を開始せよ。");
        }
        document.getElementById('overlay').style.display = 'none';
        this.phase = 'wiring';
    }

    updateHP(val) {
        this.hp = Math.max(0, Math.min(CONFIG.HP_MAX, this.hp + val));
        document.getElementById('hp-fill').style.width = this.hp + '%';
        if (this.hp <= 0) {
            alert("感電負傷... 現場を離脱します。");
            location.reload();
        }
    }

    log(msg) {
        const log = document.getElementById('msg-log');
        log.innerHTML = `> ${msg}<br>` + log.innerHTML;
    }

    // 回路計算エンジン (BFS)
    checkCircuit() {
        // 現在のスイッチ内部結線を含めた全エッジを作成
        const edges = [...this.lines];
        for (let sId in this.switches) {
            const sw = this.switches[sId];
            if (sw.type === '3way') {
                const target = sw.state === 0 ? '1' : '3';
                edges.push({ from: sId+'_0', to: sId+'_'+target });
            } else {
                if (sw.state === 1) edges.push({ from: sId+'_0', to: sId+'_1' });
            }
        }

        const getConnected = (startNode) => {
            const visited = new Set();
            const queue = [startNode];
            while (queue.length > 0) {
                const curr = queue.shift();
                if (!visited.has(curr)) {
                    visited.add(curr);
                    edges.forEach(e => {
                        if (e.from === curr) queue.push(e.to);
                        if (e.to === curr) queue.push(e.from);
                    });
                }
            }
            return visited;
        };

        const energized = getConnected('src_L');
        const grounded = getConnected('src_N');

        // ショート判定
        if (energized.has('src_N')) {
            this.updateHP(-50);
            this.log("！！短絡（ショート）発生！！");
            return false;
        }

        // ランプ点灯判定
        this.isLampOn = energized.has('lamp_L') && grounded.has('lamp_N');
        return this.isLampOn;
    }

    // 描画
    render() {
        const ctx = this.ctx;
        ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // 背景グリッド
        ctx.strokeStyle = '#333';
        for(let i=0; i<900; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,550); ctx.stroke(); }

        // 線を描画
        this.lines.forEach(l => {
            const n1 = this.nodes.find(n => n.id === l.from);
            const n2 = this.nodes.find(n => n.id === l.to);
            ctx.beginPath();
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#fff';
            ctx.moveTo(n1.x, n1.y);
            ctx.lineTo(n2.x, n2.y);
            ctx.stroke();
        });

        // ノードを描画
        this.nodes.forEach(n => {
            ctx.beginPath();
            ctx.arc(n.x, n.y, 10, 0, Math.PI*2);
            ctx.fillStyle = (this.selectedNode === n) ? varColor('--accent-color') : '#888';
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.fillText(n.label, n.x - 5, n.y - 15);
        });

        // スイッチ（プロ仕様外観）
        for (let sId in this.switches) {
            const sw = this.switches[sId];
            const nodes = this.nodes.filter(n => n.swId === sId);
            if (nodes.length > 0) {
                ctx.strokeStyle = varColor('--accent-color');
                ctx.lineWidth = 1;
                ctx.strokeRect(nodes[0].x - 20, nodes[0].y - 30, 120, 80);
                // 内部導通のデバッグ表示（プロ仕様）
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                const n0 = nodes.find(n => n.id.endsWith('_0'));
                const target = sw.state === 0 ? nodes.find(n => n.id.endsWith('_1')) : nodes.find(n => n.id.endsWith('_3'));
                if (n0 && target) {
                    ctx.moveTo(n0.x, n0.y); ctx.lineTo(target.x, target.y);
                    ctx.strokeStyle = 'orange';
                    ctx.stroke();
                }
                ctx.setLineDash([]);
            }
        }

        // ランプ
        ctx.beginPath();
        ctx.arc(725, 180, 30, 0, Math.PI*2);
        ctx.fillStyle = this.isLampOn ? 'yellow' : '#333';
        ctx.shadowBlur = this.isLampOn ? 20 : 0;
        ctx.shadowColor = 'yellow';
        ctx.fill();
        ctx.shadowBlur = 0;

        requestAnimationFrame(() => this.render());
    }

    bindEvents() {
        this.canvas.onclick = (e) => {
            const rect = this.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // ノードクリック
            const hit = this.nodes.find(n => Math.hypot(n.x - x, n.y - y) < 15);
            if (hit) {
                if (!this.selectedNode) {
                    this.selectedNode = hit;
                } else {
                    if (this.selectedNode !== hit) {
                        this.lines.push({ from: this.selectedNode.id, to: hit.id });
                    }
                    this.selectedNode = null;
                }
                return;
            }

            // スイッチ切り替え
            for (let sId in this.switches) {
                const sw = this.switches[sId];
                // スイッチ領域の適当なクリック判定
                const n0 = this.nodes.find(n => n.id === sId + '_0');
                if (Math.hypot(n0.x - x, n0.y - y) < 50) {
                    sw.state = sw.state === 0 ? 1 : 0;
                    this.log("スイッチ切り替え");
                    this.checkCircuit();
                    return;
                }
            }
        };

        document.getElementById('set-btn').onclick = () => {
            const on = this.checkCircuit();
            if (on) {
                this.log("点灯成功！ボスにダメージ！");
                this.winWorld();
            } else {
                this.updateHP(-10);
                this.log("不点灯... 回路が成立していない。");
            }
        };

        document.getElementById('reset-btn').onclick = () => {
            this.lines = [];
            this.isLampOn = false;
            this.log("配線リセット。");
        };
    }

    winWorld() {
        if (this.currentWorld === 1) {
            alert("World 1 クリア！ 称号：一般職へ昇進！");
            this.currentWorld = 2;
            document.getElementById('rank-display').innerText = "一般職";
            this.loadWorld(2);
        } else {
            alert("全工程終了！ あなたは『神施工』の領域に達しました。");
        }
    }
}

// ヘルパー
function varColor(name) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

const engine = new GameEngine();
</script>
</body>
</html>
