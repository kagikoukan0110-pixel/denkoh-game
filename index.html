<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>電工パズル</title>

<style>
body {
  text-align: center;
  font-family: sans-serif;
  background: #f0f0f0;
  margin: 0;
  overflow: hidden;
}

#game {
  width: 320px;
  height: 320px;
  margin: 20px auto;
  background: white;
  border: 2px solid black;
  position: relative;
  touch-action: none;
}

.point {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  position: absolute;
}

#start { top: 20px; left: 20px; background: green; }
#goal { bottom: 20px; right: 20px; background: red; }

.line {
  position: absolute;
  background: black;
  height: 4px;
}

#score {
  font-size: 18px;
  margin-top: 10px;
}
</style>
</head>

<body>

<h2>⚡ 電工パズル - ステージ1</h2>
<p>分電盤からエアコン位置まで配線せよ</p>

<div id="game">
  <div id="start" class="point"></div>
  <div id="goal" class="point"></div>
</div>

<div id="score">スコア: -</div>
<button onclick="clearLines()">やり直す</button>

<script>

let game = document.getElementById("game");
let goal = document.getElementById("goal");
let scoreDisplay = document.getElementById("score");

let drawing = false;
let lastX, lastY;
let cleared = false;
let totalLength = 0;

const BASE_SCORE = 10000;

game.addEventListener("touchstart", startDraw);
game.addEventListener("mousedown", startDraw);

game.addEventListener("touchmove", draw);
game.addEventListener("mousemove", draw);

game.addEventListener("touchend", stopDraw);
game.addEventListener("mouseup", stopDraw);

function getPos(e) {
  let rect = game.getBoundingClientRect();

  if (e.touches) {
    return {
      x: e.touches[0].clientX - rect.left,
      y: e.touches[0].clientY - rect.top
    };
  } else {
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    };
  }
}

function startDraw(e) {
  drawing = true;
  let pos = getPos(e);
  lastX = pos.x;
  lastY = pos.y;
}

function draw(e) {
  if (!drawing) return;
  e.preventDefault();

  let pos = getPos(e);

  let segmentLength = Math.hypot(pos.x - lastX, pos.y - lastY);
  totalLength += segmentLength;

  let line = document.createElement("div");
  line.className = "line";
  line.style.left = lastX + "px";
  line.style.top = lastY + "px";
  line.style.width = segmentLength + "px";
  line.style.transformOrigin = "0 0";
  line.style.transform =
    "rotate(" + Math.atan2(pos.y - lastY, pos.x - lastX) + "rad)";
  game.appendChild(line);

  // ゴール判定
  let goalX = goal.offsetLeft + 10;
  let goalY = goal.offsetTop + 10;

  if (Math.hypot(pos.x - goalX, pos.y - goalY) < 20 && !cleared) {
    cleared = true;

    let score = Math.max(0, Math.floor(BASE_SCORE - totalLength * 5));
    scoreDisplay.innerText = "スコア: " + score;

    setTimeout(() => {
      alert("⚡ 施工完了！\nスコア: " + score);
    }, 100);
  }

  lastX = pos.x;
  lastY = pos.y;
}

function stopDraw() {
  drawing = false;
}

function clearLines() {
  document.querySelectorAll(".line").forEach(l => l.remove());
  cleared = false;
  totalLength = 0;
  scoreDisplay.innerText = "スコア: -";
}

</script>

</body>
</html>
