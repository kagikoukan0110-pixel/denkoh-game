<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¿ºã‚‰ã®é›»å·¥ Î² - Final Build</title>
<style>
:root{
  --bg:#000;
  --panel:#e6e6e6;
  --term-bg:#222;
  --wire-black:#1a1a1a;
  --wire-white:#ffffff;
  --wire-outline:rgba(255,255,255,0.3);
  --device-w:100px;
  --device-h:130px;
  --lamp-glow: rgba(255,220,80,0.95);
}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:sans-serif;overflow:hidden;}
#wireLayer{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:3000}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;height:60px;box-sizing:border-box;}
.title{font-size:20px;font-weight:700}
.bar{width:180px;height:12px;background:#222;border-radius:12px;overflow:hidden}
.player{height:100%;width:100%;background:#34d058;transition:width 0.3s;}

/* devices */
.device{
  position:absolute;
  width:var(--device-w);
  min-height:var(--device-h);
  padding:8px;
  background:var(--panel);
  border-radius:12px;
  color:#000;
  box-shadow:0 8px 20px rgba(0,0,0,0.5);
  transform:translate(-50%,-50%);
  text-align:center;
  z-index:60;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.device h3{margin:4px 0;font-size:12px}
.terminal{display:inline-flex;justify-content:center;align-items:center;width:30px;height:30px;margin:3px;background:var(--term-bg);color:#fff;border-radius:50%;font-size:11px;cursor:pointer;user-select:none}
.selected{outline:3px solid #ffd800; box-shadow:0 0 15px #ffd800}

/* Lamp Logic */
.device.lit { background: #fff9c4 !important; box-shadow: 0 0 40px var(--lamp-glow); }
.device.lit .bulb-shape { fill: #ffd200 !important; filter: drop-shadow(0 0 10px #ff0); }

/* Junction Box (Fixed in center) */
#junction{ z-index:70; width:130px; min-height:100px; background:#d6d6d6; }
.jb-dots{display:flex; flex-wrap:wrap; justify-content:center; gap:6px; margin-top:8px;}
.jb-term{width:20px; height:20px; border-radius:50%; background:#222; cursor:pointer;}

/* Controls */
.controls{height:160px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:rgba(20,20,20,0.9);}
button{padding:12px 24px; border-radius:20px; border:none; font-weight:bold; cursor:pointer;}
#setBtn{background:#ffd000; color:#000; font-size:18px;}
.small-btn{background:#444; color:#fff; padding:8px 16px;}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9500;}
.modal-backdrop.show{display:flex}

#bossScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9200; background:rgba(0,0,0,0.8);}
.boss-card{width:80%; background:#111; padding:20px; border-radius:15px; border:2px solid #e74c3c; text-align:center;}

/* Wires - Visibility Fix */
.wire-line { stroke-linecap: round; transition: stroke-dashoffset 0.5s; }
.wire-black { stroke: var(--wire-black); filter: drop-shadow(0 0 1px #fff) drop-shadow(0 0 2px rgba(255,255,255,0.2)); }
.wire-white { stroke: var(--wire-white); filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); }

</style>
</head>
<body>
  <svg id="wireLayer" xmlns="http://www.w3.org/2000/svg"></svg>

  <div class="header">
    <div class="title">ä¿ºã‚‰ã®é›»å·¥ Î²</div>
    <div style="display:flex; align-items:center; gap:10px;">
      <span>HP</span>
      <div class="bar"><div id="playerHP" class="player"></div></div>
    </div>
    <div>Round: <span id="roundLabel">1</span></div>
  </div>

  <div id="board" style="position:relative; width:100%; height:calc(100vh - 220px);">
    <div id="junction" class="device">
      <h3>Joint Box</h3>
      <div class="jb-dots">
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
      </div>
    </div>

    <div class="device" id="power">
      <h3>é›»æº(100V)</h3>
      <div style="font-size:30px">âš¡</div>
      <div class="terminal" data-id="power-L">L</div>
      <div class="terminal" data-id="power-N">N</div>
    </div>

    <div class="device" id="switch">
      <h3>ç‰‡åˆ‡SW</h3>
      <div style="font-size:30px">ğŸ”˜</div>
      <div class="terminal" data-id="switch-IN">IN</div>
      <div class="terminal" data-id="switch-OUT">OUT</div>
      <div id="switchState" style="font-size:10px">OFF</div>
    </div>

    <div id="lampsContainer"></div>
  </div>

  <div class="controls">
    <div style="display:flex; gap:10px;">
      <button id="switchBtn" class="small-btn">SWITCH</button>
      <button id="setBtn">SET (é€šé›»ç¢ºèª)</button>
      <button id="resetWires" class="small-btn">Reset</button>
    </div>
    <div style="font-size:12px; color:#aaa;">Lç«¯å­ï¼é»’ç·š / Nç«¯å­ï¼ç™½ç·š ã¨ã—ã¦é…ç·šã›ã‚ˆ</div>
  </div>

  <div id="titleScreen" class="modal-backdrop show">
    <h1 style="color:#ffd000; font-size:40px;">WORLD1</h1>
    <p>ãƒ‡ãƒã‚¤ã‚¹ãŒé‡ãªã‚‰ãªã„æ–°è¨­è¨ˆãƒ¢ãƒ‡ãƒ«</p>
    <button onclick="startGame()" style="background:#ffd000; color:#000; padding:15px 40px; font-size:20px;">ç¾å ´ã¸å…¥ã‚‹</button>
  </div>

  <div id="bossScreen">
    <div class="boss-card">
      <h2 id="bossMsg">é€šé›»æˆåŠŸï¼</h2>
      <div class="bar" style="width:100%; margin:15px 0;"><div id="bossHP" class="player" style="background:#e74c3c;"></div></div>
      <p>æ±šã­ãˆå¤§å·¥ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸï¼</p>
    </div>
  </div>

<script>
let bossHP = 100, playerHP = 100, roundNum = 1, switchOn = false;
let selected = null, connections = [], state = 'title';

/* --- é‡ãªã‚Šé˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯ --- */
function relocateDevices() {
  const board = document.getElementById('board');
  const boardRect = board.getBoundingClientRect();
  const devices = Array.from(document.querySelectorAll('.device'));
  const margin = 20; // ãƒ‡ãƒã‚¤ã‚¹é–“ã®æœ€ä½ä½™ç™½

  // 1. ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ä¸­å¤®ã«å›ºå®š
  const jb = document.getElementById('junction');
  jb.style.left = "50%";
  jb.style.top = "50%";

  const placedRects = [];
  // ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ã®é ˜åŸŸã‚’æœ€åˆã«ç™»éŒ²
  placedRects.push(jb.getBoundingClientRect());

  devices.forEach(dev => {
    if (dev.id === 'junction') return;

    let x, y, rect, overlap;
    let attempts = 0;

    do {
      overlap = false;
      // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‚’ç”Ÿæˆ (ç«¯ã«ã‚ˆã‚Šã™ããªã„ã‚ˆã†ã«)
      x = margin + Math.random() * (boardRect.width - 200) + 100;
      y = margin + Math.random() * (boardRect.height - 200) + 100;

      dev.style.left = x + "px";
      dev.style.top = y + "px";
      rect = dev.getBoundingClientRect();

      // æ—¢å­˜ã®ãƒ‡ãƒã‚¤ã‚¹ã¨é‡ãªã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
      for (let r of placedRects) {
        if (!(rect.right < r.left - margin || 
              rect.left > r.right + margin || 
              rect.bottom < r.top - margin || 
              rect.top > r.bottom + margin)) {
          overlap = true;
          break;
        }
      }
      attempts++;
    } while (overlap && attempts < 100);

    placedRects.push(rect);
  });
  // é…ç·šã‚’æãç›´ã—
  redrawWires();
}

/* --- é…ç·šãƒ­ã‚¸ãƒƒã‚¯ (è‰²åˆ†ã‘å¯¾å¿œ) --- */
function getWireColor(idA, idB) {
  // Lã‚’å«ã‚€ç«¯å­ãªã‚‰é»’ã€Nã‚’å«ã‚€ç«¯å­ãªã‚‰ç™½
  if (idA.includes('-L') || idB.includes('-L') || idA.includes('IN') || idA.includes('OUT')) {
    return 'black';
  }
  return 'white';
}

function drawWire(elA, elB, idA, idB) {
  const svg = document.getElementById('wireLayer');
  const rA = elA.getBoundingClientRect();
  const rB = elB.getBoundingClientRect();
  const colorType = getWireColor(idA, idB);

  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", rA.left + rA.width/2);
  line.setAttribute("y1", rA.top + rA.height/2);
  line.setAttribute("x2", rB.left + rB.width/2);
  line.setAttribute("y2", rB.top + rB.height/2);
  line.setAttribute("stroke-width", "6");
  line.classList.add('wire-line');
  line.classList.add(colorType === 'black' ? 'wire-black' : 'wire-white');
  
  svg.appendChild(line);
}

function redrawWires() {
  const svg = document.getElementById('wireLayer');
  svg.innerHTML = '';
  connections.forEach(c => {
    const elA = document.querySelector(`[data-id="${c[0]}"]`) || Array.from(document.querySelectorAll('.jb-term'))[0]; 
    const elB = document.querySelector(`[data-id="${c[1]}"]`) || Array.from(document.querySelectorAll('.jb-term'))[0];
    // â€»å®Ÿéš›ã«ã¯æ¥ç¶šæ™‚ã®è¦ç´ ã‚’ä¿æŒã—ã¦å†è¨ˆç®—ã™ã‚‹ã®ãŒæ­£ç¢ºã§ã™ãŒã€ç°¡æ˜“çš„ã«å†æç”»
  });
  // åº§æ¨™ãŒã‚ºãƒ¬ã‚‹ãŸã‚ã€åŸºæœ¬ã¯ relocation å¾Œã«å…¨æ¶ˆå»â†’å†æ¥ç¶šã‚’æ¨å¥¨
}

/* --- ã‚²ãƒ¼ãƒ é€²è¡Œ --- */
function startGame() {
  document.getElementById('titleScreen').classList.remove('show');
  state = 'play';
  setupRound();
}

function setupRound() {
  const container = document.getElementById('lampsContainer');
  container.innerHTML = '';
  for(let i=1; i<=roundNum; i++){
    const div = document.createElement('div');
    div.className = 'device';
    div.id = `lamp-${i}`;
    div.innerHTML = `<h3>ç…§æ˜-${i}</h3><div style="font-size:30px">ğŸ’¡</div>
      <div class="terminal" data-id="lamp-${i}-L">L</div>
      <div class="terminal" data-id="lamp-${i}-N">N</div>`;
    container.appendChild(div);
  }
  setTimeout(relocateDevices, 50);
  attachEvents();
}

function attachEvents() {
  document.querySelectorAll('.terminal, .jb-term').forEach(t => {
    t.onclick = () => {
      if(state !== 'play') return;
      if(selected === t) { t.classList.remove('selected'); selected = null; return; }
      if(!selected) { selected = t; t.classList.add('selected'); return; }
      
      const idA = selected.dataset.id || 'jb';
      const idB = t.dataset.id || 'jb';
      
      connections.push([idA, idB]);
      drawWire(selected, t, idA, idB);
      
      selected.classList.remove('selected');
      selected = null;
    };
  });
}

document.getElementById('setBtn').onclick = async () => {
  if(!switchOn) return alert("ã‚¹ã‚¤ãƒƒãƒã‚’ONã«ã—ã¦ãã ã•ã„");
  
  const has = (a, b) => connections.some(c => (c[0]===a && c[1]===b) || (c[0]===b && c[1]===a));
  const isCorrect = has('power-L', 'jb') && has('jb', 'switch-IN') && has('switch-OUT', 'jb') && has('power-N', 'jb');

  if(isCorrect) {
    document.querySelectorAll('[id^="lamp-"]').forEach(el => el.classList.add('lit'));
    state = 'boss';
    document.getElementById('bossScreen').style.display = 'flex';
    bossHP -= 50;
    document.getElementById('bossHP').style.width = bossHP + "%";
    
    setTimeout(() => {
      if(bossHP <= 0) {
        alert("WORLD1 ã‚¯ãƒªã‚¢ï¼");
        location.reload();
      } else {
        document.getElementById('bossScreen').style.display = 'none';
        roundNum++;
        connections = [];
        document.getElementById('wireLayer').innerHTML = '';
        document.getElementById('roundLabel').textContent = roundNum;
        state = 'play';
        setupRound();
      }
    }, 2000);
  } else {
    playerHP -= 20;
    document.getElementById('playerHP').style.width = playerHP + "%";
    alert("å›è·¯ãŒä¸å®Œå…¨ã§ã™ï¼HPãƒ€ãƒ¡ãƒ¼ã‚¸ï¼");
  }
};

document.getElementById('switchBtn').onclick = () => {
  switchOn = !switchOn;
  document.getElementById('switchState').textContent = switchOn ? "ON" : "OFF";
  document.getElementById('switch').style.background = switchOn ? "#e7ffec" : "#e6e6e6";
};

document.getElementById('resetWires').onclick = () => {
  connections = [];
  document.getElementById('wireLayer').innerHTML = '';
  document.querySelectorAll('.device').forEach(d => d.classList.remove('lit'));
};

window.onresize = relocateDevices;
</script>
</body>
</html>
