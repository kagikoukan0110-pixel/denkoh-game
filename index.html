<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>‰ø∫„Çâ„ÅÆÈõªÂ∑• - 2026 Ê±∫ÂÆöÁâà</title>
<style>
:root {
  --bg: #000;
  --panel: #e6e6e6;
  --term-bg: #222;
  --wire-black: #1a1a1a;
  --wire-white: #ffffff;
  --wire-outline: rgba(255,255,255,0.5);
  --device-w: 100px;
  --device-h: 130px;
  --lamp-glow: rgba(255,220,80,0.95);
}

html, body { height: 100%; margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; overflow: hidden; touch-action: none; }
#wireLayer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 3000; }

/* „É¨„Ç§„É≥„Éú„ÉºÊºîÂá∫ */
@keyframes rainbow {
  0% { filter: hue-rotate(0deg) brightness(2); }
  50% { filter: hue-rotate(180deg) brightness(3); }
  100% { filter: hue-rotate(360deg) brightness(2); }
}
.flash-rainbow { animation: rainbow 0.1s infinite !important; }

/* „Éò„ÉÉ„ÉÄ„Éº */
.header { display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; height: 60px; background: #111; z-index: 4000; position: relative;}
.hp-bar { width: 150px; height: 15px; background: #333; border-radius: 10px; overflow: hidden; }
.hp-inner { height: 100%; width: 100%; background: #34d058; transition: width 0.3s; }

/* „É¢„Éº„ÉÄ„É´ */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; }
.modal-backdrop.show { display: flex; }
.card { width: 85%; max-width: 450px; background: #1a1a1a; padding: 25px; border-radius: 20px; border: 2px solid #ffd000; text-align: center; }
.q-btn { display: block; width: 100%; margin: 12px 0; padding: 15px; background: #333; color: #fff; border: 1px solid #555; border-radius: 10px; cursor: pointer; font-size: 16px; }

/* ÂÆüÊäÄ„Éá„Éê„Ç§„Çπ */
.device { position: absolute; width: var(--device-w); min-height: var(--device-h); padding: 8px; background: var(--panel); border-radius: 12px; color: #000; box-shadow: 0 8px 20px rgba(0,0,0,0.5); transform: translate(-50%, -50%); text-align: center; z-index: 60; box-sizing: border-box; }
.device h3 { margin: 4px 0; font-size: 11px; }
.terminal { display: inline-flex; justify-content: center; align-items: center; width: 32px; height: 32px; margin: 4px; background: var(--term-bg); color: #fff; border-radius: 50%; font-size: 11px; cursor: pointer; user-select: none; }
.terminal.selected { outline: 4px solid #ffd800; box-shadow: 0 0 15px #ffd800; }
.device.lit { background: #fff9c4 !important; box-shadow: 0 0 50px var(--lamp-glow); transition: 0.3s; }

/* ÈÖçÁ∑ö */
.wire-line { stroke-linecap: round; stroke-width: 6; }
.wire-black { stroke: var(--wire-black); filter: drop-shadow(0 0 2px var(--wire-outline)); }
.wire-white { stroke: var(--wire-white); filter: drop-shadow(0 0 2px rgba(0,0,0,0.8)); }

/* „Éú„Çø„É≥ */
.controls { position: fixed; bottom: 0; width: 100%; height: 120px; background: rgba(10,10,10,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; z-index: 4000; }
.main-btn { padding: 12px 40px; background: #ffd000; color: #000; border: none; border-radius: 30px; font-weight: bold; font-size: 18px; cursor: pointer; }
.sub-btn { background: #444; color: #fff; border: none; padding: 8px 16px; border-radius: 5px; font-size: 12px; }
</style>
</head>
<body>

<svg id="wireLayer" xmlns="http://www.w3.org/2000/svg"></svg>

<div class="header">
  <div>‰ø∫„Çâ„ÅÆÈõªÂ∑• Œ≤ - <span id="roundLabel" style="color:#ffd000;">Â≠¶ÁßëË©¶È®ì</span></div>
  <div style="display:flex; align-items:center; gap:10px;">
    <span>HP</span>
    <div class="hp-bar"><div id="playerHP" class="hp-inner"></div></div>
  </div>
</div>

<div id="board" style="position:relative; width:100%; height:calc(100vh - 180px); display:none;"></div>

<div id="quizScreen" class="modal-backdrop show">
  <div class="card">
    <h1 style="color:#ffd000; margin:0 0 10px 0;">Â≠¶ÁßëË©¶È®ì</h1>
    <p id="qCount">Loading...</p>
    <h3 id="qText">Ë≥™ÂïèË™≠„ÅøËæº„Åø‰∏≠...</h3>
    <div id="answers"></div>
  </div>
</div>

<div id="bossScreen" class="modal-backdrop">
  <div class="card">
    <h2 id="bossMsg">„ÉÄ„É°„Éº„Ç∏ÔºÅ</h2>
    <img src="boss.png.jpg" style="width:100%; border-radius:10px; border:2px solid red;" onerror="this.src='https://placehold.jp/24/cc0000/ffffff/400x300.png?text=BOSSSSSS'">
    <div class="hp-bar" style="width:100%; height:20px; margin-top:15px;">
      <div id="bossHPInner" class="hp-inner" style="background:#e74c3c;"></div>
    </div>
  </div>
</div>

<div class="controls" style="display:none;" id="gameControls">
  <div style="display:flex; gap:10px;">
    <button id="switchToggleBtn" class="sub-btn">SWITCH ON/OFF</button>
    <button id="resetWires" class="sub-btn">RESET</button>
  </div>
  <button id="setBtn" class="main-btn">SET (ÈÄöÈõªÁ¢∫Ë™ç)</button>
</div>

<script>
// --- 1. „Éá„Éº„ÇøÂÆöÁæ© ---
const quizData = [
  {q: "ÈõªÊ∞óÂ∑•‰∫ãÂ£´Ê≥ï„Åß„ÄÅ‰∏ÄËà¨Áî®ÈõªÊ∞óÂ∑•‰ΩúÁâ©„ÅÆÂ∑•‰∫ã„Å´Âæì‰∫ã„Åß„Åç„Çã„ÅÆ„ÅØÔºü", a: ["Á¨¨‰∏ÄÁ®Æ„Åæ„Åü„ÅØÁ¨¨‰∫åÁ®ÆÈõªÊ∞óÂ∑•‰∫ãÂ£´", "18Ê≠≥‰ª•‰∏ä„ÅÆÂÅ•Â∫∑„Å™‰∫∫", "‰∏ÄÁ¥öÂª∫ÁØâÂ£´", "ÈõªÊ∞óÂ±ã„ÅÆÊÅØÂ≠ê"], correct: 0},
  {q: "ÈõªÂúß100V„ÅÆÂõûË∑Ø„ÅßË®±ÂÆπÈõªÊµÅ„ÅåÊúÄÂ§ß„Å™„ÅÆ„ÅØÔºü", a: ["1.6mm", "2.0mm", "2.6mm", "Áõ¥ÂæÑ5.5mm^2"], correct: 3},
  {q: "„É™„É≥„Ç∞„Çπ„É™„Éº„ÉñÔºàEÂΩ¢Ôºâ„ÅÆÂúßÁùÄ„Å´‰ΩøÁî®„Åô„ÇãÂ∑•ÂÖ∑„ÅØÔºü", a: ["ÈõªÂ∑•„Éö„É≥„ÉÅ", "ÂúßÁùÄÁî®„Éó„É©„Ç§„É§", "ÂúßÁùÄ„Éö„É≥„ÉÅÔºàÈªÑËâ≤ÊüÑÔºâ", "ÂúßÁùÄÂ∑•ÂÖ∑ÔºàJISÈÅ©ÂêàÂìÅÔºâ"], correct: 3},
  {q: "ÂõûË∑Ø„ÅÆ„Ç∑„Éß„Éº„ÉàÔºàÁü≠Áµ°Ôºâ„ÅåËµ∑„Åç„ÅüÊôÇ„ÅÆÁèæË±°„ÅØÔºü", a: ["ÈõªÂúß„Åå10ÂÄç„Å´„Å™„Çã", "Â§ß„Åç„Å™ÈõªÊµÅ„ÅåÊµÅ„Çå„Çã", "ÈõªÊµÅ„ÅåÂÆåÂÖ®„Å´Ê≠¢„Åæ„Çã", "ÈõªÊ∞ó„ÅåÈÄÜÊµÅ„Åô„Çã"], correct: 1},
  {q: "Áµ∂Á∏ÅÊäµÊäó„ÅÆÊ∏¨ÂÆö„Å´‰ΩøÁî®„Åô„ÇãÂô®ÂÖ∑„ÅØÔºü", a: ["„ÉÜ„Çπ„Çø", "„ÇØ„É©„É≥„Éó„É°„Éº„Çø", "Áµ∂Á∏ÅÊäµÊäóË®àÔºà„É°„Ç¨„ÉºÔºâ", "Ê§úÈõªÂô®"], correct: 2}
];

let hp = 100, bossHP = 100, round = 1, currentQ = 0, switchOn = false;
let selectedTerm = null, connections = [];

// --- 2. „ÇØ„Ç§„Ç∫„Ç®„É≥„Ç∏„É≥ ---
function initQuiz() {
  if (currentQ >= quizData.length) {
    startRealGame();
    return;
  }
  const q = quizData[currentQ];
  document.getElementById('qText').textContent = q.q;
  document.getElementById('qCount').textContent = `Á¨¨ ${currentQ + 1} / 5 Âïè`;
  
  const ansDiv = document.getElementById('answers');
  ansDiv.innerHTML = '';
  q.a.forEach((text, i) => {
    const b = document.createElement('button');
    b.className = 'q-btn';
    b.textContent = text;
    b.onclick = () => {
      if (i !== q.correct) {
        hp -= 20;
        alert("‰∏çÊ≠£Ëß£ÔºÅ„ÉÄ„É°„Éº„Ç∏ÔºÅ");
        updateHP();
      } else {
        alert("Ê≠£Ëß£ÔºÅ");
      }
      if (hp <= 0) { alert("‰∏çÂêàÊ†º...ÂÜçË©¶È®ì„Åß„Åô„ÄÇ"); location.reload(); }
      currentQ++;
      initQuiz();
    };
    ansDiv.appendChild(b);
  });
}

function updateHP() {
  document.getElementById('playerHP').style.width = hp + "%";
}

// --- 3. ÂÆüÊäÄ„Éë„Éº„Éà ---
function startRealGame() {
  document.getElementById('quizScreen').style.display = 'none';
  document.getElementById('board').style.display = 'block';
  document.getElementById('gameControls').style.display = 'flex';
  setupBoard();
}

function setupBoard() {
  const board = document.getElementById('board');
  board.innerHTML = '';
  connections = [];
  document.getElementById('wireLayer').innerHTML = '';
  document.getElementById('roundLabel').textContent = `ROUND ${round}`;
  
  // „Éá„Éê„Ç§„ÇπÁîüÊàê
  createDev('junction', 'Joint Box', 50, 50, true);
  createDev('power', 'ÈõªÊ∫ê', 15, 15);
  createDev('switch', '„Çπ„Ç§„ÉÉ„ÉÅ', 85, 85);
  for(let i=1; i<=round; i++) {
    createDev(`lamp-${i}`, `ÁÖßÊòé-${i}`, Math.random()*80, Math.random()*80);
  }
  
  relocate();
}

function createDev(id, title, x, y, isJB = false) {
  const div = document.createElement('div');
  div.className = 'device';
  div.id = id;
  let h = `<h3>${title}</h3>`;
  if(isJB) {
    h += `<div style="display:flex; flex-wrap:wrap; justify-content:center;">`;
    for(let i=0; i<6; i++) h += `<div class="terminal" data-id="jb-${i}"></div>`;
    h += `</div>`;
  } else if(id === 'power') {
    h += `<div style="font-size:20px">‚ö°</div><div class="terminal" data-id="p-L">L</div><div class="terminal" data-id="p-N">N</div>`;
  } else if(id === 'switch') {
    h += `<div id="swI" style="font-size:20px">üîò</div><div class="terminal" data-id="s-in">IN</div><div class="terminal" data-id="s-out">OUT</div>`;
  } else {
    h += `<div style="font-size:20px">üí°</div><div class="terminal" data-id="${id}-L">L</div><div class="terminal" data-id="${id}-N">N</div>`;
  }
  div.innerHTML = h;
  document.getElementById('board').appendChild(div);
}

function relocate() {
  const b = document.getElementById('board').getBoundingClientRect();
  const devs = document.querySelectorAll('.device');
  const placed = [];
  const margin = 20;

  devs.forEach(d => {
    let x, y, overlap, attempts = 0;
    const w = 100, h = 130;
    if(d.id === 'junction') {
      x = b.width/2; y = b.height/2;
    } else {
      do {
        overlap = false;
        x = w/2 + Math.random()*(b.width - w);
        y = h/2 + Math.random()*(b.height - h);
        const rect = {l:x-w/2, r:x+w/2, t:y-h/2, b:y+h/2};
        for(let p of placed) {
          if(!(rect.r < p.l-margin || rect.l > p.r+margin || rect.b < p.t-margin || rect.t > p.b+margin)) { overlap = true; break; }
        }
        attempts++;
      } while(overlap && attempts < 100);
    }
    d.style.left = x + "px"; d.style.top = y + "px";
    placed.push({l:x-w/2, r:x+w/2, t:y-h/2, b:y+h/2});
  });
  
  document.querySelectorAll('.terminal').forEach(t => t.onclick = (e) => {
    const el = e.target;
    if(selectedTerm === el) { el.classList.remove('selected'); selectedTerm = null; return; }
    if(!selectedTerm) { selectedTerm = el; el.classList.add('selected'); return; }
    
    connections.push([selectedTerm.dataset.id, el.dataset.id]);
    selectedTerm.classList.remove('selected');
    selectedTerm = null;
    draw();
  });
}

function draw() {
  const svg = document.getElementById('wireLayer');
  svg.innerHTML = '';
  connections.forEach(c => {
    const a = document.querySelector(`[data-id="${c[0]}"]`).getBoundingClientRect();
    const b = document.querySelector(`[data-id="${c[1]}"]`).getBoundingClientRect();
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", a.left+16); line.setAttribute("y1", a.top+16);
    line.setAttribute("x2", b.left+16); line.setAttribute("y2", b.top+16);
    const isBlack = c[0].includes('L') || c[0].includes('s-') || c[1].includes('L') || c[1].includes('s-');
    line.setAttribute("class", `wire-line ${isBlack ? 'wire-black' : 'wire-white'}`);
    svg.appendChild(line);
  });
}

// --- 4. Âà§ÂÆö„Å®ÊºîÂá∫ ---
document.getElementById('setBtn').onclick = () => {
  if(!switchOn) { alert("„Çπ„Ç§„ÉÉ„ÉÅ„ÇíON„Å´ÔºÅ"); return; }
  
  const has = (a, b) => connections.some(c => (c[0].includes(a) && c[1].includes(b)) || (c[0].includes(b) && c[1].includes(a)));
  const ok = has('p-L', 'jb') && has('s-in', 'jb') && has('s-out', 'jb') && has('p-N', 'jb');
  
  if(ok) {
    document.querySelectorAll('[id^="lamp-"]').forEach(l => l.classList.add('lit'));
    document.body.classList.add('flash-rainbow');
    bossHP -= 34;
    document.getElementById('bossHPInner').style.width = bossHP + "%";
    
    setTimeout(() => {
      document.getElementById('bossScreen').classList.add('show');
      setTimeout(() => {
        document.getElementById('bossScreen').classList.remove('show');
        document.body.classList.remove('flash-rainbow');
        if(bossHP <= 0) { alert("ÂÆåÂÖ®ÊíÉÁ†¥ÔºÅ„ÇØ„É™„Ç¢ÔºÅ"); location.reload(); }
        else { round++; setupBoard(); }
      }, 2000);
    }, 500);
  } else {
    hp -= 20; updateHP(); alert("‰∏çÁÇπÁÅØÔºÅHP„ÉÄ„É°„Éº„Ç∏ÔºÅ");
    if(hp <= 0) location.reload();
  }
};

document.getElementById('switchToggleBtn').onclick = () => {
  switchOn = !switchOn;
  document.getElementById('swI').textContent = switchOn ? "üü°" : "üîò";
};

document.getElementById('resetWires').onclick = () => {
  connections = []; draw();
  document.querySelectorAll('.device').forEach(d => d.classList.remove('lit'));
};

// --- 5. Ëµ∑ÂãïÔºÅ ---
updateHP();
window.onload = initQuiz;
</script>
</body>
</html>
