<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>俺らの電工 - WORLD1 (boss flow)</title>
<style>
:root{
  --bg:#000;
  --panel:#ddd;
  --term-bg:#222;
  --wire:#ffd800;
  --wirew:6;
  --device-w:86px;
  --device-padding:8px;
  --boss-hp-color:#e74c3c;
  --boss-hp-back:#332626;
  --accent: #ffd000;
}

/* base */
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
body{padding-bottom:24px;}

/* wire layer (body direct child) */
#wireLayer{
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  pointer-events:none; /* allow clicks through */
  z-index:3000;
}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;box-sizing:border-box}
.title{font-size:20px;margin:0 12px 0 0;font-weight:700}
.hp-area{width:46%;min-width:160px}
.bar{width:100%;height:12px;background:#222;border-radius:12px;overflow:hidden}
.player{height:100%;width:100%;background:#34d058;border-radius:12px;transition:width 200ms linear}

/* main board area */
#board-wrap{position:relative;width:100%;height:calc(100vh - 260px);box-sizing:border-box;padding:8px 16px;overflow:hidden}
#board{position:relative;width:100%;height:100%}

/* device */
.device{position:absolute;width:var(--device-w);padding:var(--device-padding);background:var(--panel);border-radius:10px;color:#000;box-shadow:0 12px 30px rgba(0,0,0,0.45);transform:translate(-50%,-50%);text-align:center;z-index:1000;user-select:none}
.device h3{margin:4px 0 6px 0;font-size:12px}
.terminal{display:inline-flex;justify-content:center;align-items:center;width:26px;height:26px;margin:4px;background:var(--term-bg);color:#fff;border-radius:50%;font-size:13px;cursor:pointer;z-index:1100}
.selected{outline:3px solid var(--accent)}

/* junction */
#junction{left:40%;top:42%;width:120px;padding:10px;background:#d6d6d6;border-radius:14px;z-index:1000;transform:translate(-50%,-50%)}
.jb-dots{display:flex;flex-wrap:wrap;justify-content:center;gap:8px}
.jb-term{width:18px;height:18px;border-radius:50%;background:#222;display:inline-block;cursor:pointer;vertical-align:middle}

/* controls */
.controls{height:210px;padding:12px 18px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;justify-content:flex-start}
button#setBtn{padding:14px 36px;border-radius:26px;border:none;background:var(--accent);color:#000;font-weight:800}
button.small{padding:8px 12px;margin:8px;border-radius:12px;border:none;background:#333;color:#fff}
.switchToggle{margin-left:14px;padding:8px 12px;border-radius:12px;border:none;background:#fff;color:#000;font-weight:600}

/* overlay final clear */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,0.96);display:none;align-items:center;justify-content:center;font-size:56px;z-index:9999;color:var(--accent)}
#overlay.show{display:flex}

/* boss screen */
#bossScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:8000;color:#fff}
#bossPanel{width:86%;max-width:720px;background:#0d0d0d;border-radius:14px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.7);display:flex;gap:18px;align-items:center}
#bossName{font-size:28px;color:#ffd200;margin-right:12px;font-weight:800}
.bossHPwrap{flex:1}
.bossHPback{width:100%;height:18px;background:var(--boss-hp-back);border-radius:12px;overflow:hidden}
.bossHPbar{height:100%;width:100%;background:var(--boss-hp-color);transition:width 500ms linear;border-radius:12px}

/* damage flash & shake */
@keyframes flashRed { 0%{filter:none}50%{filter:drop-shadow(0 0 18px rgba(231,76,60,0.95))}100%{filter:none} }
@keyframes shake { 0%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}100%{transform:translateX(0)} }
.boss-damage{animation: flashRed 300ms ease, shake 420ms ease}

/* version badge & state */
#versionBadge{position:fixed;top:8px;right:8px;color:#ccc;font-size:12px;z-index:5000}
.roundBox{font-size:13px;color:#ccc;margin-left:12px}

/* quiz screen */
#quizScreen{position:fixed;inset:0;background:rgba(0,0,0,0.96);display:flex;align-items:flex-start;justify-content:center;padding-top:36px;z-index:9000;color:#fff;box-sizing:border-box}
.quizCard{width:92%;max-width:720px;background:#0b0b0b;border-radius:12px;padding:18px}
.qTitle{color:var(--accent);font-weight:800;font-size:22px;margin-bottom:12px}
.qItem{background:#222;border-radius:10px;padding:12px;margin:8px 0;cursor:pointer}
.qAction{display:flex;justify-content:flex-end;margin-top:12px}

/* responsive */
@media (max-width:480px){:root{--device-w:74px;} .title{font-size:18px}}
</style>
</head>
<body>
  <!-- wire layer: body direct child -->
  <svg id="wireLayer" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"></svg>

  <div id="versionBadge">version: 2026-02-20T1900</div>

  <div class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="title">俺らの電工 β</div>
      <div class="roundBox">Round: <span id="roundLabel">1</span> / 3</div>
    </div>

    <div class="hp-area">
      <div style="font-size:12px;color:#ccc;margin-bottom:6px;">PLAYER HP</div>
      <div class="bar"><div id="playerHP" class="player" style="width:100%"></div></div>
    </div>

    <div style="text-align:right;font-size:12px;color:#aaa;">
      STATE<br><strong id="stateLabel">quiz</strong>
    </div>
  </div>

  <!-- board -->
  <div id="board-wrap">
    <div id="board">
      <!-- devices -->
      <div class="device" id="power" style="left:12%; top:26%;">
        <h3 style="font-size:12px">電源</h3>
        <div style="text-align:center;">
          <div class="terminal" data-id="power-L">L</div>
          <div class="terminal" data-id="power-N">N</div>
        </div>
      </div>

      <div class="device" id="switch" style="left:78%; top:18%; background:#e7ffec;">
        <h3 style="font-size:12px">片切</h3>
        <div style="text-align:center;">
          <div class="terminal" data-id="switch-IN">IN</div>
          <div class="terminal" data-id="switch-OUT">OUT</div>
        </div>
        <div id="switchState" style="color:#333;margin-top:6px;font-size:11px;">Switch: OFF</div>
      </div>

      <div id="junction" class="device" style="left:40%; top:42%;">
        <h3 style="font-size:12px">Joint Box</h3>
        <div class="jb-dots" style="margin-top:6px;">
          <div class="jb-term" data-id="jb"></div>
          <div class="jb-term" data-id="jb"></div>
          <div class="jb-term" data-id="jb"></div>
          <div class="jb-term" data-id="jb"></div>
        </div>
        <div style="font-size:11px;color:#666;margin-top:6px;">端子は導通のみ。どの端子でもOK。</div>
      </div>

      <div class="device" id="lamp" style="left:78%; top:66%;">
        <h3 style="font-size:12px">ランプ</h3>
        <div style="text-align:center;">
          <div class="terminal" data-id="lamp-L">L</div>
          <div class="terminal" data-id="lamp-N">N</div>
        </div>
      </div>

      <div class="device" id="spare" style="left:18%; top:68%;">
        <h3 style="font-size:12px">予備</h3>
        <div style="text-align:center;">
          <div class="terminal" data-id="spare-1">•</div>
          <div class="terminal" data-id="spare-2">•</div>
        </div>
      </div>
    </div>
  </div>

  <!-- controls -->
  <div class="controls">
    <div style="display:flex;align-items:center;gap:12px;">
      <button id="setBtn">SET</button>
      <button id="toggleSwitchBtn" class="switchToggle">Toggle Switch</button>
    </div>

    <div style="margin-top:12px;">
      <button id="resetWires" class="small">Reset Wires</button>
      <button id="restart" class="small">Restart</button>
    </div>

    <div class="note">端子クリック → もう一つの端子クリックで配線。配線選択してクリックで削除。</div>
  </div>

  <div id="overlay">WORLD1 CLEAR</div>

  <!-- Boss screen -->
  <div id="bossScreen" aria-hidden="true">
    <div id="bossPanel">
      <div id="bossName">汚ねえ大工</div>
      <div style="width:140px;margin-right:12px;">
        <img id="bossImg" src="boss.png.jpg" alt="boss" style="max-width:140px;border-radius:8px;display:block" />
      </div>
      <div class="bossHPwrap">
        <div style="font-size:12px;color:#ccc;margin-bottom:6px;">BOSS HP</div>
        <div class="bossHPback"><div id="bossHPbar" class="bossHPbar" style="width:100%"></div></div>
      </div>
    </div>
  </div>

  <!-- Quiz screen -->
  <div id="quizScreen" style="display:flex;">
    <div class="quizCard">
      <div class="qTitle">学科問題</div>
      <div style="font-size:16px;margin-bottom:12px;">1. 電気で L は何を表す？</div>
      <div class="qItem" data-answer="0">中性線</div>
      <div class="qItem" data-answer="1">活線(L)</div>
      <div class="qItem" data-answer="2">地線</div>
      <div class="qItem" data-answer="3">照明</div>
      <div class="qAction">
        <button id="quizNext" class="small">回答</button>
      </div>
    </div>
  </div>

<script>
/* ===== state ===== */
let bossHP = 100;
let playerHP = 100;
let roundNum = 1;
let switchOn = false;
let selected = null;
let connections = [];

/* elements */
const board = document.getElementById("board");
const wireLayer = document.getElementById("wireLayer");
const playerBar = document.getElementById("playerHP");
const bossHPbar = document.getElementById("bossHPbar");
const overlay = document.getElementById("overlay");
const bossScreen = document.getElementById("bossScreen");
const setBtn = document.getElementById("setBtn");
const toggleSwitchBtn = document.getElementById("toggleSwitchBtn");
const switchState = document.getElementById("switchState");
const roundLabel = document.getElementById("roundLabel");
const stateLabel = document.getElementById("stateLabel");
const quizScreen = document.getElementById("quizScreen");
const quizNext = document.getElementById("quizNext");

/* ===== SVG sizing & sync ===== */
function resizeSVG(){
  const r = board.getBoundingClientRect();
  // If width/height are zero (not rendered) do nothing
  if (r.width <= 0 || r.height <= 0) return;
  wireLayer.setAttribute("viewBox", `0 0 ${r.width} ${r.height}`);
  // position svg over board
  wireLayer.style.left = r.left + 'px';
  wireLayer.style.top = r.top + 'px';
  wireLayer.style.width = r.width + 'px';
  wireLayer.style.height = r.height + 'px';
}
window.addEventListener("resize", resizeSVG);
window.addEventListener("orientationchange", ()=>setTimeout(resizeSVG,80));
window.addEventListener("scroll", ()=>setTimeout(resizeSVG,80));
window.addEventListener("load", ()=>{ resizeSVG(); setTimeout(resizeSVG,120); });

/* ===== UI updates ===== */
function updateHP(){ playerBar.style.width = playerHP + "%"; }
function updateBossHP(){ bossHPbar.style.width = Math.max(0,bossHP) + "%"; }
function updateRound(){ roundLabel.textContent = roundNum; }

/* Normalize id for JB */
function normalizeId(id, el){
  if(!id && el) id = el.dataset.id;
  if(!id) return id;
  // treat any jb-term or anything inside junction as 'jb'
  if(id === 'jb') return 'jb';
  if(el && el.closest && el.closest('#junction')) return 'jb';
  return id;
}

/* ===== terminal click handling (terminals & jb-term) ===== */
function clearSelection(){
  if(selected && selected.classList) selected.classList.remove('selected');
  selected = null;
}
function initTerminalClicks(){
  // normal terminals
  document.querySelectorAll(".terminal").forEach(t=>{
    t.addEventListener("click", (e)=>{
      onTerminalClick(t);
    });
  });
  // jb-term (black dots)
  document.querySelectorAll(".jb-term").forEach(t=>{
    t.addEventListener("click", (e)=>{
      t.dataset.id = 'jb'; // ensure
      onTerminalClick(t);
    });
  });
}
function onTerminalClick(t){
  // small guard
  if(!t) return;
  // toggle selection
  if(selected === t){ t.classList.remove("selected"); selected = null; return; }
  if(!selected){ selected = t; t.classList.add("selected"); return; }
  if(selected !== t){
    connect(selected,t);
  }
  if(selected) selected.classList.remove("selected");
  selected = null;
}

/* ===== switch toggle button (avoid dblclick mobile issues) ===== */
toggleSwitchBtn.addEventListener("click", ()=>{
  switchOn = !switchOn;
  switchState.textContent = switchOn ? "Switch: ON" : "Switch: OFF";
  // reflect device background
  document.getElementById('switch').style.background = switchOn ? '#e7ffec' : '';
});

/* ===== connect function (store + draw) ===== */
function connect(a,b){
  const idA = normalizeId(a.dataset.id,a);
  const idB = normalizeId(b.dataset.id,b);
  if(!idA || !idB) return;
  if(idA === idB) return;

  // If a connection already exists (either direction) -> remove it
  for(let i=0;i<connections.length;i++){
    const c = connections[i];
    if((c[0]===idA && c[1]===idB) || (c[0]===idB && c[1]===idA)){
      // remove matching SVG line(s)
      const existing = wireLayer.querySelectorAll(`line[data-from="${idA}"][data-to="${idB}"], line[data-from="${idB}"][data-to="${idA}"]`);
      existing.forEach(el=>el.remove());
      connections.splice(i,1);
      return;
    }
  }

  // add to connections model
  connections.push([idA,idB]);

  // compute coordinates relative to board
  const rectA = a.getBoundingClientRect();
  const rectB = b.getBoundingClientRect();
  const boardRect = board.getBoundingClientRect();
  const x1 = (rectA.left - boardRect.left) + rectA.width/2;
  const y1 = (rectA.top - boardRect.top) + rectA.height/2;
  const x2 = (rectB.left - boardRect.left) + rectB.width/2;
  const y2 = (rectB.top - boardRect.top) + rectB.height/2;

  // create line
  const line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1", x1);
  line.setAttribute("y1", y1);
  line.setAttribute("x2", x2);
  line.setAttribute("y2", y2);
  line.setAttribute("stroke", getComputedStyle(document.documentElement).getPropertyValue('--wire') || '#ffd800');
  line.setAttribute("stroke-width", getComputedStyle(document.documentElement).getPropertyValue('--wirew') || 6);
  line.setAttribute("stroke-linecap","round");
  line.setAttribute("stroke-linejoin","round");
  line.setAttribute("vector-effect","non-scaling-stroke");
  line.setAttribute("data-from", idA);
  line.setAttribute("data-to", idB);
  // append first
  wireLayer.appendChild(line);
  // compute length after appended
  let len = 0;
  try{
    len = line.getTotalLength();
  }catch(err){
    // fallback distance
    len = Math.hypot(x2-x1, y2-y1);
  }
  line.style.strokeDasharray = len;
  line.style.strokeDashoffset = 0; // visible immediately when drawn
}

/* helper: model check */
function connHas(a,b){ return connections.some(c => (c[0]===a && c[1]===b) || (c[0]===b && c[1]===a)); }

/* solution check:
   JB normalized: any jb dot -> 'jb'
   required: power-L <-> jb, jb <-> switch-IN, switch-OUT <-> jb, jb <-> lamp-L, power-N <-> jb, jb <-> lamp-N
*/
function checkSolution(){
  // require at least one jb link
  if(!connections.some(c=>c[0]==='jb' || c[1]==='jb')) return false;
  const ok = connHas("power-L","jb") &&
             connHas("jb","switch-IN") &&
             connHas("switch-OUT","jb") &&
             connHas("jb","lamp-L") &&
             connHas("power-N","jb") &&
             connHas("jb","lamp-N");
  return ok;
}

/* animate lines forward (reveal) */
function animateLinesForward(ms){
  return new Promise(res=>{
    const lines = Array.from(wireLayer.querySelectorAll("line"));
    if(lines.length===0){ setTimeout(res, ms); return; }
    lines.forEach(l=>{
      // compute length and animate dashoffset from length->0
      let len = 0;
      try{ len = l.getTotalLength(); } catch(e){ len = 200; }
      l.style.transition = 'none';
      l.style.strokeDasharray = len;
      l.style.strokeDashoffset = len;
      // force reflow
      void l.getBoundingClientRect();
      l.style.transition = `stroke-dashoffset ${ms}ms linear`;
      l.style.strokeDashoffset = 0;
    });
    setTimeout(res, ms + 80);
  });
}

/* boss sequence */
async function doBossSequence(){
  stateLabel.textContent = 'boss';
  // show boss panel
  bossScreen.style.display = 'flex';
  bossScreen.setAttribute('aria-hidden','false');
  await new Promise(r=>setTimeout(r,320));

  const panel = document.getElementById("bossPanel");
  panel.classList.add('boss-damage');
  await new Promise(r=>setTimeout(r,620));
  panel.classList.remove('boss-damage');

  // damage
  const dmg = 40;
  bossHP = Math.max(0, bossHP - dmg);
  updateBossHP();

  // win condition: round >= 3 || bossHP <= 0
  if(bossHP <= 0 || roundNum >= 3){
    await new Promise(r=>setTimeout(r,600));
    bossScreen.style.display = 'none';
    overlay.classList.add('show');
    stateLabel.textContent = 'clear';
    return;
  }

  // not finished: close boss screen, reset wires, next round
  await new Promise(r=>setTimeout(r,700));
  bossScreen.style.display = 'none';
  bossScreen.setAttribute('aria-hidden','true');

  // clear wires
  wireLayer.querySelectorAll("line").forEach(l=>l.remove());
  connections = []; selected = null;
  document.querySelectorAll(".terminal.selected").forEach(t=>t.classList.remove("selected"));

  roundNum++;
  updateRound();

  // randomize positions (avoid overlap)
  randomizeDevicePositions();

  stateLabel.textContent = 'play';
}

/* randomize positions avoiding heavy overlap (simple) */
function randomizeDevicePositions(){
  const devices = Array.from(document.querySelectorAll('.device'));
  const minLeft = 6, maxLeft = 92;
  const minTop = 16, maxTop = 72;
  // attempt placements with retry to reduce overlap
  const placed = [];
  devices.forEach(dev=>{
    let ok = false;
    for(let attempt=0; attempt<40 && !ok; attempt++){
      const l = Math.floor(minLeft + Math.random()*(maxLeft - minLeft));
      const t = Math.floor(minTop + Math.random()*(maxTop - minTop));
      dev.style.left = l + '%';
      dev.style.top = t + '%';
      // check overlap with existing placed
      const r = dev.getBoundingClientRect();
      ok = true;
      for(const p of placed){
        const pr = p.getBoundingClientRect();
        const overlap = !(r.right < pr.left || r.left > pr.right || r.bottom < pr.top || r.top > pr.bottom);
        if(overlap){ ok = false; break; }
      }
      if(ok) placed.push(dev);
    }
  });
  // keep junction roughly central
  const jb = document.getElementById('junction');
  jb.style.left = '40%';
  jb.style.top = '42%';
  setTimeout(resizeSVG,80);
}

/* SET button */
setBtn.addEventListener("click", async ()=>{
  if(stateLabel.textContent === 'quiz') return;
  if(!switchOn){
    alert("スイッチがOFFです。Toggle Switch で ON にしてください。");
    return;
  }
  if(!checkSolution()){
    playerHP = Math.max(0, playerHP - 20);
    updateHP();
    if(playerHP <= 0) alert("PLAYER HP 0 - game over");
    return;
  }
  // correct: animate lines flow, then boss sequence
  await animateLinesForward(1800);
  await doBossSequence();
});

/* reset & restart */
document.getElementById("resetWires").addEventListener("click", ()=>{
  wireLayer.querySelectorAll("line").forEach(l=>l.remove());
  connections = []; selected = null;
  document.querySelectorAll(".terminal.selected").forEach(t=>t.classList.remove("selected"));
});
document.getElementById("restart").addEventListener("click", ()=>{
  playerHP = 100; bossHP = 100; roundNum = 1; updateHP(); updateBossHP(); updateRound();
  overlay.classList.remove("show");
  wireLayer.querySelectorAll("line").forEach(l=>l.remove());
  connections = []; selected = null; switchOn=false; switchState.textContent="Switch: OFF"; stateLabel.textContent="quiz";
  // reset dev positions to defaults
  document.getElementById('power').style.left='12%'; document.getElementById('power').style.top='26%';
  document.getElementById('switch').style.left='78%'; document.getElementById('switch').style.top='18%';
  document.getElementById('junction').style.left='40%'; document.getElementById('junction').style.top='42%';
  document.getElementById('lamp').style.left='78%'; document.getElementById('lamp').style.top='66%';
  document.getElementById('spare').style.left='18%'; document.getElementById('spare').style.top='68%';
  // show quiz again
  quizScreen.style.display = 'flex';
  stateLabel.textContent = 'quiz';
  setTimeout(resizeSVG,60);
});

/* Quiz handling */
let selectedAnswerIdx = null;
document.querySelectorAll('.qItem').forEach(item=>{
  item.addEventListener('click', ()=>{
    document.querySelectorAll('.qItem').forEach(i=>i.style.outline='none');
    item.style.outline = '3px solid rgba(255,208,0,0.35)';
    selectedAnswerIdx = parseInt(item.dataset.answer,10);
  });
});
quizNext.addEventListener('click', ()=>{
  // accept any selection; mark correct only if index 1 (活線)
  if(selectedAnswerIdx === null){ alert('選択してください'); return; }
  // simple scoring: incorrect reduces playerHP a bit
  if(selectedAnswerIdx !== 1) { playerHP = Math.max(0, playerHP - 10); updateHP(); }
  // hide quiz and show play area
  quizScreen.style.display = 'none';
  stateLabel.textContent = 'play';
  // initialize terminals clicks now
  initTerminalClicks();
  // initial svg sizing
  setTimeout(resizeSVG,60);
});

/* initial setup */
updateHP(); updateBossHP(); updateRound();
resizeSVG();
initTerminalClicks();

</script>
</body>
</html>
