<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>俺らの電工 - WORLD1</title>

<style>
/* === 元のCSSそのまま === */
:root{
  --bg:#000;
  --panel:#ddd;
  --term-bg:#222;
  --wire:#ffd800;
  --wirew:4;
  --device-w:86px;
  --device-padding:8px;
  --boss-hp:#e74c3c;
}
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui;}
#wireLayer{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:2000}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
.bar{width:100%;height:12px;background:#222;border-radius:12px;overflow:hidden}
.player{height:100%;width:100%;background:#34d058;border-radius:12px}

/* board */
#board-wrap{position:relative;width:100%;height:calc(100vh - 200px);padding:8px 16px;overflow:hidden}
#board{position:relative;width:100%;height:100%}

/* device */
.device{position:absolute;width:86px;padding:8px;background:#ddd;border-radius:10px;color:#000;
transform:translate(-50%,-50%);text-align:center}
.terminal{display:inline-flex;justify-content:center;align-items:center;width:26px;height:26px;
margin:4px;background:#222;color:#fff;border-radius:50%;cursor:pointer}
.selected{outline:3px solid #ffd800}

/* junction */
#junction{left:38%;top:42%;width:110px;padding:10px;background:#d6d6d6;border-radius:14px;
transform:translate(-50%,-50%)}
.jb-term{width:18px;height:18px;border-radius:50%;background:#222;display:inline-block;cursor:pointer}

/* controls */
.controls{height:140px;padding:12px;display:flex;flex-direction:column;align-items:center}
button{padding:14px 36px;border-radius:26px;border:none;background:#ffd000;font-weight:700}
button.small{padding:8px 12px;margin:8px;border-radius:12px;background:#333;color:#fff}

/* boss screen */
#bossScreen{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:9000;
}
#bossPanel{
  width:90%;
  max-width:500px;
  background:#111;
  padding:20px;
  border-radius:12px;
  text-align:center;
}
#bossHPbar{
  height:16px;
  background:var(--boss-hp);
  width:100%;
  border-radius:8px;
  transition:width .5s;
}
</style>
</head>

<body>

<svg id="wireLayer"></svg>

<div class="header">
  <div>俺らの電工 β</div>
  <div style="width:40%">
    <div class="bar"><div id="playerHP" class="player"></div></div>
  </div>
</div>

<div id="board-wrap">
<div id="board">

<div class="device" id="power" style="left:10%; top:22%;">
  <div class="terminal" data-id="power-L">L</div>
  <div class="terminal" data-id="power-N">N</div>
</div>

<div class="device" id="switch" style="left:80%; top:18%;">
  <div class="terminal" data-id="switch-IN">IN</div>
  <div class="terminal" data-id="switch-OUT">OUT</div>
  <div id="switchState">OFF</div>
</div>

<div id="junction" class="device">
  <div class="jb-term" data-id="jb"></div>
  <div class="jb-term" data-id="jb"></div>
  <div class="jb-term" data-id="jb"></div>
  <div class="jb-term" data-id="jb"></div>
</div>

<div class="device" id="lamp" style="left:78%; top:66%;">
  <div class="terminal" data-id="lamp-L">L</div>
  <div class="terminal" data-id="lamp-N">N</div>
</div>

</div>
</div>

<div class="controls">
  <button id="setBtn">SET</button>
</div>

<!-- BOSS -->
<div id="bossScreen">
  <div id="bossPanel">
    <img src="boss.png.jpg" style="width:120px"><br><br>
    <div style="background:#333;border-radius:8px;">
      <div id="bossHPbar"></div>
    </div>
  </div>
</div>

<script>

/* === あなたの安定版ロジックそのまま === */

let bossHP=100, playerHP=100, switchOn=false, selected=null, connections=[];
const playerBar=document.getElementById("playerHP");
const wireLayer=document.getElementById("wireLayer");
const board=document.getElementById("board");
const switchEl=document.getElementById("switch");
const switchState=document.getElementById("switchState");
const setBtn=document.getElementById("setBtn");
const bossScreen=document.getElementById("bossScreen");
const bossHPbar=document.getElementById("bossHPbar");

function resizeSVG(){
  const r=board.getBoundingClientRect();
  wireLayer.setAttribute("viewBox",`0 0 ${r.width} ${r.height}`);
  wireLayer.style.left=r.left+'px';
  wireLayer.style.top=r.top+'px';
  wireLayer.style.width=r.width+'px';
  wireLayer.style.height=r.height+'px';
}
window.addEventListener("resize",resizeSVG);
window.addEventListener("load",resizeSVG);

function normalizeId(id,el){
  if(!id&&el)id=el.dataset.id;
  if(!id)return id;
  if(id==="jb")return "jb";
  if(el&&el.closest&&el.closest('#junction'))return "jb";
  return id;
}

document.querySelectorAll(".terminal,.jb-term").forEach(t=>{
  t.addEventListener("click",()=>{
    if(t.classList.contains('jb-term'))t.dataset.id='jb';
    if(selected===t){t.classList.remove("selected");selected=null;return;}
    if(!selected){selected=t;t.classList.add("selected");return;}
    connect(selected,t);
    selected.classList.remove("selected");
    selected=null;
  });
});

switchEl.addEventListener("dblclick",()=>{
  switchOn=!switchOn;
  switchState.textContent=switchOn?"ON":"OFF";
});

function connect(a,b){
  const idA=normalizeId(a.dataset.id,a);
  const idB=normalizeId(b.dataset.id,b);
  if(!idA||!idB||idA===idB)return;

  connections.push([idA,idB]);

  const rectA=a.getBoundingClientRect();
  const rectB=b.getBoundingClientRect();
  const boardRect=board.getBoundingClientRect();

  const x1=rectA.left-boardRect.left+rectA.width/2;
  const y1=rectA.top-boardRect.top+rectA.height/2;
  const x2=rectB.left-boardRect.left+rectB.width/2;
  const y2=rectB.top-boardRect.top+rectB.height/2;

  const line=document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1",x1);
  line.setAttribute("y1",y1);
  line.setAttribute("x2",x2);
  line.setAttribute("y2",y2);
  line.setAttribute("stroke","#ffd800");
  line.setAttribute("stroke-width","4");
  line.setAttribute("stroke-linecap","round");

  wireLayer.appendChild(line);
}

function connHas(a,b){
  return connections.some(c=>(c[0]===a&&c[1]===b)||(c[0]===b&&c[1]===a));
}

function checkSolution(){
  return connHas("power-L","jb") &&
         connHas("jb","switch-IN") &&
         connHas("switch-OUT","jb") &&
         connHas("jb","lamp-L") &&
         connHas("power-N","jb") &&
         connHas("jb","lamp-N");
}

async function doBossSequence(){
  bossScreen.style.display="flex";
  await new Promise(r=>setTimeout(r,800));
  bossHP-=50;
  bossHPbar.style.width=bossHP+"%";
  await new Promise(r=>setTimeout(r,1000));
  bossScreen.style.display="none";
}

setBtn.addEventListener("click",async()=>{
  if(!switchOn){alert("スイッチONにしてください");return;}
  if(!checkSolution()){alert("配線ミス");return;}

  await doBossSequence();   // ← ここだけ追加
});

resizeSVG();
</script>
</body>
</html>
