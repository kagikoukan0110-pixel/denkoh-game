<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>俺らの電工 - WORLD1</title>
<style>
/* -------- 基本スタイル（ここに全部まとめてます） -------- */
:root{
  --bg:#000;
  --accent:#ffd400;
  --card:#e6e6e6;
  --text:#fff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;}
body{
  font-family: "Helvetica Neue", Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ヘッダー */
.topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px}
.title{font-weight:800;font-size:22px}
.title small{font-weight:300;font-size:12px;margin-left:6px;opacity:.9}

.hp-compact{width:50%;max-width:360px}
.hp-compact .label{font-size:12px;opacity:.8}
.bar{width:100%;height:18px;background:#333;border-radius:12px;margin:8px 0}
.boss{height:100%;width:100%;background:crimson;border-radius:12px}
.player{height:100%;width:70%;background:#44d44a;border-radius:12px}

/* 全体レイアウト */
.main-area{padding:0 14px 60px}
#game-area{display:flex;gap:18px;align-items:flex-start;justify-content:center;flex-wrap:wrap}

/* ボスパネル */
#bossPanel{
  width:360px;
  background:rgba(255,255,255,0.03);
  border-radius:12px;
  padding:14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.6);
}
.boss-title{color:var(--accent);font-weight:800;font-size:20px;margin-bottom:6px}

/* BOARD: 作業領域を広めに */
#board{
  position:relative;
  width:560px;
  height:65vh; /* 広め */
  min-height:420px;
  background:transparent;
  overflow:hidden;
  border-radius:6px;
}

/* SVG 層（配線） - board の直下に置く */
#wireLayer{
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  pointer-events:none; /* クリックは下の要素へ */
  z-index:50; /* 大きくして配線が見えるように */
}

/* device 共通 */
.device{
  position:absolute;
  width:140px;
  padding:8px;
  background:#e6e6e6;
  border-radius:12px;
  color:black;
  z-index:20; /* デバイスは wireLayerより下 */
  box-shadow: 0 6px 12px rgba(0,0,0,0.45);
}
.device h3{margin:4px 0;font-size:14px;text-align:center}
.term-row{display:flex;justify-content:center;gap:10px;margin-top:8px}
.terminal{
  width:30px;height:30px;border-radius:50%;
  background:#222;color:white;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:12px;user-select:none;border:3px solid transparent;
}
.terminal.selected{border-color:yellow}
.jb-grid{display:grid;grid-template-columns:repeat(2,28px);gap:12px;justify-content:center;margin-top:8px}
.jb-dot{width:28px;height:28px;border-radius:50%;background:#222;cursor:pointer}

/* 各デバイス初期位置（必要なら調整） */
#power{ left:8%; top:60%;}
#junction{ left:40%; top:45%; transform:translate(-50%,-50%); width:180px; padding:16px; z-index:20 }
#switch{ right:12%; top:18%;}
#lamp{ right:8%; bottom:18%;}

/* スイッチの状態表示 */
.switch-state{font-size:12px;text-align:center;margin-top:6px;color:#fff;opacity:.9}

/* コントロールパネル */
.controls{ width:200px;padding:14px;background:rgba(255,255,255,0.02);border-radius:12px;color:#ddd;z-index:20 }
.controls .btn{display:block;width:100%;padding:10px;margin-top:10px;border-radius:10px;border:none;background:#2b2b2b;color:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#000;font-weight:700}

/* overlay CLEAR */
#overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.95);
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  z-index:9999;text-align:center; padding:16px;
}
#overlay h1{color:var(--accent);font-size:44px;margin:8px}
#overlay .sub{color:#cfcfcf;margin-top:8px}
.hidden{display:none !important;}

/* レスポンシブ */
@media (max-width:900px){
  #board{ width:92vw; height:64vh; min-height:380px }
  #bossPanel{ width:92vw; margin-bottom:12px }
  .controls{ width:92vw; margin-top:12px }
}
</style>
</head>
<body>

<header class="topbar">
  <div class="title">俺らの電工 <small>β</small></div>
  <div class="hp-compact">
    <div class="label">PLAYER HP</div>
    <div class="bar"><div id="playerHP" class="player"></div></div>
  </div>
</header>

<main class="main-area">

  <section id="game-area">

    <div id="bossPanel">
      <div class="boss-title">汚ねえ大工</div>
      <div class="label">BOSS HP</div>
      <div class="bar"><div id="bossHP" class="boss"></div></div>
    </div>

    <div id="board">
      <!-- ここに svg を置く（配線用） -->
      <svg id="wireLayer" preserveAspectRatio="none"></svg>

      <!-- 電源 -->
      <div class="device" id="power">
        <h3>電源</h3>
        <div class="term-row">
          <div class="terminal" data-id="power-L">L</div>
          <div class="terminal" data-id="power-N">N</div>
        </div>
      </div>

      <!-- スイッチ -->
      <div class="device" id="switch">
        <h3>片切</h3>
        <div class="term-row">
          <div class="terminal" data-id="switch-IN">IN</div>
          <div class="terminal" data-id="switch-OUT">OUT</div>
        </div>
        <div class="switch-state" id="switchState">Switch: OFF</div>
      </div>

      <!-- ランプ -->
      <div class="device" id="lamp">
        <h3>ランプ</h3>
        <div class="term-row">
          <div class="terminal" data-id="lamp-L">L</div>
          <div class="terminal" data-id="lamp-N">N</div>
        </div>
      </div>

      <!-- ジャンクション -->
      <div id="junction" class="device">
        <h3>Junction Box</h3>
        <div class="jb-grid">
          <div class="jb-term jb-dot" data-id="jb-1"></div>
          <div class="jb-term jb-dot" data-id="jb-2"></div>
          <div class="jb-term jb-dot" data-id="jb-3"></div>
          <div class="jb-term jb-dot" data-id="jb-4"></div>
        </div>
      </div>

    </div><!-- /board -->

    <aside class="controls">
      <div class="controls-inner">
        <div class="round-info">Round: <span id="roundNum">1</span> / 3</div>
        <div class="hint">操作可能時だけ端子をつないでください</div>

        <button id="setBtn" class="btn primary">SET</button>
        <button id="resetBtn" class="btn">Reset Wires</button>
        <button id="restartBtn" class="btn">Restart Game</button>

        <div class="help" style="margin-top:10px">
          <small>端子をクリック→別の端子クリックで配線。もう一度同じ配線をクリックすると削除。</small>
        </div>
      </div>
    </aside>

  </section>

</main>

<!-- overlay CLEAR -->
<div id="overlay" class="hidden">
  <h1 id="overlayTitle">WORLD1 CLEAR</h1>
  <div class="sub">称号：街の電気屋</div>
</div>

<script>
/* -------- 全コード（JS） -------- */
let bossHP = 100;
let playerHP = 100;
let roundNum = 1;

const board = document.getElementById("board");
const wireLayer = document.getElementById("wireLayer"); // SVG
const bossBar = document.getElementById("bossHP");
const playerBar = document.getElementById("playerHP");
const setBtn = document.getElementById("setBtn");
const resetBtn = document.getElementById("resetBtn");
const restartBtn = document.getElementById("restartBtn");
const overlay = document.getElementById("overlay");
const switchEl = document.getElementById("switch");
const switchState = document.getElementById("switchState");
const roundNumEl = document.getElementById("roundNum");

let selected = null;
let connections = []; // [ [idA,idB], ... ]
let switchOn = false;

/* 初期表示 */
updateHP();
roundNumEl.textContent = roundNum;
overlay.classList.add("hidden");

/* SVG の viewBox を board サイズに合わせる */
function resizeSVG(){
  const w = Math.max(1, board.clientWidth);
  const h = Math.max(1, board.clientHeight);
  wireLayer.setAttribute("viewBox", `0 0 ${w} ${h}`);
  wireLayer.setAttribute("width", w);
  wireLayer.setAttribute("height", h);
}
window.addEventListener("resize", resizeSVG);
resizeSVG();

/* 端子をまとめてイベント付与 */
function allTerminals(){
  return Array.from(document.querySelectorAll(".terminal, .jb-term"));
}
function setupTermEvents(){
  allTerminals().forEach(t=>{
    t.addEventListener("click", ()=>{
      if(!selected){
        selected = t;
        t.classList.add("selected");
        return;
      }
      // same click -> unselect
      if(selected === t){
        selected.classList.remove("selected");
        selected = null;
        return;
      }

      const idA = selected.dataset.id;
      const idB = t.dataset.id;
      if(!idA || !idB){
        // 消極的に終了
        selected.classList.remove("selected");
        selected = null;
        return;
      }

      // 既存接続があれば削除
      const idx = connections.findIndex(c => (c[0]===idA && c[1]===idB) || (c[0]===idB && c[1]===idA));
      if(idx !== -1){
        connections.splice(idx,1);
        // 該当する線を削除
        const lines = Array.from(wireLayer.querySelectorAll("line, path"));
        for(const ln of lines){
          const a = ln.getAttribute("data-from");
          const b = ln.getAttribute("data-to");
          if( (a===idA && b===idB) || (a===idB && b===idA) ){
            ln.remove();
            break;
          }
        }
      } else {
        // 新規接続
        connect(selected, t);
        connections.push([idA,idB]);
      }

      selected.classList.remove("selected");
      selected = null;
    });
  });
}
setupTermEvents();

/* スイッチをダブルクリックで切り替え */
switchEl.addEventListener("dblclick", ()=>{
  switchOn = !switchOn;
  switchState.textContent = switchOn ? "Switch: ON" : "Switch: OFF";
  switchEl.style.background = switchOn ? "#cfeecc" : "#e6e6e6";
});

/* 配線を描く（SVGのline） */
function connect(a,b){
  const idA = a.dataset.id;
  const idB = b.dataset.id;
  if(!idA || !idB) return;

  const rectA = a.getBoundingClientRect();
  const rectB = b.getBoundingClientRect();
  const boardRect = board.getBoundingClientRect();

  const x1 = rectA.left - boardRect.left + rectA.width/2;
  const y1 = rectA.top - boardRect.top + rectA.height/2;
  const x2 = rectB.left - boardRect.left + rectB.width/2;
  const y2 = rectB.top - boardRect.top + rectB.height/2;

  const ns = "http://www.w3.org/2000/svg";
  const line = document.createElementNS(ns, "line");
  line.setAttribute("x1", x1);
  line.setAttribute("y1", y1);
  line.setAttribute("x2", x2);
  line.setAttribute("y2", y2);
  line.setAttribute("stroke", "yellow");
  line.setAttribute("stroke-width", "4");
  line.setAttribute("stroke-linecap", "round");
  line.setAttribute("data-from", idA);
  line.setAttribute("data-to", idB);
  line.style.pointerEvents = "none";

  wireLayer.appendChild(line);
}

/* SET 判定（ラウンド1の必須配線判定） */
setBtn.addEventListener("click", ()=>{
  if(!switchOn){
    alert("スイッチがOFFだ");
    return;
  }

  const ok =
    has("power-L","jb-1") &&
    has("jb-1","switch-IN") &&
    has("switch-OUT","jb-2") &&
    has("jb-2","lamp-L") &&
    has("power-N","jb-3") &&
    has("jb-3","lamp-N");

  if(ok){
    bossHP = 0;
    updateHP();
    showClear();
  } else {
    playerHP -= 20;
    if(playerHP < 0) playerHP = 0;
    updateHP();
  }
});

function has(a,b){
  return connections.some(c =>
    (c[0]===a && c[1]===b) || (c[0]===b && c[1]===a)
  );
}

function updateHP(){
  bossBar.style.width = bossHP + "%";
  playerBar.style.width = playerHP + "%";
}

function showClear(){
  overlay.classList.remove("hidden");
}

/* Reset wires */
resetBtn.addEventListener("click", ()=>{
  connections = [];
  const lines = Array.from(wireLayer.querySelectorAll("line, path"));
  lines.forEach(ln=>ln.remove());
  if(selected){ selected.classList.remove("selected"); selected = null; }
});

/* Restart game */
restartBtn.addEventListener("click", ()=>{
  bossHP = 100; playerHP = 100; roundNum = 1;
  roundNumEl.textContent = roundNum; updateHP();
  overlay.classList.add("hidden"); resetBtn.click();
});

/* 初回調整の遅延実行でSVGを正しく合わせる */
setTimeout(()=>{ resizeSVG(); }, 250);
</script>
</body>
</html>
