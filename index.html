<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>電気工事士の試練 - WORLD 2：三路の迷宮</title>
    <style>
        body { background: #121212; color: #fff; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; margin: 0; overflow: hidden; }
        #header { background: #000; padding: 15px; border-bottom: 3px solid #00ffcc; display: flex; justify-content: space-between; align-items: center; }
        #title { font-size: 24px; font-weight: bold; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; }
        
        .status-box { display: flex; gap: 20px; font-size: 18px; }
        .hp-container { width: 200px; height: 20px; background: #333; border: 2px solid #fff; position: relative; }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0000, #00ff00); transition: 0.3s; }

        #main-stage { position: relative; width: 100vw; height: calc(100vh - 70px); background: #1e1e1e; display: flex; justify-content: center; align-items: center; }
        canvas { background: #2a2a2a; box-shadow: 0 0 30px rgba(0,0,0,1); border-radius: 8px; }

        /* UI Overlay */
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .card { background: #333; padding: 40px; border: 2px solid #00ffcc; border-radius: 15px; text-align: center; max-width: 600px; }
        .btn { padding: 12px 30px; margin: 10px; cursor: pointer; background: #444; color: #fff; border: 1px solid #00ffcc; border-radius: 5px; font-size: 18px; }
        .btn:hover { background: #00ffcc; color: #000; }

        #controls { position: absolute; bottom: 30px; display: flex; gap: 20px; }
        .ctrl-btn { padding: 20px 40px; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 10px; border: none; }
        #set-btn { background: #00ffcc; color: #000; }
        #reset-btn { background: #ff4444; color: #fff; }

        #msg-box { position: absolute; top: 20px; left: 20px; font-family: monospace; color: #00ffcc; font-size: 16px; pointer-events: none; }
    </style>
</head>
<body>

<div id="header">
    <div id="title">電気工事士の試練 <span id="world-tag">WORLD 1</span></div>
    <div class="status-box">
        <div>称号: <span id="rank">見習い</span></div>
        <div style="display:flex; align-items:center; gap:10px;">
            HP: <div class="hp-container"><div id="hp-bar"></div></div>
        </div>
    </div>
</div>

<div id="main-stage">
    <canvas id="gameCanvas"></canvas>
    <div id="msg-box"></div>
    
    <div id="ui-overlay">
        <div id="quiz-ui" class="card">
            <h2 id="q-text">問題</h2>
            <div id="q-options"></div>
        </div>
    </div>

    <div id="controls">
        <button id="set-btn" class="ctrl-btn">点灯試験 (SET)</button>
        <button id="reset-btn" class="ctrl-btn">全配線解除</button>
    </div>
</div>

<script>
/**
 * 構成データ：完璧な複線図とクイズ
 */
const WORLDS = [
    {
        id: 1,
        title: "基本の単一回路",
        quiz: [
            { q: "VVF1.6-2cの「2c」とは何のこと？", a: ["2センチ", "2芯", "2重被覆", "2サイクル"], c: 1 },
            { q: "電源の「L」は何色の電線を使うのが一般的？", a: ["白", "緑", "赤", "黒"], c: 3 }
        ],
        nodes: [
            { id: 'L', x: 400, y: 80, label: 'L', group: 'pwr' },
            { id: 'N', x: 500, y: 80, label: 'N', group: 'pwr' },
            { id: 's1_0', x: 450, y: 350, label: '0', group: 'sw1' },
            { id: 's1_1', x: 450, y: 410, label: '1', group: 'sw1' },
            { id: 'l_L', x: 750, y: 200, label: 'L', group: 'lamp' },
            { id: 'l_N', x: 800, y: 200, label: 'N', group: 'lamp' }
        ],
        switches: { sw1: { type: '1way', state: 0, internal: [[0,1]] } }
    },
    {
        id: 2,
        title: "三路の迷宮",
        quiz: [
            { q: "三路スイッチを2個使ってできることは？", a: ["1か所で制御", "3か所で制御", "2か所で制御", "調光"], c: 2 },
            { q: "三路スイッチ裏面の「0」は何端子？", a: ["接地", "共通", "渡り1", "渡り3"], c: 1 }
        ],
        nodes: [
            { id: 'L', x: 100, y: 80, label: 'L', group: 'pwr' },
            { id: 'N', x: 150, y: 80, label: 'N', group: 'pwr' },
            // 左スイッチ：0は左
            { id: 'swA_0', x: 120, y: 400, label: '0', group: 'swA' },
            { id: 'swA_1', x: 220, y: 370, label: '1', group: 'swA' },
            { id: 'swA_3', x: 220, y: 430, label: '3', group: 'swA' },
            // 右スイッチ：0は右
            { id: 'swB_0', x: 780, y: 400, label: '0', group: 'swB' },
            { id: 'swB_1', x: 680, y: 370, label: '1', group: 'swB' },
            { id: 'swB_3', x: 680, y: 430, label: '3', group: 'swB' },
            // 中央JB
            { id: 'jb1', x: 450, y: 280, label: 'JB', group: 'jb' },
            // ランプ
            { id: 'l_L', x: 420, y: 120, label: 'L', group: 'lamp' },
            { id: 'l_N', x: 480, y: 120, label: 'N', group: 'lamp' }
        ],
        switches: { 
            swA: { type: '3way', state: 0 }, 
            swB: { type: '3way', state: 0 } 
        }
    }
];

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.worldIdx = 0;
        this.hp = 100;
        this.lines = [];
        this.selected = null;
        this.isLampOn = false;
        
        this.init();
    }

    init() {
        this.canvas.width = 900;
        this.canvas.height = 550;
        this.loadWorld();
        this.attachEvents();
        this.tick();
    }

    loadWorld() {
        const w = WORLDS[this.worldIdx];
        this.lines = [];
        this.isLampOn = false;
        document.getElementById('world-tag').innerText = `WORLD ${w.id}: ${w.title}`;
        this.startQuiz();
    }

    startQuiz() {
        const w = WORLDS[this.worldIdx];
        const quiz = w.quiz[Math.floor(Math.random()*w.quiz.length)];
        
        document.getElementById('ui-overlay').style.display = 'flex';
        document.getElementById('q-text').innerText = quiz.q;
        const opts = document.getElementById('q-options');
        opts.innerHTML = '';
        
        quiz.a.forEach((text, i) => {
            const b = document.createElement('button');
            b.className = 'btn';
            b.innerText = text;
            b.onclick = () => {
                if(i === quiz.c) {
                    this.log("正解！施工を開始せよ。");
                    document.getElementById('ui-overlay').style.display = 'none';
                } else {
                    this.hp -= 20;
                    this.updateUI();
                    this.log("不正解！HP減少。");
                    if(this.hp <= 0) this.gameOver();
                }
            };
            opts.appendChild(b);
        });
    }

    updateUI() {
        document.getElementById('hp-bar').style.width = this.hp + "%";
        if(this.worldIdx > 0) document.getElementById('rank').innerText = "一般職士";
    }

    log(m) {
        const b = document.getElementById('msg-box');
        b.innerHTML = `> ${m}<br>` + b.innerHTML;
    }

    attachEvents() {
        this.canvas.onmousedown = (e) => {
            const r = this.canvas.getBoundingClientRect();
            const x = e.clientX - r.left;
            const y = e.clientY - r.top;
            
            const node = WORLDS[this.worldIdx].nodes.find(n => Math.hypot(n.x-x, n.y-y) < 20);
            if(node) {
                if(!this.selected) {
                    this.selected = node;
                } else {
                    if(this.selected.id !== node.id) {
                        this.lines.push({ f: this.selected.id, t: node.id });
                    }
                    this.selected = null;
                }
            } else {
                // スイッチ切り替え判定
                const w = WORLDS[this.worldIdx];
                for(let key in w.switches) {
                    const n0 = w.nodes.find(n => n.id === key+'_0');
                    if(n0 && Math.hypot(n0.x-x, n0.y-y) < 60) {
                        w.switches[key].state = 1 - w.switches[key].state;
                        this.log("スイッチ操作");
                        this.evalCircuit();
                    }
                }
            }
        };

        document.getElementById('set-btn').onclick = () => this.evalCircuit(true);
        document.getElementById('reset-btn').onclick = () => { this.lines = []; this.isLampOn = false; };
    }

    evalCircuit(isFinal = false) {
        const w = WORLDS[this.worldIdx];
        const edges = [...this.lines.map(l => [l.f, l.t])];
        
        // スイッチ内部結線をエッジに追加
        for(let key in w.switches) {
            const sw = w.switches[key];
            if(sw.type === '3way') {
                edges.push([key+'_0', sw.state === 0 ? key+'_1' : key+'_3']);
            } else {
                if(sw.state === 1) edges.push(['s1_0', 's1_1']);
            }
        }

        const canReach = (start, target) => {
            let visited = new Set();
            let queue = [start];
            while(queue.length > 0) {
                let curr = queue.shift();
                if(curr === target) return true;
                visited.add(curr);
                edges.forEach(e => {
                    if(e[0] === curr && !visited.has(e[1])) queue.push(e[1]);
                    if(e[1] === curr && !visited.has(e[0])) queue.push(e[0]);
                });
            }
            return false;
        };

        // 短絡チェック
        if(canReach('L', 'N')) {
            this.hp -= 50;
            this.log("バチンッ！短絡（ショート）だ！");
            this.updateUI();
            if(this.hp <= 0) this.gameOver();
            return;
        }

        this.isLampOn = canReach('L', 'l_L') && canReach('N', 'l_N');

        if(isFinal) {
            if(this.isLampOn) {
                this.log("点灯成功！ボス撃破！");
                setTimeout(() => this.nextWorld(), 1000);
            } else {
                this.hp -= 10;
                this.log("不点灯... HP減少。");
                this.updateUI();
            }
        }
    }

    nextWorld() {
        this.worldIdx++;
        if(this.worldIdx < WORLDS.length) {
            this.loadWorld();
            this.updateUI();
        } else {
            alert("おめでとう！神施工の称号を授与する！");
            location.reload();
        }
    }

    gameOver() {
        alert("施工失敗... 現場復帰せよ。");
        location.reload();
    }

    tick() {
        const ctx = this.ctx;
        ctx.clearRect(0,0,900,550);

        // 複線図の補助枠
        ctx.strokeStyle = '#444';
        ctx.setLineDash([5,5]);
        ctx.strokeRect(50, 50, 800, 450);
        ctx.setLineDash([]);

        // 配線描画
        this.lines.forEach(l => {
            const n1 = WORLDS[this.worldIdx].nodes.find(n => n.id === l.f);
            const n2 = WORLDS[this.worldIdx].nodes.find(n => n.id === l.t);
            ctx.beginPath();
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#ddd';
            ctx.moveTo(n1.x, n1.y); ctx.lineTo(n2.x, n2.y);
            ctx.stroke();
        });

        // デバイス描画
        WORLDS[this.worldIdx].nodes.forEach(n => {
            ctx.beginPath();
            ctx.arc(n.x, n.y, 12, 0, Math.PI*2);
            ctx.fillStyle = n.id.includes('L') ? '#ff4444' : (n.id.includes('N') ? '#fff' : '#00ffcc');
            if(this.selected === n) ctx.strokeStyle = 'yellow', ctx.lineWidth=3, ctx.stroke();
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.fillText(n.label, n.x-5, n.y-20);
        });

        // 三路スイッチの「外枠」描画
        const w = WORLDS[this.worldIdx];
        for(let key in w.switches) {
            const sw = w.switches[key];
            const nodes = w.nodes.filter(n => n.group === key);
            if(nodes.length > 0) {
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 2;
                ctx.strokeRect(nodes[0].x-30, nodes[0].y-50, 140, 100);
                // 内部導通
                ctx.beginPath();
                ctx.strokeStyle = 'orange';
                ctx.lineWidth = 2;
                const n0 = nodes.find(n => n.id.endsWith('_0'));
                const nt = nodes.find(n => n.id.endsWith('_' + (sw.state===0?'1':'3')));
                if(n0 && nt) { ctx.moveTo(n0.x, n0.y); ctx.lineTo(nt.x, nt.y); ctx.stroke(); }
            }
        }

        // ランプ点灯演出
        if(this.isLampOn) {
            ctx.beginPath();
            ctx.arc(450, 120, 40, 0, Math.PI*2);
            const grad = ctx.createRadialGradient(450,120,5,450,120,40);
            grad.addColorStop(0, 'yellow'); grad.addColorStop(1, 'rgba(255,255,0,0)');
            ctx.fillStyle = grad;
            ctx.fill();
        }

        requestAnimationFrame(() => this.tick());
    }
}

const game = new Game();
</script>
</body>
</html>
