<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>俺らの電工 - GOD CONNECTION</title>
<style>
/* --- 基礎設定・アニメーション（提示されたコードを完全継承） --- */
* { box-sizing: border-box; user-select: none; }
body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Arial Black', sans-serif; overflow: hidden; touch-action: none; }
.hidden { display: none !important; }

@keyframes pulseGlow { 0%, 100% { text-shadow: 0 0 10px #ffd000; } 50% { text-shadow: 0 0 30px #ffaa00; } }
@keyframes shake { 0% { transform:translate(0,0); } 10% { transform:translate(-5px,-5px); } 30% { transform:translate(5px,5px); } 50% { transform:translate(-5px,5px); } 100% { transform:translate(0,0); } }
@keyframes flowDash { from { stroke-dashoffset: 40; } to { stroke-dashoffset: 0; } }
@keyframes puchunLine { 0% { transform: scaleY(0); opacity: 0; } 50% { transform: scaleY(1); opacity: 1; } 100% { transform: scaleY(0); opacity: 0; } }
@keyframes rainbow { 0% { background: #ff0000; } 20% { background: #ffff00; } 40% { background: #00ff00; } 60% { background: #00ffff; } 80% { background: #0000ff; } 100% { background: #ff00ff; } }
.monochrome { filter: grayscale(100%) brightness(0.7) contrast(150%); }

/* --- UIレイアウト --- */
#titleScreen { position: fixed; inset: 0; background: radial-gradient(circle, #333 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
.title-logo { font-size: 44px; color: #ffd000; animation: pulseGlow 2s infinite; text-align: center; }

#gameHeader { position: fixed; top: 0; width: 100%; padding: 10px 15px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.8); border-bottom: 2px solid #ffd000; z-index: 100; font-size: 14px; }

#quizScreen { position: fixed; inset: 0; background: #111; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.quiz-mark { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 250px; font-weight: bold; pointer-events: none; opacity: 0; z-index: 9500; transition: opacity 0.2s; }
.mark-o { color: #00d4ff; } .mark-x { color: #ff3333; }

#gameScreen { position: fixed; inset: 0; display: flex; flex-direction: column; padding-top: 50px; }
#board { flex: 1; position: relative; width: 100%; }
#wireLayer { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

/* デバイスデザイン */
.device { position: absolute; background: #ccc; color: #000; border: 2px solid #444; border-radius: 6px; padding: 5px; text-align: center; z-index: 20; transform: translate(-50%, -50%); min-width: 90px; }
.dev-title { font-size: 10px; font-weight: bold; border-bottom: 1px solid #777; margin-bottom: 4px; }
.term-row { display: flex; justify-content: center; gap: 6px; }
.term { width: 28px; height: 28px; background: #222; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: 2px solid #000; position: relative; }
.term.sel { background: #ffd000; color: #000; box-shadow: 0 0 10px #ffd000; }

/* 配線描画 */
.wire-white { stroke: #fff; stroke-width: 5; fill: none; }
.wire-black { stroke: #444; stroke-width: 7; fill: none; filter: drop-shadow(0 0 1px #fff); }
.wire-glow { stroke: #ffd000; stroke-width: 5; stroke-dasharray: 10, 15; animation: flowDash 0.5s linear infinite; fill: none; display: none; }

#controls { height: 80px; background: #1a1a1a; display: flex; justify-content: center; align-items: center; gap: 15px; padding-bottom: 20px; }
.btn-set { padding: 12px 30px; background: #ffd000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; }

/* ボス & 演出 */
#bossScreen { position: fixed; inset: 0; background: #000; z-index: 8000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.hp-bar-wrap { width: 80%; height: 15px; background: #333; border: 1px solid #fff; margin-top: 20px; border-radius: 5px; overflow: hidden; }
#hpFill { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff6a00); transition: width 0.5s; }

#puchunScreen { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; align-items: center; justify-content: center; }
.flash-line { position: absolute; width: 100%; height: 8px; background: #fff; opacity: 0; }
.gekiha { font-size: 80px; color: #ffd000; opacity: 0; font-weight: 900; }

.btn-gold { padding: 15px 40px; background: linear-gradient(#ffe066, #d4af37); color: #000; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>

<div id="titleScreen">
    <div class="title-logo">俺らの電工<br><span style="color:red; font-size:20px;">GOD CONNECTION</span></div>
    <div style="color:#aaa; font-size:12px; margin-top:10px;">presents by 貴電</div>
    <button class="btn-gold" style="margin-top:40px;" onclick="startQuiz()">現場入り</button>
</div>

<div id="gameHeader" class="hidden">
    <div id="headerWorld">WORLD 1</div>
    <div id="headerRank">称号: 現場代理人見習い</div>
</div>

<div id="quizScreen" class="hidden">
    <div id="qText" style="font-size:20px; margin-bottom:30px; text-align:center;"></div>
    <div id="ansBox" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
</div>
<div id="quizResult" class="quiz-mark"></div>

<div id="gameScreen" class="hidden">
    <div id="board"><svg id="wireLayer"></svg></div>
    <div id="controls">
        <button style="padding:10px; background:#444; color:#fff; border:none; border-radius:5px;" onclick="resetWires()">RESET</button>
        <button class="btn-set" onclick="checkCircuit()">SET (通電試験)</button>
    </div>
</div>

<div id="bossScreen" class="hidden">
    <div id="bossName" style="color:red; font-weight:bold; margin-bottom:10px;"></div>
    <div id="bossImg" style="width:200px; height:200px; background-size:contain; background-repeat:no-repeat; background-position:center; filter: drop-shadow(0 0 20px #f00);"></div>
    <div class="hp-bar-wrap"><div id="hpFill"></div></div>
</div>

<div id="puchunScreen" class="hidden">
    <div id="puchunLine" class="flash-line"></div>
    <div id="gekihaText" class="gekiha">完全撃破</div>
    <button id="restartBtn" class="btn-gold hidden" style="position:absolute; bottom:15%;" onclick="location.reload()">タイトルへ戻る</button>
</div>

<script>
const el = id => document.getElementById(id);
let currentWorld = 1;
let lines = [];
let selTerm = null;

const WORLD_DATA = {
    1: {
        title: "WORLD 1: 単線路の試練",
        rank: "現場代理人見習い",
        boss: "低圧の亡霊",
        quizzes: [
            {q:"接地側（白線）を繋ぐべき端子記号は？", a:["L","W (N)","E"], c:1},
            {q:"埋込連用タンブラスイッチの図記号は？", a:["●","○","■"], c:0}
        ],
        devices: [
            {id:'p', t:'電源', x:50, y:15, pins:[['p-L','L'],['p-N','N']]},
            {id:'sw', t:'スイッチ', x:30, y:70, pins:[['s-0','0'],['s-1','1']]},
            {id:'lp', t:'照明', x:70, y:70, pins:[['l-L','L'],['l-N','N']]}
        ]
    },
    2: {
        title: "WORLD 2: 三路の迷宮",
        rank: "一級技能士（自称）",
        boss: "高電圧魔神 アーク",
        quizzes: [
            {q:"3路スイッチの共通端子番号は？", a:["0","1","3"], c:0},
            {q:"3路スイッチを2個使ってできることは？", a:["2箇所点滅","調光","タイマー"], c:0}
        ],
        devices: [
            {id:'p', t:'電源', x:50, y:15, pins:[['p-L','L'],['p-N','N']]},
            {id:'swA', t:'3路SW-A', x:25, y:70, pins:[['a-0','0'],['a-1','1'],['a-3','3']]},
            {id:'swB', t:'3路SW-B', x:55, y:70, pins:[['b-0','0'],['b-1','1'],['b-3','3']]},
            {id:'lp', t:'照明', x:80, y:70, pins:[['l-L','L'],['l-N','N']]}
        ]
    }
};

// --- クイズ ---
function startQuiz() {
    el('titleScreen').classList.add('hidden');
    el('gameHeader').classList.remove('hidden');
    el('quizScreen').classList.remove('hidden');
    loadQuiz();
}

function loadQuiz() {
    const data = WORLD_DATA[currentWorld];
    const q = data.quizzes[Math.floor(Math.random()*data.quizzes.length)];
    el('headerWorld').innerText = data.title;
    el('headerRank').innerText = "称号: " + data.rank;
    el('qText').innerText = q.q;
    el('ansBox').innerHTML = '';
    q.a.forEach((txt, i) => {
        const b = document.createElement('button');
        b.style = "width:85%; padding:15px; margin:5px; background:#222; color:#fff; border:1px solid #ffd000; border-radius:10px; font-weight:bold;";
        b.innerText = txt;
        b.onclick = () => {
            const isCorrect = (i === q.c);
            const res = el('quizResult');
            res.innerText = isCorrect ? '◯' : '✖';
            res.className = `quiz-mark ${isCorrect ? 'mark-o' : 'mark-x'}`;
            res.style.opacity = 1;
            setTimeout(() => {
                res.style.opacity = 0;
                if(isCorrect) {
                    el('quizScreen').classList.add('hidden');
                    el('gameScreen').classList.remove('hidden');
                    initBoard();
                }
            }, 800);
        };
        el('ansBox').appendChild(b);
    });
}

// --- 配線ボード ---
function initBoard() {
    const board = el('board');
    board.querySelectorAll('.device').forEach(d => d.remove());
    lines = [];
    drawWires();

    const data = WORLD_DATA[currentWorld];
    data.devices.forEach(dev => {
        const d = document.createElement('div');
        d.className = 'device';
        d.style.left = dev.x + '%'; d.style.top = dev.y + '%';
        let h = `<div class="dev-title">${dev.t}</div><div class="term-row">`;
        dev.pins.forEach(p => h += `<div class="term" data-id="${p[0]}">${p[1]}</div>`);
        d.innerHTML = h + `</div>`;
        board.appendChild(d);
    });

    document.querySelectorAll('.term').forEach(t => {
        t.onclick = (e) => {
            if(!selTerm) {
                selTerm = e.target;
                selTerm.classList.add('sel');
            } else {
                if(selTerm !== e.target) {
                    lines.push([selTerm.dataset.id, e.target.dataset.id]);
                    drawWires();
                }
                selTerm.classList.remove('sel');
                selTerm = null;
            }
        };
    });
}

function drawWires() {
    const svg = el('wireLayer');
    svg.innerHTML = '';
    const bRect = el('board').getBoundingClientRect();
    lines.forEach((pair, idx) => {
        const t1 = document.querySelector(`[data-id="${pair[0]}"]`);
        const t2 = document.querySelector(`[data-id="${pair[1]}"]`);
        if(!t1 || !t2) return;
        const r1 = t1.getBoundingClientRect(), r2 = t2.getBoundingClientRect();
        const x1 = r1.left-bRect.left+14, y1 = r1.top-bRect.top+14;
        const x2 = r2.left-bRect.left+14, y2 = r2.top-bRect.top+14;
        const isBlack = pair[0].match(/L|0|1|3/) || pair[1].match(/L|0|1|3/);
        const pathStr = `M ${x1} ${y1} Q ${(x1+x2)/2} ${(y1+y2)/2 - 25} ${x2} ${y2}`;
        
        const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
        p.setAttribute("d", pathStr);
        p.setAttribute("class", isBlack ? "wire-black" : "wire-white");
        svg.appendChild(p);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "path");
        g.setAttribute("d", pathStr);
        g.setAttribute("class", "wire-glow");
        svg.appendChild(g);
    });
}

function resetWires() { lines = []; drawWires(); }

// --- 判定ロジック ---
function checkCircuit() {
    const adj = {};
    lines.forEach(l => {
        if(!adj[l[0]]) adj[l[0]]=[]; if(!adj[l[1]]) adj[l[1]]=[];
        adj[l[0]].push(l[1]); adj[l[1]].push(l[0]);
    });

    const hasPath = (s, t) => {
        const v = new Set(), q = [s];
        while(q.length){
            const n = q.shift();
            if(n === t) return true;
            if(!v.has(n)){ v.add(n); (adj[n]||[]).forEach(x => q.push(x)); }
        }
        return false;
    };

    let success = false;
    if(currentWorld === 1) {
        // Power-L -> SW-0, SW-1 -> Lamp-L, Lamp-N -> Power-N
        if(hasPath('p-L','s-0') && hasPath('s-1','l-L') && hasPath('l-N','p-N')) success = true;
    } else {
        // Power-L -> 3SW A-0, A-1 -> B-1, A-3 -> B-3, B-0 -> Lamp-L, Lamp-N -> Power-N
        if(hasPath('p-L','a-0') && hasPath('a-1','b-1') && hasPath('a-3','b-3') && hasPath('b-0','l-L') && hasPath('l-N','p-N')) success = true;
    }

    if(success && !hasPath('p-L','p-N')) {
        document.querySelectorAll('.wire-glow').forEach(w => w.style.display = 'block');
        setTimeout(showBossPhase, 1000);
    } else {
        alert(hasPath('p-L','p-N') ? "ショートした！火災発生！" : "不点灯... 回路が繋がっていない。");
    }
}

// --- 演出 ---
function showBossPhase() {
    el('gameScreen').classList.add('hidden');
    el('bossScreen').classList.remove('hidden');
    const data = WORLD_DATA[currentWorld];
    el('bossName').innerText = data.boss;
    el('hpFill').style.width = (currentWorld === 1 ? '60%' : '0%');

    setTimeout(() => {
        if(currentWorld === 1) {
            el('bossScreen').style.animation = 'shake 0.5s infinite';
            setTimeout(() => {
                el('bossScreen').style.animation = '';
                currentWorld = 2;
                el('bossScreen').classList.add('hidden');
                el('quizScreen').classList.remove('hidden');
                loadQuiz();
            }, 1200);
        } else {
            // プチュン演出
            el('bossScreen').classList.add('monochrome');
            setTimeout(() => {
                el('bossScreen').classList.add('hidden');
                el('puchunScreen').classList.remove('hidden');
                el('puchunLine').style.animation = 'puchunLine 0.4s forwards';
                setTimeout(() => {
                    el('gekihaText').style.transition = 'opacity 2s';
                    el('gekihaText').style.opacity = 1;
                    setTimeout(() => {
                        el('puchunScreen').classList.add('rainbow-bg');
                        el('restartBtn').classList.remove('hidden');
                    }, 2000);
                }, 1000);
            }, 1000);
        }
    }, 500);
}
</script>
</body>
</html>
