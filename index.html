<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>電気工事士の試練</title>
    <style>
        /* IMG_2206/2208のビジュアルを完全再現 */
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #header {
            padding: 10px 15px;
            border-bottom: 2px solid #00ffcc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #000;
            z-index: 10;
        }

        #title-area {
            font-size: 18px;
            font-weight: bold;
            color: #00ffcc;
            text-shadow: 0 0 8px #00ffcc;
        }

        .status-area {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .hp-container {
            width: 120px;
            height: 12px;
            background: #333;
            border: 1px solid #fff;
        }

        #hp-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #00ff00);
            transition: width 0.3s ease;
        }

        /* ログ：左上に浮遊 */
        #log-area {
            position: absolute;
            top: 60px;
            left: 15px;
            font-size: 13px;
            color: #00ffcc;
            line-height: 1.6;
            pointer-events: none;
            z-index: 5;
        }

        #stage {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #canvas-wrap {
            width: 95%;
            max-width: 850px;
            aspect-ratio: 16 / 10;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* クイズ：IMG_2205再現 */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .quiz-box {
            background: #222;
            border: 2px solid #00ffcc;
            border-radius: 12px;
            padding: 25px;
            width: 85%;
            max-width: 450px;
            text-align: center;
        }

        .quiz-q { font-size: 17px; margin-bottom: 20px; font-weight: bold; }
        .quiz-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn {
            background: #333; border: 1px solid #00ffcc; color: #fff;
            padding: 12px; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .opt-btn:hover { background: #00ffcc; color: #000; }

        /* フッターボタン：IMG_2208再現サイズ */
        #footer {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            background: #000;
        }

        .ctrl-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            min-width: 160px;
        }

        #set-btn { background: #00ffcc; color: #000; }
        #reset-btn { background: #ff4444; color: #fff; }
    </style>
</head>
<body>

<div id="header">
    <div id="title-area">電気工事士の試練 <span id="world-title">WORLD 1</span></div>
    <div class="status-area">
        <div>称号: <span id="rank-text">見習い</span></div>
        <div>HP: </div>
        <div class="hp-container"><div id="hp-bar"></div></div>
    </div>
</div>

<div id="stage">
    <div id="log-area"></div>
    <div id="canvas-wrap">
        <canvas id="mainCanvas"></canvas>
    </div>

    <div id="overlay">
        <div class="quiz-box">
            <div id="q-txt" class="quiz-q"></div>
            <div id="q-btns" class="quiz-opts"></div>
        </div>
    </div>
</div>

<div id="footer">
    <button id="set-btn" class="ctrl-btn">点灯試験 (SET)</button>
    <button id="reset-btn" class="ctrl-btn">全配線解除</button>
</div>

<script>
const WORLD_CONFIG = [
    {
        id: 1, label: "基本の単一回路", rank: "見習い",
        quizzes: [
            { q: "VVF1.6-2cの「2c」とは何のこと？", a: ["2センチ", "2芯", "2重被覆", "2サイクル"], c: 1 },
            { q: "接地側電線（N）の色は何色？", a: ["黒", "赤", "白", "緑"], c: 2 }
        ],
        nodes: [
            { id: 'L', x: 400, y: 100, label: 'L', col: '#ff4444' },
            { id: 'N', x: 500, y: 100, label: 'N', col: '#fff' },
            { id: 'sw_0', x: 450, y: 380, label: '0', col: '#00ffcc', group: 'sw1' },
            { id: 'sw_1', x: 450, y: 450, label: '1', col: '#00ffcc', group: 'sw1' },
            { id: 'lp_L', x: 750, y: 250, label: 'L', col: '#00ffcc' },
            { id: 'lp_N', x: 810, y: 250, label: 'N', col: '#fff' }
        ],
        sws: { sw1: { type: '1way', state: 0 } }
    },
    {
        id: 2, label: "三路の迷宮", rank: "一般職士",
        quizzes: [
            { q: "三路スイッチの共通端子番号は？", a: ["1", "3", "0", "E"], c: 2 },
            { q: "三路スイッチ(S3)を2個使った回路は？", a: ["1か所点滅", "2か所点滅", "階段回路", "両方正解"], c: 3 }
        ],
        nodes: [
            { id: 'L', x: 100, y: 80, label: 'L', col: '#ff4444' },
            { id: 'N', x: 160, y: 80, label: 'N', col: '#fff' },
            // 左：0は左
            { id: 'swA_0', x: 120, y: 420, label: '0', col: '#00ffcc', group: 'swA' },
            { id: 'swA_1', x: 240, y: 380, label: '1', col: '#00ffcc', group: 'swA' },
            { id: 'swA_3', x: 240, y: 460, label: '3', col: '#00ffcc', group: 'swA' },
            // 右：0は右
            { id: 'swB_0', x: 780, y: 420, label: '0', col: '#00ffcc', group: 'swB' },
            { id: 'swB_1', x: 660, y: 380, label: '1', col: '#00ffcc', group: 'swB' },
            { id: 'swB_3', x: 660, y: 460, label: '3', col: '#00ffcc', group: 'swB' },
            // 中央JB
            { id: 'jb', x: 450, y: 320, label: 'JB', col: '#00ffcc' },
            // ランプ
            { id: 'lp_L', x: 420, y: 120, label: 'L', col: '#ff4444' },
            { id: 'lp_N', x: 480, y: 120, label: 'N', col: '#fff' }
        ],
        sws: { swA: { type: '3way', state: 0 }, swB: { type: '3way', state: 0 } }
    }
];

class GameEngine {
    constructor() {
        this.canvas = document.getElementById('mainCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.idx = 0;
        this.hp = 100;
        this.lines = [];
        this.select = null;
        this.lampOn = false;

        this.init();
    }

    init() {
        this.canvas.width = 900;
        this.canvas.height = 550;
        this.load();
        this.events();
        this.draw();
    }

    load() {
        const w = WORLD_CONFIG[this.idx];
        this.lines = [];
        this.lampOn = false;
        document.getElementById('world-title').innerText = `WORLD ${w.id}: ${w.label}`;
        document.getElementById('rank-text').innerText = w.rank;
        this.quiz();
    }

    quiz() {
        const w = WORLD_CONFIG[this.idx];
        const q = w.quizzes[Math.floor(Math.random() * w.quizzes.length)];
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('q-txt').innerText = q.q;
        const bArea = document.getElementById('q-btns');
        bArea.innerHTML = '';
        q.a.forEach((t, i) => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = t;
            b.onclick = () => {
                if(i === q.c) {
                    this.log("正解！施工を開始せよ。");
                    document.getElementById('overlay').style.display = 'none';
                } else {
                    this.hp -= 20;
                    this.log("不正解！HP減少。");
                    this.updHP();
                }
            };
            bArea.appendChild(b);
        });
    }

    updHP() {
        document.getElementById('hp-bar').style.width = Math.max(0, this.hp) + "%";
        if(this.hp <= 0) { alert("施工失敗..."); location.reload(); }
    }

    log(m) {
        const l = document.getElementById('log-area');
        l.innerHTML = `> ${m}<br>` + l.innerHTML;
    }

    events() {
        this.canvas.onmousedown = (e) => {
            const r = this.canvas.getBoundingClientRect();
            const sx = this.canvas.width / r.width;
            const sy = this.canvas.height / r.height;
            const x = (e.clientX - r.left) * sx;
            const y = (e.clientY - r.top) * sy;

            const w = WORLD_CONFIG[this.idx];
            const n = w.nodes.find(v => Math.hypot(v.x-x, v.y-y) < 22);

            if(n) {
                if(!this.select) this.select = n;
                else {
                    if(this.select.id !== n.id) this.lines.push({f:this.select.id, t:n.id});
                    this.select = null;
                }
            } else {
                // スイッチ操作（0番近辺）
                for(let k in w.sws) {
                    const n0 = w.nodes.find(v => v.id === k+'_0' || v.id === 'sw_0');
                    if(n0 && Math.hypot(n0.x-x, n0.y-y) < 60) {
                        w.sws[k].state = 1 - w.sws[k].state;
                        this.log("スイッチ操作");
                        this.check();
                    }
                }
            }
        };

        document.getElementById('reset-btn').onclick = () => { this.lines = []; this.lampOn = false; this.log("全配線解除。"); };
        document.getElementById('set-btn').onclick = () => this.check(true);
    }

    check(isFinal = false) {
        const w = WORLD_CONFIG[this.idx];
        const edges = [...this.lines.map(l => [l.f, l.t])];
        for(let k in w.sws) {
            const s = w.sws[k];
            if(s.type === '3way') edges.push([k+'_0', s.state === 0 ? k+'_1' : k+'_3']);
            else if(s.state === 0) edges.push(['sw_0', 'sw_1']);
        }

        const find = (s, t) => {
            let v = new Set(), q = [s];
            while(q.length) {
                let c = q.shift();
                if(c === t) return true;
                v.add(c);
                edges.forEach(e => {
                    if(e[0] === c && !v.has(e[1])) q.push(e[1]);
                    if(e[1] === c && !v.has(e[0])) q.push(e[0]);
                });
            }
            return false;
        };

        if(find('L', 'N')) { this.hp -= 50; this.log("ショート！！激しい火花！"); this.updHP(); return; }
        this.lampOn = find('L', 'lp_L') && find('N', 'lp_N');

        if(isFinal) {
            if(this.lampOn) {
                this.log("点灯成功！ボス撃破！");
                setTimeout(() => { this.idx++; if(this.idx < WORLD_CONFIG.length) this.load(); else alert("神施工完了！"); }, 1200);
            } else {
                this.hp -= 10; this.log("不点灯... 回路を確認せよ。"); this.updHP();
            }
        }
    }

    draw() {
        const ctx = this.ctx;
        const w = WORLD_CONFIG[this.idx];
        ctx.clearRect(0,0,900,550);

        // 枠
        ctx.strokeStyle = '#333'; ctx.setLineDash([5,5]); ctx.strokeRect(30,30,840,490); ctx.setLineDash([]);

        // 配線：IMG_2206/2208再現の太さ
        this.lines.forEach(l => {
            const n1 = w.nodes.find(v => v.id === l.f), n2 = w.nodes.find(v => v.id === l.t);
            ctx.beginPath(); ctx.lineWidth = 7; ctx.strokeStyle = '#eee'; ctx.lineCap = 'round';
            ctx.moveTo(n1.x, n1.y); ctx.lineTo(n2.x, n2.y); ctx.stroke();
        });

        // スイッチ枠
        for(let k in w.sws) {
            const nodes = w.nodes.filter(v => v.group === k);
            if(nodes.length) {
                ctx.strokeStyle = '#444'; ctx.lineWidth = 2;
                ctx.strokeRect(nodes[0].x-35, nodes[0].y-55, 145, 115);
                // 内部状態
                ctx.beginPath(); ctx.strokeStyle = 'orange'; ctx.lineWidth = 4;
                const sw = w.sws[k];
                const n0 = nodes.find(v => v.id.endsWith('_0'));
                const target = sw.type === '3way' ? (sw.state === 0 ? '_1' : '_3') : '_1';
                const nt = nodes.find(v => v.id.endsWith(target));
                if(n0 && nt && (sw.type === '3way' || sw.state === 0)) { ctx.moveTo(n0.x, n0.y); ctx.lineTo(nt.x, nt.y); ctx.stroke(); }
            }
        }

        // ノード：デカくて見やすい
        w.nodes.forEach(n => {
            ctx.beginPath(); ctx.arc(n.x, n.y, 16, 0, Math.PI*2);
            ctx.fillStyle = n.col;
            if(this.select === n) { ctx.shadowBlur = 15; ctx.shadowColor = 'yellow'; }
            ctx.fill(); ctx.shadowBlur = 0;
            ctx.fillStyle = '#fff'; ctx.font = 'bold 15px Arial';
            ctx.fillText(n.label, n.x-6, n.y-26);
        });

        // ランプ演出
        if(this.lampOn) {
            const lp = w.nodes.find(v => v.id === 'lp_L');
            const g = ctx.createRadialGradient(lp.x+30, lp.y, 5, lp.x+30, lp.y, 50);
            g.addColorStop(0, 'rgba(255,255,0,0.9)'); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(lp.x+30, lp.y, 50, 0, Math.PI*2); ctx.fill();
        }

        requestAnimationFrame(() => this.draw());
    }
}

new GameEngine();
</script>
</body>
</html>
