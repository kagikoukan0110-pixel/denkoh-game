<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ä¿ºã‚‰ã®é›»å·¥ - æ±šã­ãˆå¤§å·¥ æ®²æ»…æˆ¦</title>
<style>
* { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Arial Black', sans-serif; overflow: hidden; touch-action: none; }
.hidden { display: none !important; }

/* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¯ã‚¤ã‚ºæ¼”å‡º */
#titleScreen { position: fixed; inset: 0; background: radial-gradient(circle, #333 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
.title-logo { font-size: 32px; color: #ffd000; text-align: center; text-shadow: 0 0 15px #ffaa00; }
#quizScreen { position: fixed; inset: 0; background: #111; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.quiz-mark { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 250px; font-weight: bold; pointer-events: none; opacity: 0; z-index: 9500; }

/* ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ */
#gameScreen { position: fixed; inset: 0; display: flex; flex-direction: column; }
#statusHeader { height: 50px; border-bottom: 2px solid #ffd000; display: flex; justify-content: space-around; align-items: center; background: #111; font-size: 14px; }
#board { flex: 1; position: relative; background: #0a0a0a; overflow: hidden; }
#wireLayer { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

/* ãƒ‡ãƒã‚¤ã‚¹åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
.device { position: absolute; background: #ccc; color: #000; border: 2px solid #444; border-radius: 4px; padding: 4px; text-align: center; z-index: 20; transform: translate(-50%, -50%); box-shadow: 4px 4px 0 #000; }
.dev-title { font-size: 9px; font-weight: bold; border-bottom: 1px solid #777; margin-bottom: 4px; background: #ddd; white-space: nowrap; }
.term { width: 28px; height: 28px; background: #222; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; border: 2px solid #000; position: relative; }
.term.sel { background: #ffd000 !important; color: #000; box-shadow: 0 0 15px #ffd000; }

/* 3è·¯ã‚¹ã‚¤ãƒƒãƒç‰¹æ®Šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.layout-3way-left { display: flex; align-items: center; gap: 10px; padding: 10px; }
.layout-3way-right { display: flex; align-items: center; flex-direction: row-reverse; gap: 10px; padding: 10px; }
.term-col { display: flex; flex-direction: column; gap: 8px; }

/* å™¨å…·å€‹åˆ¥ */
.dev-breaker { width: 90px; }
.dev-jb { width: 220px; height: 70px; border: 2px dashed #999; background: #555; }
.dev-lamp { width: 80px; border-radius: 15px; transition: 0.3s; }
.dev-lamp.on { background: #ffd000; box-shadow: 0 0 30px #ffd000; }
.term-row { display: flex; justify-content: center; gap: 10px; padding: 5px; }

/* é…ç·š */
.wire-white { stroke: #fff; stroke-width: 6; fill: none; stroke-linecap: round; }
.wire-black { stroke: #333; stroke-width: 7; fill: none; stroke-linecap: round; }
.wire-glow { stroke: #ffd000; stroke-width: 4; stroke-dasharray: 10, 15; animation: flow 0.5s linear infinite; fill: none; display: none; }
@keyframes flow { from { stroke-dashoffset: 25; } to { stroke-dashoffset: 0; } }

#controls { height: 100px; background: #1a1a1a; display: flex; justify-content: center; align-items: center; gap: 20px; border-top: 2px solid #333; }
.btn-set { padding: 15px 40px; background: #ffd000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; }
.btn-reset { padding: 10px 20px; background: #444; color: #fff; border: none; border-radius: 8px; }

/* ãƒœã‚¹ãƒ»æ¼”å‡º */
#bossScreen { position: fixed; inset: 0; background: #000; z-index: 8000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
#hpBar { width: 80%; height: 20px; background: #333; border: 2px solid #fff; margin-top: 20px; border-radius: 10px; overflow: hidden; }
#hpFill { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff6a00); transition: width 0.5s; }
@keyframes shake { 0%, 100% { transform:translate(0,0); } 25% { transform:translate(-5px,5px); } 75% { transform:translate(5px,-5px); } }
@keyframes puchun { 0% { transform: scaleY(0); opacity: 0; } 50% { transform: scaleY(1); opacity: 1; } 100% { transform: scaleY(0); opacity: 0; } }
</style>
</head>
<body>

<div id="titleScreen">
    <div class="title-logo">ä¿ºã‚‰ã®é›»å·¥<br><span style="font-size:18px; color:red;">~ vs æ±šã­ãˆå¤§å·¥ ~</span></div>
    <button style="margin-top:30px; padding:15px 30px; background:#ffd000; border:none; border-radius:20px; font-weight:bold;" onclick="startWorldQuiz()">ç¾å ´ã«å…¥ã‚‹</button>
</div>

<div id="quizScreen" class="hidden">
    <div id="qText" style="font-size:18px; margin-bottom:20px; text-align:center;"></div>
    <div id="ansBox" style="width:100%; display:flex; flex-direction:column; gap:10px; align-items:center;"></div>
</div>
<div id="quizResult" class="quiz-mark"></div>

<div id="gameScreen" class="hidden">
    <div id="statusHeader">
        <div id="dispWorld" style="color:#ffd000"></div>
        <div id="dispPhase"></div>
        <div id="dispRank" style="color:#0f0"></div>
    </div>
    <div id="board"><svg id="wireLayer"></svg></div>
    <div id="controls">
        <button class="btn-reset" onclick="resetWires()">å…¨è§£ç·š</button>
        <button class="btn-set" onclick="checkCircuit()">ç‚¹ç¯è©¦é¨“ (SET)</button>
    </div>
</div>

<div id="bossScreen" class="hidden">
    <div style="color:red; font-size:24px; margin-bottom:10px;">å¼·æ•µï¼šæ±šã­ãˆå¤§å·¥</div>
    <div id="bossEmoji" style="font-size:80px;">ğŸ‘¹</div>
    <div id="hpBar"><div id="hpFill"></div></div>
</div>

<div id="puchunScreen" class="hidden" style="position:fixed; inset:0; background:#000; z-index:20000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div id="pLine" style="width:100%; height:2px; background:#fff; opacity:0;"></div>
    <div id="resText" style="color:#ffd000; font-size:60px; font-weight:900; opacity:0;">æ’ƒç ´</div>
    <button id="nextBtn" class="hidden" style="margin-top:30px; padding:10px 40px;" onclick="advanceWorld()">æ¬¡ã®ç¾å ´ã¸</button>
</div>

<script>
const el = id => document.getElementById(id);
let world = 1, phase = 1, qIdx = 0, lines = [], selTerm = null;
let swStates = { sw1:false, swA:false, swB:false };

const quizData = [
    {q:"æ¥åœ°å´é›»ç·šï¼ˆNï¼‰ã®è‰²ã¯ä½•è‰²ï¼Ÿ", a:["é»’","ç™½","èµ¤","ç·‘"], c:1},
    {q:"3è·¯ã‚¹ã‚¤ãƒƒãƒã§ã€é›»æºã‚„è² è·ã«ç¹‹ãå…±é€šç«¯å­ã®ç•ªå·ã¯ï¼Ÿ", a:["0","1","3","E"], c:0},
    {q:"VVF1.6-3c ã®ã€Œ3cã€ã¨ã¯ä½•ã®ã“ã¨ï¼Ÿ", a:["3ã‚»ãƒ³ãƒ","3èŠ¯","3é‡è¢«è¦†","3å›å·»ã"], c:1}
];

function startWorldQuiz() {
    el('titleScreen').classList.add('hidden');
    el('quizScreen').classList.remove('hidden');
    qIdx = 0; loadQuiz();
}

function loadQuiz() {
    if(qIdx >= 3) { el('quizScreen').classList.add('hidden'); el('gameScreen').classList.remove('hidden'); initBoard(); return; }
    const q = quizData[qIdx];
    el('qText').innerText = q.q;
    el('ansBox').innerHTML = '';
    q.a.forEach((t, i) => {
        const b = document.createElement('button');
        b.style = "width:80%; padding:12px; background:#222; color:#fff; border:1px solid #444; border-radius:8px;";
        b.innerText = t;
        b.onclick = () => {
            const ok = (i === q.c);
            el('quizResult').innerText = ok ? 'â—¯' : 'Ã—';
            el('quizResult').style.color = ok ? '#00f2ff' : 'red';
            el('quizResult').style.opacity = 1;
            setTimeout(() => { el('quizResult').style.opacity = 0; if(ok){ qIdx++; loadQuiz(); } }, 500);
        };
        el('ansBox').appendChild(b);
    });
}

function initBoard() {
    el('dispWorld').innerText = `WORLD ${world}`;
    el('dispPhase').innerText = `PHASE ${phase}/3`;
    el('dispRank').innerText = world === 1 ? "è¦‹ç¿’ã„" : "è·äºº";
    const board = el('board');
    board.querySelectorAll('.device').forEach(d => d.remove());
    lines = []; drawWires();

    // ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã¨JB
    addDev('p', 'ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼', 50, 15, [['p-L','L'],['p-N','N']], 'dev-breaker', 'std');
    addDev('jb', 'JB', 50, 45, [['j1','1'],['j2','2'],['j3','3'],['j4','4'],['j5','5'],['j6','6']], 'dev-jb', 'std');

    if(world === 1) {
        // å˜è·¯ã‚¹ã‚¤ãƒƒãƒ
        addDev('sw1', 'ã‚¹ã‚¤ãƒƒãƒ', 30, 80, [['s1-0','0'],['s1-1','1']], 'dev-sw', 'std');
        // ãƒ©ãƒ³ãƒ— (é‡ãªã‚‰ãªã„ã‚ˆã†ã«é…ç½®)
        for(let i=0; i<phase; i++) {
            addDev(`l${i}`, `ãƒ©ãƒ³ãƒ—${i+1}`, 55 + (i * 20), 80, [[`l${i}-L`,'L'],[`l${i}-N`,'N']], 'dev-lamp', 'std');
        }
    } else {
        // 3è·¯ã‚¹ã‚¤ãƒƒãƒï¼ˆæŒ‡ç¤ºé€šã‚Šã®ç«¯å­é…ç½®ï¼‰
        addDev('swA', '3è·¯SW(å·¦)', 20, 80, [['a-0','0'],['a-1','1'],['a-3','3']], 'dev-sw', '3way-left');
        addDev('swB', '3è·¯SW(å³)', 55, 80, [['b-1','1'],['b-3','3'],['b-0','0']], 'dev-sw', '3way-right');
        for(let i=0; i<phase; i++) {
            addDev(`l${i}`, `ãƒ©ãƒ³ãƒ—${i+1}`, 85, 60 + (i * 15), [[`l${i}-L`,'L'],[`l${i}-N`,'N']], 'dev-lamp', 'std');
        }
    }

    document.querySelectorAll('.term').forEach(t => t.onclick = handleTerm);
    document.querySelectorAll('.dev-sw').forEach(sw => sw.onclick = () => {
        const id = sw.dataset.devid;
        swStates[id] = !swStates[id];
        sw.classList.toggle('on', swStates[id]);
    });
}

function addDev(id, title, x, y, terms, cls, layout) {
    const d = document.createElement('div');
    d.className = `device ${cls}`; d.dataset.devid = id;
    d.style.left = x + '%'; d.style.top = y + '%';
    let inner = `<div class="dev-title">${title}</div>`;
    
    if(layout === 'std') {
        inner += `<div class="term-row">` + terms.map(t => `<div class="term" data-tid="${t[0]}">${t[1]}</div>`).join('') + `</div>`;
    } else if(layout === '3way-left') {
        inner += `<div class="layout-3way-left">
            <div class="term" data-tid="${terms[0][0]}">${terms[0][1]}</div>
            <div class="term-col">
                <div class="term" data-tid="${terms[1][0]}">${terms[1][1]}</div>
                <div class="term" data-tid="${terms[2][0]}">${terms[2][1]}</div>
            </div>
        </div>`;
    } else if(layout === '3way-right') {
        inner += `<div class="layout-3way-right">
            <div class="term" data-tid="${terms[2][0]}">${terms[2][1]}</div>
            <div class="term-col">
                <div class="term" data-tid="${terms[0][0]}">${terms[0][1]}</div>
                <div class="term" data-tid="${terms[1][0]}">${terms[1][1]}</div>
            </div>
        </div>`;
    }
    d.innerHTML = inner;
    el('board').appendChild(d);
}

function handleTerm(e) {
    e.stopPropagation();
    const tid = e.target.dataset.tid;
    if(!selTerm) { selTerm = tid; e.target.classList.add('sel'); }
    else {
        if(selTerm !== tid) { lines.push([selTerm, tid]); drawWires(); }
        document.querySelectorAll('.term').forEach(t => t.classList.remove('sel'));
        selTerm = null;
    }
}

function drawWires() {
    const svg = el('wireLayer'); svg.innerHTML = '';
    const b = el('board').getBoundingClientRect();
    lines.forEach(pair => {
        const t1 = document.querySelector(`[data-tid="${pair[0]}"]`);
        const t2 = document.querySelector(`[data-tid="${pair[1]}"]`);
        if(!t1 || !t2) return;
        const r1 = t1.getBoundingClientRect(), r2 = t2.getBoundingClientRect();
        const x1 = r1.left - b.left + 14, y1 = r1.top - b.top + 14;
        const x2 = r2.left - b.left + 14, y2 = r2.top - b.top + 14;
        
        // Nç«¯å­ãŒçµ¡ã‚€ç·šã¯ã€Œç™½ã€ã€ãã‚Œä»¥å¤–ã¯ã€Œé»’ã€
        const isWhite = pair[0].includes('-N') || pair[1].includes('-N');
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", `M ${x1} ${y1} L ${x2} ${y2}`);
        path.setAttribute("class", isWhite ? "wire-white" : "wire-black");
        svg.appendChild(path);

        const glow = path.cloneNode();
        glow.setAttribute("class", "wire-glow");
        svg.appendChild(glow);
    });
}

function resetWires() { lines = []; drawWires(); }

function checkCircuit() {
    const adj = {};
    const addEdge = (u, v) => {
        if(!adj[u]) adj[u] = []; if(!adj[v]) adj[v] = [];
        adj[u].push(v); adj[v].push(u);
    };
    lines.forEach(l => addEdge(l[0], l[1]));

    // ã‚¹ã‚¤ãƒƒãƒã®å†…éƒ¨çµç·š
    if(world === 1 && swStates.sw1) addEdge('s1-0', 's1-1');
    if(world === 2) {
        const aT = swStates.swA ? 'a-3' : 'a-1'; addEdge('a-0', aT);
        const bT = swStates.swB ? 'b-3' : 'b-1'; addEdge('b-0', bT);
    }

    const getNet = (start) => {
        const seen = new Set(), q = [start];
        while(q.length){
            const v = q.shift();
            if(!seen.has(v)){ seen.add(v); (adj[v]||[]).forEach(n=>q.push(n)); }
        }
        return seen;
    };

    const netL = getNet('p-L'), netN = getNet('p-N');
    if(netL.has('p-N')) { alert("ã‚·ãƒ§ãƒ¼ãƒˆï¼æ±šã­ãˆç«èŠ±ãŒæ•£ã£ãŸãï¼"); resetWires(); return; }

    let count = 0;
    for(let i=0; i<phase; i++){
        if(netL.has(`l${i}-L`) && netN.has(`l${i}-N`)) {
            count++; document.querySelector(`[data-devid="l${i}"]`).classList.add('on');
        }
    }

    if(count === phase) {
        document.querySelectorAll('.wire-glow').forEach(w => w.style.display='block');
        setTimeout(bossBattle, 1000);
    } else {
        alert("ä¸ç‚¹ç¯ã€‚é…ç·šã‚’è¦‹ç›´ã›ã€‚");
    }
}

function bossBattle() {
    el('gameScreen').classList.add('hidden');
    el('bossScreen').classList.remove('hidden');
    const hp = Math.floor(((4-phase)/3)*100);
    el('hpFill').style.width = hp + '%';
    
    setTimeout(() => {
        el('hpFill').style.width = (hp-33) + '%';
        el('bossEmoji').style.animation = 'shake 0.5s infinite';
        setTimeout(() => {
            if(phase < 3) {
                phase++; el('bossScreen').classList.add('hidden');
                el('gameScreen').classList.remove('hidden');
                initBoard();
            } else {
                puchunEffect();
            }
        }, 1000);
    }, 800);
}

function puchunEffect() {
    el('bossScreen').classList.add('hidden');
    const ps = el('puchunScreen');
    ps.classList.remove('hidden');
    el('pLine').style.animation = 'puchun 0.5s forwards';
    setTimeout(() => {
        el('resText').style.opacity = 1;
        ps.style.background = 'radial-gradient(circle, #444 0%, #000 100%)';
        el('nextBtn').classList.remove('hidden');
    }, 600);
}

function advanceWorld() {
    if(world === 1) {
        world = 2; phase = 1;
        el('puchunScreen').classList.add('hidden');
        el('puchunScreen').style.background = '#000';
        el('resText').style.opacity = 0;
        startWorldQuiz();
    } else {
        alert("å…¨ç¾å ´ã€æ–½å·¥å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼");
        location.reload();
    }
}
</script>
</body>
</html>
