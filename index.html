<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>俺らの電工 - WORLD1 完成版（重なり防止）</title>

<style>
:root{
  --bg:#000;
  --panel:#ddd;
  --term:#222;
  --wire:#ffd800;
}

body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:system-ui;
}

#wireLayer{
  position:fixed;
  top:0;
  left:0;
  width:100vw;
  height:100vh;
  pointer-events:none;
  z-index:2000;
}

/* ===== HEADER ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 18px;
}

.title{font-size:20px;font-weight:700}

.hp-area{width:40%}
.bar{
  width:100%;
  height:12px;
  background:#222;
  border-radius:10px;
  overflow:hidden;
}
.player{
  height:100%;
  width:100%;
  background:#2ecc71;
  border-radius:10px;
}

/* ===== BOARD ===== */
#board-wrap{
  height:65vh;
  position:relative;
}

#board{
  width:100%;
  height:100%;
  position:relative;
}

/* ===== DEVICE ===== */
.device{
  position:absolute;
  width:86px;
  padding:8px;
  background:#ddd;
  border-radius:12px;
  color:#000;
  transform:translate(-50%,-50%);
  text-align:center;
  box-shadow:0 12px 30px rgba(0,0,0,.6);
}

.device h3{
  margin:4px 0 6px;
  font-size:12px;
}

.terminal,.jb-term{
  width:26px;
  height:26px;
  display:inline-flex;
  justify-content:center;
  align-items:center;
  background:#222;
  color:#fff;
  border-radius:50%;
  margin:4px;
  cursor:pointer;
  user-select:none;
}

.selected{
  outline:3px solid #ffd800;
}

#junction{
  left:40%;
  top:42%;
}

/* ===== CONTROLS ===== */
.controls{
  padding:18px;
  text-align:center;
}

#setBtn{
  padding:14px 36px;
  border:none;
  border-radius:26px;
  background:#ffd000;
  font-weight:700;
}

/* ===== BOSS ===== */
#bossScreen{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:8000;
}

#bossPanel{
  width:80%;
  max-width:600px;
  background:#111;
  padding:20px;
  border-radius:14px;
  text-align:center;
}

#bossName{
  font-size:28px;
  color:#ffd200;
  font-weight:800;
  margin-bottom:16px;
}

.bossHPback{
  width:100%;
  height:18px;
  background:#331f1f;
  border-radius:12px;
  overflow:hidden;
}

.bossHPbar{
  height:100%;
  width:100%;
  background:#e74c3c;
  transition:width 400ms linear;
}

#overlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:56px;
  color:#ffd000;
  z-index:9999;
}
</style>
</head>
<body>

<svg id="wireLayer"></svg>

<div class="header">
  <div class="title">俺らの電工 β</div>
  <div>Round <span id="roundLabel">1</span> / 3</div>
  <div class="hp-area">
    <div class="bar"><div id="playerHP" class="player"></div></div>
  </div>
</div>

<div id="board-wrap">
  <div id="board">

    <div class="device" id="power" style="left:12%; top:26%;">
      <h3>電源</h3>
      <div class="terminal" data-id="power-L">L</div>
      <div class="terminal" data-id="power-N">N</div>
    </div>

    <div class="device" id="switch" style="left:78%; top:18%; background:#e7ffec;">
      <h3>片切</h3>
      <div class="terminal" data-id="switch-IN">IN</div>
      <div class="terminal" data-id="switch-OUT">OUT</div>
      <div id="switchState" style="font-size:11px;margin-top:6px;">Switch: OFF</div>
    </div>

    <div class="device" id="junction">
      <h3>Joint Box</h3>
      <div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
        <div class="jb-term" data-id="jb"></div>
      </div>
    </div>

    <div class="device" id="lamp" style="left:78%; top:66%;">
      <h3>ランプ</h3>
      <div class="terminal" data-id="lamp-L">L</div>
      <div class="terminal" data-id="lamp-N">N</div>
    </div>

    <div class="device" id="spare" style="left:18%; top:68%; display:block;">
      <h3>予備</h3>
      <div class="terminal" data-id="spare-1">•</div>
      <div class="terminal" data-id="spare-2">•</div>
    </div>

  </div>
</div>

<div class="controls">
  <button id="setBtn">SET</button>
</div>

<div id="bossScreen">
  <div id="bossPanel">
    <div id="bossName">汚ねえ大工</div>
    <div class="bossHPback">
      <div id="bossHPbar" class="bossHPbar"></div>
    </div>
  </div>
</div>

<div id="overlay">WORLD1 CLEAR</div>

<script>
/* ===== state (unchanged behavior) ===== */
let bossHP=100;
let playerHP=100;
let roundNum=1;
let switchOn=false;
let selected=null;
let connections=[];

/* ===== DOM refs ===== */
const board=document.getElementById("board");
const wireLayer=document.getElementById("wireLayer");
const playerBar=document.getElementById("playerHP");
const bossBar=document.getElementById("bossHPbar");
const bossScreen=document.getElementById("bossScreen");
const overlay=document.getElementById("overlay");
const roundLabel=document.getElementById("roundLabel");
const switchEl=document.getElementById("switch");
const switchState=document.getElementById("switchState");

/* ===== svg sizing (unchanged) ===== */
function resizeSVG(){
  const r=board.getBoundingClientRect();
  wireLayer.setAttribute("viewBox",`0 0 ${r.width} ${r.height}`);
  wireLayer.style.left=r.left+"px";
  wireLayer.style.top=r.top+"px";
  wireLayer.style.width=r.width+"px";
  wireLayer.style.height=r.height+"px";
}
window.addEventListener("resize",resizeSVG);
window.addEventListener("load",()=>{ resizeSVG(); setTimeout(resizeSVG,100); });

/* ===== UI updates ===== */
function updateHP(){playerBar.style.width=playerHP+"%";}
function updateBoss(){bossBar.style.width=bossHP+"%";}
function updateRound(){roundLabel.textContent=roundNum;}

/* ===== terminal click (unchanged) ===== */
document.querySelectorAll(".terminal,.jb-term").forEach(t=>{
  t.onclick=()=>{
    if(selected===t){t.classList.remove("selected");selected=null;return;}
    if(!selected){selected=t;t.classList.add("selected");return;}
    connect(selected,t);
    selected.classList.remove("selected");
    selected=null;
  };
});

/* ===== switch toggle (unchanged) ===== */
switchEl.ondblclick=()=>{
  switchOn=!switchOn;
  switchState.textContent = switchOn ? "Switch: ON" : "Switch: OFF";
};

/* ===== connect/draw (unchanged) ===== */
function connect(a,b){
  const idA=a.dataset.id;
  const idB=b.dataset.id;
  if(idA===idB) return;

  connections.push([idA,idB]);

  const rA=a.getBoundingClientRect();
  const rB=b.getBoundingClientRect();
  const rBord=board.getBoundingClientRect();

  const x1=rA.left-rBord.left+rA.width/2;
  const y1=rA.top-rBord.top+rA.height/2;
  const x2=rB.left-rBord.left+rB.width/2;
  const y2=rB.top-rBord.top+rB.height/2;

  const line=document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1",x1); line.setAttribute("y1",y1);
  line.setAttribute("x2",x2); line.setAttribute("y2",y2);
  line.setAttribute("stroke","#ffd800");
  line.setAttribute("stroke-width","4");
  line.setAttribute("stroke-linecap","round");
  wireLayer.appendChild(line);
}

function has(a,b){
  return connections.some(c=>
    (c[0]===a&&c[1]===b)||(c[1]===a&&c[0]===b)
  );
}

function check(){
  return has("power-L","jb")
      && has("jb","switch-IN")
      && has("switch-OUT","jb")
      && has("jb","lamp-L")
      && has("power-N","jb")
      && has("jb","lamp-N");
}

/* ===== boss flow (unchanged) ===== */
document.getElementById("setBtn").onclick=async()=>{
  if(!switchOn){ alert("スイッチをONにしてください"); return; }
  if(!check()){
    playerHP=Math.max(0,playerHP-20);
    updateHP();
    return;
  }

  bossScreen.style.display="flex";
  await new Promise(r=>setTimeout(r,600));

  bossHP-=34;
  if(bossHP<0) bossHP=0;
  updateBoss();

  await new Promise(r=>setTimeout(r,800));
  bossScreen.style.display="none";

  if(bossHP<=0){
    overlay.style.display="flex";
    return;
  }

  roundNum++;
  updateRound();

  // clear wires & connections, then reposition devices (non-overlap)
  wireLayer.innerHTML="";
  connections=[];
  await randomizeDevicePositions();
  resizeSVG();
};

/* ===== non-overlapping placement (NEW - minimal, safe) =====
   - junction remains near center
   - other devices are placed randomly but checked for overlap
*/
async function randomizeDevicePositions(){
  const deviceIds = ['power','switch','lamp','spare'];
  const rect = board.getBoundingClientRect();
  const placedRects = [];
  const minDist = 110; // px, minimum center distance

  // ensure junction stays at near-center (no change)
  const junction = document.getElementById('junction');
  junction.style.left = '40%';
  junction.style.top = '42%';

  for(const id of deviceIds){
    const el = document.getElementById(id);
    if(!el) continue;
    let placed=false;
    let tries=0;
    while(!placed && tries < 300){
      tries++;
      // sample within board bounds with margins
      const margin = 60;
      const x = margin + Math.random() * (rect.width - margin*2);
      const y = margin + Math.random() * (rect.height - margin*2);
      // temporarily position to measure size
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      const r = el.getBoundingClientRect();
      const cx = r.left - rect.left + r.width/2;
      const cy = r.top - rect.top + r.height/2;
      // keep some distance from junction
      const jRect = junction.getBoundingClientRect();
      const jcx = jRect.left - rect.left + jRect.width/2;
      const jcy = jRect.top - rect.top + jRect.height/2;
      const dj = Math.hypot(cx-jcx, cy-jcy);
      if(dj < minDist) continue;
      // check distance to already placed
      let ok=true;
      for(const pr of placedRects){
        const d = Math.hypot(cx-pr.cx, cy-pr.cy);
        if(d < minDist){ ok=false; break; }
      }
      if(ok){
        placedRects.push({cx,cy,rect:r});
        // convert to percent to keep responsive-ish
        const leftPct = Math.round(((r.left - rect.left) + r.width/2) / rect.width * 100);
        const topPct = Math.round(((r.top - rect.top) + r.height/2) / rect.height * 100);
        el.style.left = leftPct + '%';
        el.style.top = topPct + '%';
        placed=true;
      }
    }
    // fallback: if cannot place, keep previous location (do nothing)
  }

  // slight delay to let browser apply layout then resize SVG coordinates
  await new Promise(r=>setTimeout(r,40));
}

/* ===== initialization ===== */
updateHP(); updateBoss(); updateRound();
resizeSVG();

// on first load, arrange devices non-overlapping while preserving JB center
window.addEventListener('load', ()=>{ randomizeDevicePositions().then(()=>resizeSVG()); });
</script>
</body>
</html>
