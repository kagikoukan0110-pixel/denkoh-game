<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>三路2台 + ブレーカー版</title>
<style>
svg { border:1px solid #ccc; }

.body { fill:none; stroke:black; stroke-width:2; }
.terminal { fill:black; }
.arm { stroke:black; stroke-width:3; }

.wire { stroke:black; stroke-width:3; fill:none; }
.energized { stroke:red !important; }

.violation { fill:red !important; }

text { font-size:14px; }
button { margin:5px; }
</style>
</head>
<body>

<h3>三路2台 複線図 + ブレーカー</h3>

<svg width="1000" height="450">

<!-- 電源（ブレーカー） -->
<text x="30" y="120">L</text>
<circle cx="60" cy="130" r="6" id="L"/>

<text x="30" y="200">N</text>
<circle cx="60" cy="210" r="6" id="N"/>

<!-- 左三路 -->
<g transform="translate(200,100)">
  <rect width="160" height="160" class="body"/>

  <circle cx="20" cy="80" r="6" class="terminal" id="SW1_0"/>
  <text x="5" y="85">0</text>

  <circle cx="140" cy="40" r="6" class="terminal" id="SW1_1"/>
  <text x="150" y="45">1</text>

  <circle cx="140" cy="120" r="6" class="terminal" id="SW1_3"/>
  <text x="150" y="125">3</text>

  <line id="SW1_arm" class="arm"
        x1="20" y1="80"
        x2="140" y2="40"/>
</g>

<!-- 右三路（反転） -->
<g transform="translate(600,100)">
  <rect width="160" height="160" class="body"/>

  <circle cx="20" cy="40" r="6" class="terminal" id="SW2_1"/>
  <text x="5" y="45">1</text>

  <circle cx="20" cy="120" r="6" class="terminal" id="SW2_3"/>
  <text x="5" y="125">3</text>

  <circle cx="140" cy="80" r="6" class="terminal" id="SW2_0"/>
  <text x="150" y="85">0</text>

  <line id="SW2_arm" class="arm"
        x1="140" y1="80"
        x2="20" y2="40"/>
</g>

<!-- ランプ -->
<circle cx="900" cy="180" r="25"
        fill="none" stroke="black" stroke-width="2"/>
<text x="895" y="185">R</text>
<circle cx="875" cy="180" r="6" id="LAMP"/>

<!-- 配線（端子中心基準） -->
<path id="wL" class="wire"
      d="M60 130 H220 180"/>

<path id="trav1" class="wire"
      d="M340 140 H600 140"/>

<path id="trav2" class="wire"
      d="M340 220 H600 220"/>

<path id="wLamp" class="wire"
      d="M740 180 H875"/>

<path id="neutral" class="wire"
      d="M875 205 V210 H60"/>

</svg>

<div>
<button onclick="toggleBreaker()">ブレーカー</button>
<button onclick="toggleSW1()">SW1</button>
<button onclick="toggleSW2()">SW2</button>
</div>

<div id="panel"></div>

<script>

// ====== エンジン ======

class Hole{
  constructor(id,capacity=1){
    this.id=id
    this.capacity=capacity
    this.wires=[]
  }
}

class Wire{
  constructor(id,a,b){
    this.id=id
    this.a=a
    this.b=b
  }
  other(h){ return h===this.a?this.b:this.a }
}

const holes={}
document.querySelectorAll("circle[id]").forEach(el=>{
  holes[el.id]=new Hole(el.id)
})

const wires={}
function connect(id,a,b){
  const w=new Wire(id,a,b)
  wires[id]=w
  a.wires.push(w)
  b.wires.push(w)
}

// 正しい接続
connect("wL",holes.L,holes.SW1_0)
connect("trav1",holes.SW1_1,holes.SW2_1)
connect("trav2",holes.SW1_3,holes.SW2_3)
connect("wLamp",holes.SW2_0,holes.LAMP)
connect("neutral",holes.LAMP,holes.N)

let breaker=false
let sw1=false
let sw2=false
let energized=new Set()

// ===== DFS =====

function solve(){
  energized.clear()
  if(!breaker) return

  const visited=new Set()
  const stack=[holes.L]

  while(stack.length){
    const h=stack.pop()
    if(visited.has(h)) continue
    visited.add(h)

    h.wires.forEach(w=>{
      energized.add(w.id)
      stack.push(w.other(h))
    })

    // SW1
    if(h===holes.SW1_0)
      stack.push(sw1?holes.SW1_3:holes.SW1_1)
    if(h===holes.SW1_1 && !sw1)
      stack.push(holes.SW1_0)
    if(h===holes.SW1_3 && sw1)
      stack.push(holes.SW1_0)

    // SW2
    if(h===holes.SW2_0)
      stack.push(sw2?holes.SW2_3:holes.SW2_1)
    if(h===holes.SW2_1 && !sw2)
      stack.push(holes.SW2_0)
    if(h===holes.SW2_3 && sw2)
      stack.push(holes.SW2_0)
  }
}

// ===== 描画 =====

function render(){
  document.querySelectorAll(".wire")
    .forEach(w=>w.classList.remove("energized"))

  energized.forEach(id=>{
    document.getElementById(id)
      ?.classList.add("energized")
  })

  document.getElementById("panel").innerHTML =
    breaker?"電源ON":"電源OFF"
}

function reevaluate(){
  solve()
  render()
}

// ===== 操作 =====

function toggleBreaker(){
  breaker=!breaker
  reevaluate()
}

function toggleSW1(){
  sw1=!sw1
  document.getElementById("SW1_arm")
    .setAttribute("y2", sw1?120:40)
  reevaluate()
}

function toggleSW2(){
  sw2=!sw2
  document.getElementById("SW2_arm")
    .setAttribute("y2", sw2?120:40)
  reevaluate()
}

reevaluate()

</script>

</body>
</html>
