<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>三路2台 + DFSエンジン接続版</title>
<style>
svg { border:1px solid #ccc; }

.body { fill:none; stroke:black; stroke-width:2; }
.terminal { fill:black; cursor:pointer; }
.arm { stroke:black; stroke-width:3; }

.wire { stroke:black; stroke-width:3; fill:none; }
.energized { stroke:red !important; }

.violation { stroke:red !important; fill:red; }

text { font-size:14px; }
</style>
</head>
<body>

<h3>三路2台 複線図 + 本物エンジン</h3>

<svg width="950" height="420">

<!-- 電源 L -->
<circle cx="60" cy="200" r="6" id="L"/>
<text x="40" y="205">L</text>

<!-- 左三路 -->
<g transform="translate(150,120)">
  <rect width="160" height="160" class="body"/>
  <circle cx="20" cy="80" r="6" class="terminal" id="SW1_0"/>
  <text x="5" y="85">0</text>

  <circle cx="140" cy="40" r="6" class="terminal" id="SW1_1"/>
  <text x="150" y="45">1</text>

  <circle cx="140" cy="120" r="6" class="terminal" id="SW1_3"/>
  <text x="150" y="125">3</text>

  <line id="SW1_arm" class="arm"
        x1="20" y1="80"
        x2="140" y2="40"/>
</g>

<!-- 右三路 -->
<g transform="translate(520,120)">
  <rect width="160" height="160" class="body"/>

  <circle cx="20" cy="40" r="6" class="terminal" id="SW2_1"/>
  <text x="5" y="45">1</text>

  <circle cx="20" cy="120" r="6" class="terminal" id="SW2_3"/>
  <text x="5" y="125">3</text>

  <circle cx="140" cy="80" r="6" class="terminal" id="SW2_0"/>
  <text x="150" y="85">0</text>

  <line id="SW2_arm" class="arm"
        x1="140" y1="80"
        x2="20" y2="40"/>
</g>

<!-- ランプ -->
<circle cx="880" cy="200" r="25" fill="none" stroke="black" stroke-width="2"/>
<text x="875" y="205">R</text>
<circle cx="855" cy="200" r="6" id="LAMP"/>

<!-- 配線 -->
<path id="wL" class="wire" d="M60 200 H170 200"/>
<path id="trav1" class="wire" d="M290 160 H520 160"/>
<path id="trav2" class="wire" d="M290 240 H520 240"/>
<path id="wLamp" class="wire" d="M660 200 H855"/>
<path id="neutral" class="wire" d="M880 225 V330 H60"/>

</svg>

<div>
<button onclick="toggleSW1()">SW1切替</button>
<button onclick="toggleSW2()">SW2切替</button>
<button onclick="makeViolation()">1穴1線違反</button>
</div>

<div id="panel"></div>

<script>

// ===== エンジン =====

class Hole {
  constructor(id, capacity=1){
    this.id=id
    this.capacity=capacity
    this.wires=[]
  }
}

class Wire {
  constructor(id,a,b){
    this.id=id
    this.a=a
    this.b=b
  }
  other(h){ return h===this.a?this.b:this.a }
}

const holes={}
document.querySelectorAll("circle[id]").forEach(el=>{
  holes[el.id]=new Hole(el.id)
})

const wires={}

function connect(id,a,b){
  const w=new Wire(id,a,b)
  wires[id]=w
  a.wires.push(w)
  b.wires.push(w)
}

connect("wL",holes.L,holes.SW1_0)
connect("trav1",holes.SW1_1,holes.SW2_1)
connect("trav2",holes.SW1_3,holes.SW2_3)
connect("wLamp",holes.SW2_0,holes.LAMP)
connect("neutral",holes.LAMP,holes.L)

let sw1=false
let sw2=false
let energized=new Set()
let violations=[]

// ===== DFS導通 =====

function solve(){
  energized.clear()
  const visited=new Set()
  const stack=[holes.L]

  while(stack.length){
    const h=stack.pop()
    if(visited.has(h))continue
    visited.add(h)

    h.wires.forEach(w=>{
      energized.add(w.id)
      stack.push(w.other(h))
    })

    // SW1
    if(h===holes.SW1_0)
      stack.push(sw1?holes.SW1_3:holes.SW1_1)
    if(h===holes.SW1_1 && !sw1)
      stack.push(holes.SW1_0)
    if(h===holes.SW1_3 && sw1)
      stack.push(holes.SW1_0)

    // SW2
    if(h===holes.SW2_0)
      stack.push(sw2?holes.SW2_3:holes.SW2_1)
    if(h===holes.SW2_1 && !sw2)
      stack.push(holes.SW2_0)
    if(h===holes
