<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>電工二種 技能試験シミュレーター</title>
<style>
body { font-family: sans-serif; background:#f4f6f8; padding:20px; }
.panel { background:white; padding:15px; border-radius:8px; margin-bottom:15px; }
button { padding:8px 12px; margin:5px; }
.correct { color:green; font-weight:bold; }
.error { color:red; font-weight:bold; }
#lamp { width:40px; height:40px; border-radius:50%; background:#ccc; display:inline-block; }
#lamp.on { background:red; box-shadow:0 0 15px red; transition:0.3s; }
.timer { font-size:20px; font-weight:bold; }
</style>
</head>
<body>

<h2>電工二種 技能試験シミュレーター</h2>

<div class="panel">
問題:
<select id="problemSelect"></select>
<button onclick="loadProblem()">読み込み</button>
</div>

<div class="panel">
接続入力（端子A,B形式で入力）
<input id="a">
<input id="b">
<button onclick="addConnection()">接続追加</button>
<button onclick="resetConnections()">リセット</button>
</div>

<div class="panel">
<button onclick="checkAnswer()">採点</button>
<button onclick="startExam()">本番モード開始</button>
<span class="timer" id="timer"></span>
</div>

<div class="panel">
<div>ランプ: <span id="lamp"></span></div>
<div id="result"></div>
</div>

<script>
// =========================
// Graph クラス
// =========================
class Graph {
    constructor() {
        this.adj = {};
    }

    addEdge(a,b){
        if(!this.adj[a]) this.adj[a]=[];
        if(!this.adj[b]) this.adj[b]=[];
        this.adj[a].push(b);
        this.adj[b].push(a);
    }

    dfs(start, visited = new Set()){
        visited.add(start);
        for(const next of this.adj[start] || []){
            if(!visited.has(next)){
                this.dfs(next, visited);
            }
        }
        return visited;
    }

    isConnected(a,b){
        if(!this.adj[a]) return false;
        return this.dfs(a).has(b);
    }
}

// =========================
// 問題データ
// =========================
const problems = {
    1:{
        name:"No1 三路2台",
        solution:[["L","S1"],["S1","S2"],["S2","Lamp"],["Lamp","N"]],
        internal:[]
    },
    2:{
        name:"No2 三路＋四路",
        solution:[["L","S1"],["S1","S2"],["S2","S3"],["S3","Lamp"],["Lamp","N"]],
        internal:[]
    },
    3:{
        name:"No3 片切＋コンセント送り",
        solution:[["L","SW"],["SW","Lamp"],["Lamp","N"],["L","Outlet"]],
        internal:[]
    },
    4:{
        name:"No4 ジョイント分岐",
        solution:[["L","J1"],["J1","Lamp1"],["J1","Lamp2"],["Lamp1","N"],["Lamp2","N"]],
        internal:[]
    },
    5:{
        name:"No5 複数灯回路",
        solution:[["L","SW"],["SW","Lamp1"],["SW","Lamp2"],["Lamp1","N"],["Lamp2","N"]],
        internal:[]
    }
};

let currentProblem = null;
let userConnections = [];
let timerInterval = null;
let timeLeft = 0;

// =========================
// 初期化
// =========================
function init(){
    const select = document.getElementById("problemSelect");
    Object.keys(problems).forEach(k=>{
        const opt=document.createElement("option");
        opt.value=k;
        opt.textContent=problems[k].name;
        select.appendChild(opt);
    });
}
init();

// =========================
// 問題読み込み
// =========================
function loadProblem(){
    const id=document.getElementById("problemSelect").value;
    currentProblem=problems[id];
    userConnections=[];
    document.getElementById("result").innerHTML="";
    document.getElementById("lamp").classList.remove("on");
}

// =========================
// 接続操作
// =========================
function addConnection(){
    const a=document.getElementById("a").value.trim();
    const b=document.getElementById("b").value.trim();
    if(!a || !b) return;

    // 1穴1線チェック
    if(userConnections.some(e=>e[0]===a || e[1]===a) ||
       userConnections.some(e=>e[0]===b || e[1]===b)){
        alert("1穴1線違反");
        return;
    }

    userConnections.push([a,b]);
    document.getElementById("a").value="";
    document.getElementById("b").value="";
}

function resetConnections(){
    userConnections=[];
    document.getElementById("lamp").classList.remove("on");
}

// =========================
// 判定ロジック
// =========================
function normalize(arr){
    return arr.map(e=>e.slice().sort().join("-")).sort();
}

function checkAnswer(){
    if(!currentProblem) return;

    const sol = normalize(currentProblem.solution);
    const usr = normalize(userConnections);

    const missing = sol.filter(x=>!usr.includes(x));
    const extra = usr.filter(x=>!sol.includes(x));

    // 短絡チェック
    const graph=new Graph();
    userConnections.forEach(e=>graph.addEdge(e[0],e[1]));
    if(graph.isConnected("L","N")){
        document.getElementById("result").innerHTML="<div class='error'>短絡発生</div>";
        return;
    }

    if(missing.length===0 && extra.length===0){
        document.getElementById("result").innerHTML="<div class='correct'>合格</div>";
        document.getElementById("lamp").classList.add("on");
    }else{
        document.getElementById("result").innerHTML=
            "<div class='error'>不正解<br>不足:"+missing+"<br>余分:"+extra+"</div>";
    }
}

// =========================
// 本番モード
// =========================
function startExam(){
    timeLeft=60;
    document.getElementById("timer").textContent=timeLeft;

    timerInterval=setInterval(()=>{
        timeLeft--;
        document.getElementById("timer").textContent=timeLeft;

        if(timeLeft<=10){
            document.getElementById("timer").style.color="red";
        }

        if(timeLeft<=0){
            clearInterval(timerInterval);
            checkAnswer();
            alert("終了");
        }
    },1000);
}

// =========================
// 保存基盤
// =========================
function saveStats(problemId, result){
    const data=JSON.parse(localStorage.getItem("stats")||"{}");
    if(!data[problemId]) data[problemId]={correct:0,total:0};
    data[problemId].total++;
    if(result) data[problemId].correct++;
    localStorage.setItem("stats",JSON.stringify(data));
}

</script>
</body>
</html>
