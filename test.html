// =============================
// Skill Wiring Engine MVP
// =============================

class Violation {
  constructor(type, targetType, targetId, severity, message) {
    this.id = crypto.randomUUID()
    this.type = type
    this.targetType = targetType
    this.targetId = targetId
    this.severity = severity
    this.message = message
  }
}

class Hole {
  constructor(id, capacity = 1) {
    this.id = id
    this.capacity = capacity
    this.connectedWires = []
  }
}

class Wire {
  constructor(id, holeA, holeB, color = "black") {
    this.id = id
    this.holeA = holeA
    this.holeB = holeB
    this.color = color
  }

  otherSide(hole) {
    return hole === this.holeA ? this.holeB : this.holeA
  }
}

class Device {
  constructor(id) {
    this.id = id
    this.holes = {}
  }

  addHole(id, capacity = 1) {
    this.holes[id] = new Hole(id, capacity)
  }
}

// =============================
// Switch Devices
// =============================

class ThreeWaySwitch extends Device {
  constructor(id) {
    super(id)
    this.state = false
    this.addHole(id + "_common")
    this.addHole(id + "_travA")
    this.addHole(id + "_travB")
  }

  toggle() {
    this.state = !this.state
  }

  getConnections() {
    if (!this.state) {
      return [[this.holes[this.id + "_common"], this.holes[this.id + "_travA"]]]
    } else {
      return [[this.holes[this.id + "_common"], this.holes[this.id + "_travB"]]]
    }
  }
}

class FourWaySwitch extends Device {
  constructor(id) {
    super(id)
    this.state = false
    this.addHole(id + "_inA")
    this.addHole(id + "_inB")
    this.addHole(id + "_outA")
    this.addHole(id + "_outB")
  }

  toggle() {
    this.state = !this.state
  }

  getConnections() {
    if (!this.state) {
      return [
        [this.holes[this.id + "_inA"], this.holes[this.id + "_outA"]],
        [this.holes[this.id + "_inB"], this.holes[this.id + "_outB"]],
      ]
    } else {
      return [
        [this.holes[this.id + "_inA"], this.holes[this.id + "_outB"]],
        [this.holes[this.id + "_inB"], this.holes[this.id + "_outA"]],
      ]
    }
  }
}

// =============================
// Engine
// =============================

class SkillWiringEngine {
  constructor() {
    this.devices = {}
    this.wires = {}
    this.violations = []
    this.energizedWires = new Set()

    this.liveHole = null
    this.neutralHole = null
  }

  addDevice(device) {
    this.devices[device.id] = device
  }

  setPower(liveHole, neutralHole) {
    this.liveHole = liveHole
    this.neutralHole = neutralHole
  }

  connectWire(id, holeA, holeB, color = "black") {
    const wire = new Wire(id, holeA, holeB, color)
    this.wires[id] = wire

    holeA.connectedWires.push(wire)
    holeB.connectedWires.push(wire)
  }

  clearViolations() {
    this.violations = []
  }

  addViolation(v) {
    this.violations.push(v)
  }

  checkOneHoleRule() {
    Object.values(this.devices).forEach(device => {
      Object.values(device.holes).forEach(hole => {
        if (hole.connectedWires.length > hole.capacity) {
          this.addViolation(
            new Violation(
              "ONE_HOLE_ONE_WIRE",
              "hole",
              hole.id,
              "major",
              "1穴1線違反"
            )
          )
        }
      })
    })
  }

  solveElectrical() {
    this.energizedWires.clear()
    const visited = new Set()
    const stack = [this.liveHole]

    while (stack.length) {
      const hole = stack.pop()
      if (!hole || visited.has(hole)) continue
      visited.add(hole)

      hole.connectedWires.forEach(wire => {
        this.energizedWires.add(wire.id)
        const nextHole = wire.otherSide(hole)
        stack.push(nextHole)
      })

      Object.values(this.devices).forEach(device => {
        if (typeof device.getConnections === "function") {
          device.getConnections().forEach(([a, b]) => {
            if (hole === a) stack.push(b)
            if (hole === b) stack.push(a)
          })
        }
      })
    }
  }

  isLampOn(lampHole) {
    const visited = new Set()
    const stack = [this.liveHole]

    while (stack.length) {
      const hole = stack.pop()
      if (!hole || visited.has(hole)) continue
      visited.add(hole)

      if (hole === lampHole) return true

      hole.connectedWires.forEach(wire => {
        stack.push(wire.otherSide(hole))
      })

      Object.values(this.devices).forEach(device => {
        if (typeof device.getConnections === "function") {
          device.getConnections().forEach(([a, b]) => {
            if (hole === a) stack.push(b)
            if (hole === b) stack.push(a)
          })
        }
      })
    }
    return false
  }

  reevaluate() {
    this.clearViolations()
    this.checkOneHoleRule()
    this.solveElectrical()
  }
}

// =============================
// EXPORT
// =============================

export {
  SkillWiringEngine,
  Device,
  ThreeWaySwitch,
  FourWaySwitch
}
