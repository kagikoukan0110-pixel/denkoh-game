<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>電工二種 技能試験シミュレーター</title>

<style>
body{font-family:sans-serif;background:#f4f6f8;margin:0;padding:20px;}
.panel{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;}
#circuit{width:100%;height:420px;border:1px solid #ccc;background:#fafafa;touch-action:none;}
.lamp{width:36px;height:36px;border-radius:50%;background:#ccc;display:inline-block;}
.lamp.on{background:red;box-shadow:0 0 15px red;}
.powered{stroke:#ff0000 !important;stroke-dasharray:8 6;animation:flow 0.6s linear infinite;}
@keyframes flow{from{stroke-dashoffset:0}to{stroke-dashoffset:-30}}
</style>
</head>
<body>

<div class="panel">
問題:
<select id="problemSelect">
<option value="1">No1 三路2台</option>
</select>
<button onclick="loadProblem()">読み込み</button>

配線色:
<select id="wireColorSelect">
<option value="black">黒</option>
<option value="white">白</option>
<option value="red">赤</option>
</select>

<button onclick="resetConnections()">リセット</button>
<button onclick="checkAnswer()">採点</button>
</div>

<div class="panel">
<svg id="circuit" viewBox="0 0 1000 420"></svg>
<div style="margin-top:10px;">
ランプ: <span id="lamp" class="lamp"></span>
<span id="result"></span>
</div>
</div>

<script>

// =====================
// グローバル
// =====================

const svg = document.getElementById("circuit");
const lampEl = document.getElementById("lamp");
let userConnections = [];
let dragStart = null;
let tempLine = null;
let currentId = 1;
let switchState = {};

// =====================
// 問題ロード
// =====================

function loadProblem(){
    currentId = 1;
    userConnections=[];
    clearSVG();
    renderBoard(currentId);
    updateLamp();
}

// =====================
// SVG描画
// =====================

function clearSVG(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);
}

function drawDevice(x,y,w,h,title,terms){
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x",x);
    rect.setAttribute("y",y);
    rect.setAttribute("width",w);
    rect.setAttribute("height",h);
    rect.setAttribute("fill","#e9edf2");
    rect.setAttribute("stroke","#aaa");
    svg.appendChild(rect);

    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x",x+10);
    text.setAttribute("y",y-5);
    text.setAttribute("font-size","12");
    text.textContent = title;
    svg.appendChild(text);

    terms.forEach(t=>{
        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx",t.x);
        c.setAttribute("cy",t.y);
        c.setAttribute("r",10);
        c.setAttribute("fill","#fff");
        c.setAttribute("stroke","#333");
        c.setAttribute("data-terminal",t.id);
        svg.appendChild(c);

        const label = document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x",t.x-15);
        label.setAttribute("y",t.y-15);
        label.setAttribute("font-size","10");
        label.textContent=t.label;
        svg.appendChild(label);
    });
}

function renderBoard(id){

    drawDevice(60,170,120,80,"電源",[
        {id:"L",x:90,y:210,label:"L"},
        {id:"N",x:130,y:210,label:"N"}
    ]);

    drawDevice(230,150,180,100,"三路スイッチ1",[
        {id:"S1-COM",x:260,y:200,label:"COM"},
        {id:"S1-T1",x:330,y:200,label:"T1"},
        {id:"S1-T2",x:390,y:200,label:"T2"}
    ]);

    drawDevice(440,180,140,80,"BOX",[
        {id:"BOX1",x:470,y:220,label:"B1"},
        {id:"BOX2",x:510,y:220,label:"B2"},
        {id:"BOX3",x:550,y:220,label:"B3"}
    ]);

    drawDevice(620,150,180,100,"三路スイッチ2",[
        {id:"S2-COM",x:650,y:200,label:"COM"},
        {id:"S2-T1",x:720,y:200,label:"T1"},
        {id:"S2-T2",x:780,y:200,label:"T2"}
    ]);

    drawDevice(830,170,120,80,"引掛シーリング",[
        {id:"Lamp-L",x:860,y:210,label:"L"},
        {id:"Lamp-N",x:900,y:210,label:"N"}
    ]);

    switchState["S1"]=0;
    switchState["S2"]=0;
}

// =====================
// 座標取得
// =====================

function getPos(name){
    const el = svg.querySelector(`[data-terminal='${name}']`);
    return {
        x: parseFloat(el.getAttribute("cx")),
        y: parseFloat(el.getAttribute("cy"))
    };
}

// =====================
// 折れ線描画
// =====================

function drawWire(a,b,color){

    const p1 = getPos(a);
    const p2 = getPos(b);

    const midX = (p1.x+p2.x)/2;

    const poly = document.createElementNS("http://www.w3.org/2000/svg","polyline");
    poly.setAttribute("points",
        `${p1.x},${p1.y} ${midX},${p1.y} ${midX},${p2.y} ${p2.x},${p2.y}`
    );
    poly.setAttribute("fill","none");
    poly.setAttribute("stroke",color);
    poly.setAttribute("stroke-width","4");
    poly.setAttribute("stroke-linecap","round");

    poly.addEventListener("click",()=>{
        poly.remove();
        userConnections = userConnections.filter(c=>c.line!==poly);
        updateLamp();
    });

    svg.appendChild(poly);
    return poly;
}

// =====================
// 接続作成
// =====================

function createConnection(a,b){

    if(userConnections.some(e=>e.a===a||e.b===a)) return;
    if(userConnections.some(e=>e.a===b||e.b===b)) return;

    const sel = document.getElementById("wireColorSelect").value;
    const colorMap={black:"#000",white:"#fff",red:"#cc0000"};
    const line = drawWire(a,b,colorMap[sel]);

    userConnections.push({a,b,line,color:sel});
    updateLamp();
}

// =====================
// ドラッグ接続
// =====================

svg.addEventListener("pointerdown",(e)=>{
    const t = e.target;
    if(t.dataset && t.dataset.terminal){
        dragStart=t.dataset.terminal;
        const p=getPos(dragStart);

        tempLine=document.createElementNS("http://www.w3.org/2000/svg","line");
        tempLine.setAttribute("x1",p.x);
        tempLine.setAttribute("y1",p.y);
        tempLine.setAttribute("x2",p.x);
        tempLine.setAttribute("y2",p.y);
        tempLine.setAttribute("stroke","#999");
        tempLine.setAttribute("stroke-width","3");
        svg.appendChild(tempLine);
    }
});

svg.addEventListener("pointermove",(e)=>{
    if(tempLine){
        const pt=svg.createSVGPoint();
        pt.x=e.clientX;
        pt.y=e.clientY;
        const svgP=pt.matrixTransform(svg.getScreenCTM().inverse());
        tempLine.setAttribute("x2",svgP.x);
        tempLine.setAttribute("y2",svgP.y);
    }
});

svg.addEventListener("pointerup",(e)=>{
    if(!tempLine) return;
    tempLine.remove();
    tempLine=null;

    const elements=document.elementsFromPoint(e.clientX,e.clientY);
    const circle=elements.find(el=>el.dataset&&el.dataset.terminal);

    if(circle && dragStart){
        createConnection(dragStart,circle.dataset.terminal);
    }
    dragStart=null;
});

// =====================
// Graph判定
// =====================

class Graph{
    constructor(){this.adj={};}
    add(a,b){
        if(!this.adj[a])this.adj[a]=[];
        if(!this.adj[b])this.adj[b]=[];
        this.adj[a].push(b);
        this.adj[b].push(a);
    }
    dfs(s,visited=new Set()){
        visited.add(s);
        (this.adj[s]||[]).forEach(n=>{
            if(!visited.has(n))this.dfs(n,visited);
        });
        return visited;
    }
    connected(a,b){
        if(!this.adj[a])return false;
        return this.dfs(a).has(b);
    }
}

function updateLamp(){

    const g=new Graph();

    userConnections.forEach(e=>g.add(e.a,e.b));

    if(switchState["S1"]===0) g.add("S1-COM","S1-T1");
    else g.add("S1-COM","S1-T2");

    if(switchState["S2"]===0) g.add("S2-COM","S2-T1");
    else g.add("S2-COM","S2-T2");

    const on=g.connected("L","Lamp-L") && g.connected("Lamp-N","N");

    if(on) lampEl.classList.add("on");
    else lampEl.classList.remove("on");

    userConnections.forEach(e=>{
        if(g.connected("L",e.a)&&g.connected("L",e.b)){
            e.line.classList.add("powered");
        }else{
            e.line.classList.remove("powered");
        }
    });
}

// =====================
// 採点
// =====================

function checkAnswer(){
    const g=new Graph();
    userConnections.forEach(e=>g.add(e.a,e.b));
    if(g.connected("L","N")){
        document.getElementById("result").textContent="重大欠陥: 短絡";
        return;
    }
    document.getElementById("result").textContent="採点完了";
}

loadProblem();

</script>
</body>
</html>
