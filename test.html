<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>電工二種 技能試験シミュレーター</title>

<style>
body{font-family:sans-serif;background:#f4f6f8;margin:0;padding:20px;}
.panel{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;}
#circuit{width:100%;height:420px;border:1px solid #ccc;background:#fafafa;}
.lamp{width:36px;height:36px;border-radius:50%;background:#ccc;display:inline-block;}
.lamp.on{background:red;box-shadow:0 0 15px red;}
.selected{stroke:#4da3ff !important;stroke-width:3;}
.powered{stroke:#ff0000 !important;stroke-dasharray:8 6;animation:flow 0.6s linear infinite;}
@keyframes flow{from{stroke-dashoffset:0}to{stroke-dashoffset:-30}}
</style>
</head>
<body>

<div class="panel">
配線色:
<select id="wireColorSelect">
<option value="black">黒</option>
<option value="white">白</option>
<option value="red">赤</option>
</select>

<button onclick="resetConnections()">リセット</button>
<button onclick="checkAnswer()">採点</button>
</div>

<div class="panel">
<svg id="circuit" viewBox="0 0 1000 420"></svg>
<div style="margin-top:10px;">
ランプ: <span id="lamp" class="lamp"></span>
<span id="result"></span>
</div>
</div>

<script>

const svg = document.getElementById("circuit");
const lampEl = document.getElementById("lamp");

let userConnections = [];
let selectedTerminal = null;
let switchState = {S1:0,S2:0};

function clearSVG(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);
}

function drawDevice(x,y,w,h,title){
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x",x);
    rect.setAttribute("y",y);
    rect.setAttribute("width",w);
    rect.setAttribute("height",h);
    rect.setAttribute("fill","#e9edf2");
    rect.setAttribute("stroke","#aaa");
    svg.appendChild(rect);

    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x",x+10);
    text.setAttribute("y",y-5);
    text.setAttribute("font-size","12");
    text.textContent = title;
    svg.appendChild(text);
}

function drawTerminal(id,x,y,label){
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",x);
    c.setAttribute("cy",y);
    c.setAttribute("r",10);
    c.setAttribute("fill","#fff");
    c.setAttribute("stroke","#333");
    c.setAttribute("data-terminal",id);
    c.style.cursor="pointer";
    svg.appendChild(c);

    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",x-15);
    t.setAttribute("y",y-15);
    t.setAttribute("font-size","10");
    t.textContent=label;
    svg.appendChild(t);

    c.addEventListener("click",()=>handleTerminalClick(id,c));
}

function renderBoard(){

    clearSVG();

    // 電源
    drawDevice(60,170,120,80,"電源");
    drawTerminal("L",90,210,"L");
    drawTerminal("N",130,210,"N");

    // 三路1（本番配置）
    drawDevice(250,150,180,120,"三路スイッチ1");
    drawTerminal("S1-COM",270,210,"0");
    drawTerminal("S1-T1",390,170,"1");
    drawTerminal("S1-T2",390,250,"3");

    // BOX
    drawDevice(460,180,140,80,"BOX");
    drawTerminal("BOX1",490,220,"B1");
    drawTerminal("BOX2",530,220,"B2");
    drawTerminal("BOX3",570,220,"B3");

    // 三路2
    drawDevice(640,150,180,120,"三路スイッチ2");
    drawTerminal("S2-COM",660,210,"0");
    drawTerminal("S2-T1",780,170,"1");
    drawTerminal("S2-T2",780,250,"3");

    // ランプ
    drawDevice(860,170,120,80,"引掛シーリング");
    drawTerminal("Lamp-L",890,210,"L");
    drawTerminal("Lamp-N",930,210,"N");
}

function getPos(id){
    const el = svg.querySelector(`[data-terminal='${id}']`);
    return {
        x:parseFloat(el.getAttribute("cx")),
        y:parseFloat(el.getAttribute("cy"))
    };
}

function drawWire(a,b,color){
    const p1=getPos(a);
    const p2=getPos(b);
    const midX=(p1.x+p2.x)/2;

    const poly=document.createElementNS("http://www.w3.org/2000/svg","polyline");
    poly.setAttribute("points",
        `${p1.x},${p1.y} ${midX},${p1.y} ${midX},${p2.y} ${p2.x},${p2.y}`
    );
    poly.setAttribute("fill","none");
    poly.setAttribute("stroke",color);
    poly.setAttribute("stroke-width","4");
    poly.setAttribute("stroke-linecap","round");

    poly.addEventListener("click",()=>{
        poly.remove();
        userConnections=userConnections.filter(c=>c.line!==poly);
        updateLamp();
    });

    svg.appendChild(poly);
    return poly;
}

function handleTerminalClick(id,element){

    if(!selectedTerminal){
        selectedTerminal=id;
        element.classList.add("selected");
        return;
    }

    if(selectedTerminal===id){
        selectedTerminal=null;
        element.classList.remove("selected");
        return;
    }

    if(userConnections.some(e=>e.a===id||e.b===id)) return;
    if(userConnections.some(e=>e.a===selectedTerminal||e.b===selectedTerminal)) return;

    const sel=document.getElementById("wireColorSelect").value;
    const colorMap={black:"#000",white:"#fff",red:"#cc0000"};
    const line=drawWire(selectedTerminal,id,colorMap[sel]);

    userConnections.push({a:selectedTerminal,b:id,line:line});

    document.querySelectorAll("circle").forEach(c=>c.classList.remove("selected"));
    selectedTerminal=null;

    updateLamp();
}

class Graph{
    constructor(){this.adj={};}
    add(a,b){
        if(!this.adj[a])this.adj[a]=[];
        if(!this.adj[b])this.adj[b]=[];
        this.adj[a].push(b);
        this.adj[b].push(a);
    }
    dfs(s,visited=new Set()){
        visited.add(s);
        (this.adj[s]||[]).forEach(n=>{
            if(!visited.has(n))this.dfs(n,visited);
        });
        return visited;
    }
    connected(a,b){
        if(!this.adj[a])return false;
        return this.dfs(a).has(b);
    }
}

function updateLamp(){

    const g=new Graph();
    userConnections.forEach(e=>g.add(e.a,e.b));

    if(switchState.S1===0) g.add("S1-COM","S1-T1");
    else g.add("S1-COM","S1-T2");

    if(switchState.S2===0) g.add("S2-COM","S2-T1");
    else g.add("S2-COM","S2-T2");

    const on=g.connected("L","Lamp-L")&&g.connected("Lamp-N","N");

    if(on) lampEl.classList.add("on");
    else lampEl.classList.remove("on");

    userConnections.forEach(e=>{
        if(g.connected("L",e.a)&&g.connected("L",e.b)){
            e.line.classList.add("powered");
        }else{
            e.line.classList.remove("powered");
        }
    });
}

function resetConnections(){
    userConnections.forEach(e=>e.line.remove());
    userConnections=[];
    updateLamp();
}

function checkAnswer(){
    const g=new Graph();
    userConnections.forEach(e=>g.add(e.a,e.b));
    if(g.connected("L","N")){
        document.getElementById("result").textContent="重大欠陥: 短絡";
        return;
    }
    document.getElementById("result").textContent="採点完了";
}

renderBoard();

</script>
</body>
</html>
